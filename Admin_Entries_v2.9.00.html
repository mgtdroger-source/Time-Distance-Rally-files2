<!DOCTYPE html><html lang="en"><head><title>Admin Entries v2.9.00</title><meta charset="utf-8"/><script>
/* v2.9.00: Setup guide opens as Shell card (TD_NAV setup) with doc fallback; Code.gs still opens as doc */
/* v2.8.97: minimal admin.google stamps (lastUploadAt/lastDownloadAt) only; reset base = v2.8.96 */
/* v2.8.96: add Normal/Compact view toggle (after r000 pill) */
/* v2.8.93: persist rebuild admin.controls.days[].entries (sgIdx+speed) */
/* v2.8.92: global helper (Increment Min) */
window.clampIncMin = window.clampIncMin || function(v){
  let n = Number(v);
  if (!Number.isFinite(n)) n = 1.0;
  // keep existing bounds used by the UI control
  n = Math.max(0, Math.min(9.5, n));
  // snap to 0.5 minutes (matches spinner intent)
  n = Math.round(n * 2) / 2;
  return n;
};
</script>
<!--
  UI INVENTORY (Pass 1) — controls present in this build
  Top selectors: #daysCtrl/#daysDisplay/#daysMenu, #sgCtrl/#sgDisplay/#sgMenu
  Actions bar buttons: #addRowBtn, #sortBtn, #saveBtn, #loadBtn, #printBtn, #entriesBtn, #toolsBtn
  Tools menu items: [data-action=set-workspace], [data-action=save-as], [data-action=load], [data-action=new-rally]
  Modals/cards: #newRallyModal (OK/Cancel), #adminEntriesCardRoot overlay, Year popup picker (#yearCellMenu)
  Table UX: row gear context menu (#rowCtxMenu), SG cell menu (#sgCellMenu)
  Status: UI complete; storage/workspace/print/google wiring still stubbed/not yet implemented.
-->
<script id="uiGlobalHelpers">
/* v2.5.18 — global DOM helpers (UI-support). */
(function(){
  if (!window.$) window.$ = function(sel, root){
    const r = root||document;
    if (typeof sel === 'string') {
      const s = sel.trim();
      // Back-compat: allow passing bare element ids (e.g. 'saveTestBtn')
      // without requiring '#saveTestBtn'.
      if (s && !s.startsWith('#') && !s.startsWith('.') && !s.startsWith('[') && !s.includes(' ') && !s.includes('>') && !s.includes(':')) {
        const byId = r.getElementById ? r.getElementById(s) : document.getElementById(s);
        if (byId) return byId;
      }
    }
    return r.querySelector(sel);
  };
  if (!window.$$) window.$$ = function(sel, root){ return Array.from((root||document).querySelectorAll(sel)); };
})();
</script>

<meta content="width=device-width, initial-scale=1" name="viewport"/>
<style>.day-card:not(.speed-card).day-grid .day-field:first-of-type{display:grid;grid-template-columns:72px auto;gap:4px}.day-card:not(.speed-card).day-grid .day-field:first-of-type .input-wrap .date{width:140px;padding-left:12px;padding-right:8px;box-sizing:border-box}.day-card:not(.speed-card).day-field:has(input[type="date"]){display:grid;grid-template-columns:72px minmax(0,1fr);gap:4px}.day-card:not(.speed-card).input-wrap .date{padding-left:12px;padding-right:8px;box-sizing:border-box}.day-card:not(.speed-card).day-field{display:grid;grid-template-columns:64px auto;column-gap:8px}.day-card:not(.speed-card).input-wrap{width:auto;min-width:100%}.day-card:not(.speed-card).input-wrap .date,.day-field .input-wrap .date{width:100%}#toolsMenu .item.disabled{opacity:0.45;color:#555;font-weight:500;cursor:default}#toolsMenu .item:not(.disabled){color:#000;font-weight:600}#toolsMenu .item{font-weight:600}:root{--bg:#ffffff;--panel:#ffffff;--panel-soft:#f7f7f9;--border:#d3d7df;--border-w:1px;--header-bottom-w:2px;--text:#111827;--accent:#2563eb;--accent-weak:#e0e7ff;--green:#16a34a;--gap-panels:20px;--top-gap:12px;--sticky-top:76px;--sg1:#ffffff;--sg2:#FFF8CC;--sg3:#EAF2FF;--sg4:#EAF9EE;--header-gap-bottom:0px;--border-strong:#c5cad3}*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans","Helvetica Neue",sans-serif}.container{padding:16px}.panel{border:var(--border-w)solid var(--border);border-radius:12px;background:var(--panel);padding:12px}.panel+.panel{margin-top:var(--gap-panels)}#scheduleGrid{display:grid;grid-template-columns:260px 1fr;gap:12px 24px;align-items:start}.left-col{display:grid;gap:10px}.form-row{display:grid;grid-template-columns:120px 1fr;align-items:center;gap:10px}.form-row .label{font-weight:600;color:#374151}.subtitle{text-align:left;font-weight:800;color:#374151;margin-top:4px}.input,select{height:36px;padding:0 10px;border:var(--border-w)solid var(--border);border-radius:10px;background:#fff;min-width:60px;width:180px}#daysStrip{max-width:min(100%,1800px);overflow-x:auto;padding-bottom:4px}#daysStripInner{display:grid;grid-auto-flow:column;grid-auto-columns:240px;gap:12px;width:max-content}#daysStrip[data-days="4"]{max-width:100%;overflow-x:hidden}#daysStripInner[data-days="4"]{grid-auto-flow:initial;grid-auto-columns:initial;grid-template-columns:repeat(5,minmax(0,1fr));width:100%}#daysStrip[data-days="4"] .day-col{width:auto;min-width:0}.day-col{width:240px;min-width:240px;background:var(--panel-soft);border:var(--border-w)solid var(--border);border-radius:12px;padding:10px}.day-title{text-align:center;font-weight:800;margin-bottom:8px}.day-grid{display:grid;gap:10px}.day-col[data-kind="speed-limits"] .day-grid{padding-top:10px}.day-field{display:grid;grid-template-columns:88px minmax(0,1fr);align-items:center;gap:8px}#daysStripInner .day-col:first-child .day-field .label{white-space:nowrap}.day-field.inc{grid-template-columns:96px minmax(0,1fr)}.day-field .input-wrap{position:relative}.day-field .input-wrap input{width:100%}#daysStripInner input[type="time"]{position:relative;padding-right:36px;text-align:center}#daysStripInner input[type="time"]::-webkit-calendar-picker-indicator{position:absolute;right:8px}#daysStripInner input[type="time"]{appearance:auto;-webkit-appearance:auto;padding-right:28px}.day-field .ico{position:absolute;right:6px;top:50%;transform:translateY(-50%);width:18px;height:18px;opacity:.7}.day-field.inc .input-wrap input{max-width:110px}#daysStripInner input.inc{width:70px;justify-self:end;text-align:center}.day-field input{height:36px;padding:0 10px;border:var(--border-w)solid var(--border);border-radius:10px;width:100%}.day-field input.time{text-align:center}.day-field input.inc{text-align:right}.sg-ctrl{position:relative;width:90px}.sg-display{height:36px;border:var(--border-w)solid var(--border);border-radius:10px;padding:0 10px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;background:#fff}.sg-display.sg2{background:var(--sg2)}.sg-display.sg3{background:var(--sg3)}.sg-display.sg4{background:var(--sg4)}.dd-display,.sg-display{position:relative;justify-content:center}#daysDisplayText,#sgDisplayText{display:block;width:100%;text-align:center}#daysDisplay>span:last-child,#sgDisplay>span:last-child{position:absolute;right:10px}.sg-menu{position:absolute;top:40px;left:0;width:100%;border:var(--border-w)solid var(--border);border-radius:10px;background:#fff;box-shadow:0 10px 30px rgba(0,0,0,.12);padding:4px;display:none;z-index:5000}.sg-menu.open{display:block}.sg-item{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:8px;cursor:pointer;background:#fff}.sg-item:hover{background:#f3f4f6}.swatch{width:14px;height:14px;border-radius:4px;border:var(--border-w)solid var(--border)}#actionsPanel{background:#fff;border:var(--border-w)solid var(--border);border-radius:12px;box-shadow:0 8px 18px rgba(0,0,0,.06);padding:10px 12px}.bar{display:flex;align-items:center;gap:10px;flex-wrap:wrap}#actionsPanel .actions-bar{display:grid;grid-template-columns:max-content 1fr max-content 1fr max-content;align-items:center;column-gap:10px;row-gap:8px}#actionsPanel .actions-left{justify-self:start;display:flex;align-items:center;gap:10px;flex-wrap:wrap}#actionsPanel .actions-center{justify-self:center;display:flex;align-items:center;gap:10px;flex-wrap:wrap}#actionsPanel .actions-right{justify-self:end;display:flex;align-items:center;gap:10px;flex-wrap:wrap}#actionsPanel .actions-spacer{min-width:0}#actionsPanel .actions-right-reserve{display:flex;align-items:center;gap:10px;flex-wrap:wrap}#actionsPanel .start-delays-wrap{display:flex;align-items:center;gap:8px;padding:6px 8px;border:1px solid var(--border);border-radius:10px;background:rgba(255,255,255,.65)}#actionsPanel .start-delays-text{font-size:11px;line-height:1.05;font-weight:700;color:#111827}#actionsPanel .start-delays-text div:last-child{margin-top:2px}#actionsPanel #includeStartDelaysChk{width:18px;height:18px}@media(max-width:860px){#actionsPanel .actions-bar{display:flex;flex-wrap:wrap}#actionsPanel .actions-spacer{display:none}#actionsPanel .actions-left{width:auto}#actionsPanel .actions-center{width:auto}#actionsPanel .actions-right{margin-left:auto}}.btn{appearance:none;border:1px solid transparent;padding:8px 14px;border-radius:9px;cursor:pointer;font-weight:700;color:#fff}.btn--green{background:#16a34a}.btn--green:hover{background:#15803d}.btn--grey{background:#6b7280}.btn--grey:hover{background:#4b5563}.btn--blue{background:#2563eb}.btn--blue:hover{background:#1d4ed8}.btn--view{background:#fff;border-color:var(--border);color:var(--text);width:74px;height:34px;padding:0;line-height:34px;border-radius:9px;font-weight:700;display:inline-flex;align-items:center;justify-content:center;}
.btn--view:hover{border-color:#9aa4b2;}
.btn--view[aria-pressed="true"]{background:#e5e7eb;border-color:#9aa4b2;}
body.td-compact .container{zoom:0.92;}
@media print{body.td-compact .container{zoom:1;}}
.sep{width:1px;height:26px;background:var(--border);margin:0 8px}#entriesOverlaySlab{position:sticky;top:0;z-index:200;background:var(--panel-soft)}#entriesOverlaySpacer{height:12px}#entriesOverlayScroller{height:18px;overflow-x:scroll;overflow-y:hidden;margin-top:-4px}#entriesOverlayScrollerInner{height:100%}#entriesOverlayScrollerSpacer{height:6px;background:#f3f4f6}#entriesOverlayScroller{scrollbar-color:#6b7280 #ffffff;scrollbar-width:thin}#entriesOverlayScroller::-webkit-scrollbar{height:10px}#entriesOverlayScroller::-webkit-scrollbar-track{background:#ffffff}#entriesOverlayScroller::-webkit-scrollbar-thumb{background:#6b7280;border-radius:999px;border:3px solid #ffffff}#entriesOverlayHeader{overflow:hidden}#entriesOverlayHeaderInner{position:relative;display:inline-block;border-top:1px solid var(--border)}#entriesOverlayHeader .oh-row{display:flex;border-bottom:1px solid var(--border)}#entriesOverlayHeader .oh-row:last-child .oh-cell{border-bottom:1px solid var(--border)}#entriesOverlayHeader .oh-cell{box-sizing:border-box;padding:6px 8px;border-left:1px solid var(--border);background:#fff;white-space:nowrap;font-weight:600;text-align:center}#entriesOverlayHeader .oh-cell:last-child{border-right:1px solid var(--border)}#entriesOverlayHeader{box-sizing:border-box;border:1px solid var(--border);border-radius:12px 12px 0 0;overflow:hidden;background:#f2f2f2;box-shadow:none;outline:none}#entriesOverlayHeaderInner{border-top:0}@media screen{.hide-thead thead{display:none}}.table-panel{padding:0;border:var(--border-w)solid var(--border);border-radius:12px}.table-panel .table-wrap{margin:0}.table-wrap{position:relative;overflow-x:auto;overflow-y:visible}table{border-collapse:collapse;width:max-content;min-width:100%}th,td{border:var(--border-w)solid var(--border);padding:6px 8px;vertical-align:middle;background:#fff}thead th{text-align:center;font-weight:700}thead tr:nth-child(2)th{font-weight:600}tbody tr:nth-child(even)td{background:#fbfcfe}#grid,#grid th,#grid td,#grid input,#grid select{font-size:13px !important;line-height:1.2 !important}#grid tbody tr{height:38px !important}#grid th,#grid td{height:38px !important;padding:0 8px !important;vertical-align:middle !important}#grid td input,#grid td select{height:30px !important;padding:0 8px !important;line-height:30px !important}#grid .readonly{height:30px !important;padding:0 8px !important;display:flex !important;align-items:center !important;justify-content:center !important;line-height:1.2 !important}td input[type="text"],td input[type="email"],td input[type="number"]{width:100%;border:none;border-radius:0;padding:6px 8px;background:transparent;outline:none}td input[type="number"]{text-align:center}.readonly{display:block;text-align:center;padding:6px 8px}.readonly.time{color:#2563eb;font-weight:600}.rallyNo{color:#2563eb;font-weight:700}td.gutter{padding:0;text-align:center}col.c0{width:64px}col.c1{width:110px}col.c2{width:140px}col.c3{width:110px}col.c4{width:140px}col.c5{width:140px}col.c6{width:200px}col.c7{width:130px}col.c8{width:80px}col.c9{width:60px}col.c10{width:60px}col.c11{width:100px}td.gutter{position:relative;padding-right:26px;text-align:center}td.gutter .row-index{display:block;text-align:center}td.gutter .gear{position:absolute;right:4px;top:50%;transform:translateY(-50%)}.sg-item[data-val="1"],.sg-item[data-val="2"],.sg-item[data-val="3"],.sg-item[data-val="4"]{background:#fff !important}.sg-item:hover{background:#f3f4f6}.dd-ctrl{position:relative;width:90px}.dd-ctrl.menu-open{z-index:6000}.sg-ctrl.menu-open{z-index:6000}.dd-display{height:36px;border:var(--border-w)solid var(--border);border-radius:10px;padding:0 10px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;background:#fff}.dd-menu{position:absolute;top:40px;left:0;width:100%;border:var(--border-w)solid var(--border);border-radius:10px;background:#fff;box-shadow:0 10px 30px rgba(0,0,0,.12);padding:4px;display:none;z-index:5000}.dd-menu.open{display:block}.dd-item{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:8px;cursor:pointer;background:#fff}.dd-item:hover{background:#f3f4f6}#schedulePanel .dd-menu .dd-item{background:#fff !important}.sg-limit{width:60px!important;padding:0!important;text-align:center!important;line-height:30px!important;height:30px!important}.sg-display.sg2,.sg-display.sg3,.sg-display.sg4{background:#fff !important}.sg-limit.sg2{background:var(--sg2)!important}.sg-limit.sg3{background:var(--sg3)!important}.sg-limit.sg4{background:var(--sg4)!important}td.sg-cell select option.sg2{background:var(--sg2);color:#111}td.sg-cell select option.sg3{background:var(--sg3);color:#111}td.sg-cell select option.sg4{background:var(--sg4);color:#111}td.sg-cell select.single{background-image:none !important;pointer-events:none}.index-cell .index-cell .row-num{display:none !important}.gear{width:22px;height:22px;line-height:22px;border:0;border-radius:4px;background:transparent;color:#555;cursor:pointer;font-size:18px;font-weight:700;padding:0;opacity:.9;font-family:"Segoe UI Symbol","Segoe UI",system-ui,Arial,sans-serif}.gear:hover,.gear:focus{color:#111;opacity:1;background:#f3f3f3}td.sg-cell{position:relative;cursor:pointer}td.sg-cell::before{content:'' !important}td.sg-cell::after{content:attr(data-display)!important;position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#2563eb;pointer-events:none}td.sg-cell select{opacity:0;pointer-events:none;width:100% !important;min-width:0 !important}#sgCellMenu{min-width:120px;max-width:120px;box-sizing:border-box}#sgCellMenu .sg-item{display:flex;align-items:center;justify-content:center;gap:8px;padding:8px 12px;margin:1px 0}#sgCellMenu .sg-item .swatch{flex:0 0 14px;height:14px}#sgCellMenu .sg-item .sg-speed{flex:0 0 auto}#schedulePanel{position:relative;z-index:360}#actionsPanel{position:relative;z-index:300}#actionsPanel{position:sticky;top:var(--top-gap);z-index:350}#grid col.c9,#grid col.c10{width:60px !important}#grid td.sg-cell,#grid tbody tr td:nth-child(11){width:60px !important;max-width:60px !important}#grid .sg-limit{width:60px !important}#rowMenu{position:fixed;z-index:9999;background:#fff;border:1px solid #d1d5db;border-radius:8px;box-shadow:0 10px 20px rgba(0,0,0,.08),0 2px 6px rgba(0,0,0,.06);padding:6px;min-width:180px;font-size:14px}#rowMenu .rm-item{display:block;width:100%;text-align:left;padding:8px 10px;border:0;background:transparent;cursor:pointer}#rowMenu .rm-item:hover{background:#f3f4f6}#rowMenu .rm-danger{color:#b91c1c}#rowMenu .rm-sep{border:none;border-top:1px solid #e5e7eb;margin:6px 0}.ctx-menu{position:fixed;z-index:9999;display:none;background:#fff;border:1px solid #d1d5db;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.12),0 2px 8px rgba(0,0,0,.06);min-width:220px;padding:8px}.ctx-menu button{display:block;width:100%;text-align:left;background:#fff;border:0;padding:10px 12px;border-radius:8px;cursor:pointer}.ctx-menu button:hover{background:#f3f4f6}.ctx-menu .ctx-sep{height:1px;margin:6px 6px;background:#e5e7eb}.ctx-menu button.danger{color:#b91c1c}.ctx-menu button.danger:hover{background:#fee2e2}.ctx-menu .ctx-sep{height:0;border-top:1px solid #e5e7eb;margin:8px 0}.ctx-menu button{font-weight:400}.ctx-menu .ctx-sep{height:0;border-top:1px solid #e5e7eb;margin:8px 0}.ctx-menu button{font-weight:400 !important}.ctx-menu button.danger{color:#b91c1c}.ctx-menu button.danger:hover{background:#fee2e2}:root{--grid-base-font:sans-serif;--grid-base-size:14px;--grid-base-lh:1.2}body{font-family:var(--grid-base-font);font-size:var(--grid-base-size);line-height:var(--grid-base-lh)}table,th,td{font:inherit;line-height:var(--grid-base-lh);font-size:var(--grid-base-size)}button,input,select,textarea,.dd-display,.ctx-menu button{font:inherit}.ctx-menu button{font-weight:700 !important;color:#111 !important}.ctx-menu button:hover{background:#f5f5f5}.ctx-menu .ctx-sep{height:0;border-top:1px solid #e5e7eb;margin:8px 0}.ctx-menu button.danger{color:inherit !important}.ctx-menu button.danger:hover{background:#f5f5f5}#schedulePanel .subtitle{margin-top:40px}#toolsMenu{position:absolute;top:50px;right:12px;background:#fff;border:1px solid rgba(15,23,42,.08);border-radius:12px;box-shadow:0 14px 28px rgba(15,23,42,.12);min-width:180px;display:none;z-index:4000}#toolsMenu .item{padding:8px 14px;cursor:pointer;font-weight:500;color:#111827}#toolsMenu .item:hover{background:rgba(37,99,235,.05)}#toolsMenu .item.disabled{color:rgba(15,23,42,.35);cursor:default;background:transparent}.rally-pill{background:#fff;border:1px solid var(--border);border-radius:14px;padding:8px 16px;min-height:40px;display:flex;align-items:center;font-weight:600;color:#1f2937}.rally-pill.title{flex:0 0 250px;width:250px;max-width:250px;min-width:250px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}.rally-pill.rev{flex:0 0 auto;min-width:56px;justify-content:center}#toastBar{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 18px;border-radius:999px;box-shadow:0 15px 30px rgba(15,23,42,.25);font-weight:500;opacity:0;pointer-events:none;transition:opacity .25s ease-out;z-index:9999}#toastBar.show{opacity:1}.rally-pill.muted{color:rgba(15,23,42,.45)}#rallyTitlePill.filled{color:#000;font-size:14px;font-weight:600}#rallyTitlePill[contenteditable="true"]{cursor:text;user-select:text}#rallyTitlePill[contenteditable="true"]:focus{outline:none}#saveAsModal{position:fixed;inset:0;background:rgba(15,23,42,0.25);display:none;align-items:center;justify-content:center;z-index:12000}#saveAsModal .modal-card{background:#fff;border-radius:18px;padding:20px 24px;min-width:360px;box-shadow:0 12px 40px rgba(15,23,42,.25)}#saveAsModal h2{margin:0 0 6px 0;font-size:1.05rem}#saveAsModal p{margin:0 0 12px 0;color:#374151}#saveAsInput{width:100%;border:1px solid #d1d5db;border-radius:10px;padding:8px 10px}#saveAsModal .actions{display:flex;justify-content:flex-end;gap:8px;margin-top:16px}#rowCtxMenu button.danger{color:#b91c1c !important;font-weight:700 !important}#rowCtxMenu button.danger:hover{background:#fee2e2 !important}table{table-layout:fixed}thead th,tbody td{white-space:nowrap}.day-col{background:#ededed !important}#schedulePanel{background:#f5f5f7 !important}#actionsPanel{background:#f2f2f2 !important}#entriesOverlayHeader .oh-cell,#entriesOverlayHeaderInner .oh-cell{background:#f2f2f2 !important}
/* v2.8.34 — Entries gate */
#entriesBtn:disabled, #entriesBtn.disabled{opacity:0.55;cursor:not-allowed}
</style>
<style>#rowCtxMenu button.danger{color:#d00 !important;font-weight:600}html,body{background:#f3f4f6 !important}#schedulePanel{background:#e9edf3 !important}#actionsPanel{background:#e9edf3 !important}#grid thead tr.row1 th,#grid thead tr.row2 th{background:#e5e7eb !important}.day-col{background:#e5e7eb !important}.rally-pill.title.pristine{box-shadow:0 0 0 2px rgba(255,140,0,0.95)}#entriesOverlayHeader .oh-cell{background:#e5e7eb !important}#entriesOverlayHeaderInner{background:#e5e7eb !important}.dd-menu,.sg-menu{background:#fff;opacity:1;backdrop-filter:none}#saveAsModal .btnrow{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}#saveAsModal .adbtn{min-width:64px;border-radius:10px;padding:6px 14px;line-height:1.1}#saveAsModal .adbtn.ghost{background:#fff;border:1px solid #cbd5e1;color:#111827}#saveAsModal .adbtn:not(.ghost){background:#111827;color:#fff;border:1px solid #111827}#saveAsModal .adbtn:hover{filter:brightness(0.97)}.print-root{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif}.print-wrapper{display:none}.print-page{width:257mm;margin:0 auto;padding-top:8mm}.print-header{margin-bottom:3mm}.print-header-line{border-top:1px solid #000;margin-bottom:3mm}.print-table{border-collapse:collapse;width:100%}.print-table th,.print-table td{border:0.25pt solid #000;padding:0 12px;height:7mm;line-height:1.3;font-weight:400}.print-table th{font-weight:600;text-align:left}.print-table .num,.print-table .year-col,.print-table .sg-col,.print-table .start-col{text-align:center;padding-left:0;padding-right:0}.print-footer{margin-top:4mm;font-size:11px;text-align:right}.print-table.day-print col.col-idx{width:15mm}.print-table.day-print col.col-driver,.print-table.day-print col.col-nav,.print-table.day-print col.col-make{width:52mm}.print-table.day-print col.col-year{width:20mm}.print-table.day-print col.col-sg{width:20mm}.print-table.day-print col.col-rally{width:15mm}.print-table.day-print col.col-start{width:30mm}.print-table.admin-print col.col-idx{width:12mm}.print-table.admin-print col.col-driver,.print-table.admin-print col.col-nav,.print-table.admin-print col.col-make{width:36mm}.print-table.admin-print col.col-mobile{width:32mm}.print-table.admin-print col.col-email{width:51mm}.print-table.admin-print col.col-year{width:12mm}.print-table.admin-print col.col-sg{width:12mm}.print-table.admin-print col.col-rally{width:12mm}.print-page.day-page .print-header{font-size:14px;font-weight:600}.print-page.day-page .print-table th,.print-page.day-page .print-table td{font-size:13px}.print-page.admin-page .print-header{font-size:13px;font-weight:600}.print-page.admin-page .print-table th,.print-page.admin-page .print-table td{font-size:12px}@media print{body[data-print-mode^="day"],body[data-print-mode="admin"]{background:#ffffff}body[data-print-mode^="day"] .container,body[data-print-mode="admin"] .container{display:none !important}.print-wrapper{display:none}body[data-print-mode^="day"] #dayPrintWrapper{display:block}body[data-print-mode="admin"] #adminPrintWrapper{display:block}}.day-col{background:#ededed !important}#schedulePanel{background:#f5f5f7 !important}#actionsPanel{background:#f2f2f2 !important}#entriesOverlayHeader .oh-cell,#entriesOverlayHeaderInner .oh-cell{background:#f2f2f2 !important}</style>
<style id="entryLabelCSS">#entriesOverlayHeader .oh-row:last-child .oh-cell:first-child::after{content:"Entry";display:inline-block;width:100%;text-align:center;white-space:nowrap}thead tr.row2 th.gutter:empty::after{content:"Entry";display:inline-block;width:100%;text-align:center;white-space:nowrap}</style>
<style id="adminEntriesCardScopedStyles">:root{--gap:10px;--radius:12px;--line:#e5e7eb;--ink:#111827;--muted:#6b7280}#adminEntriesCardRoot .spacer{flex:1}.adcard .adbtn,#adminEntriesCardRoot #adminBtn.adbtn{appearance:none;border:0;border-radius:999px;padding:10px 14px;font-weight:600;background:#2563eb;color:#fff;cursor:pointer}.adcard .adbtn.whatsapp{background:#16a34a}.adcard .adbtn.secondary{background:#374151}.adcard .adbtn.busy{opacity:0.7;cursor:default}.adcard .adbtn.busy .dots5{display:inline-flex}.adcard .dots5{display:none;align-items:center;gap:4px;margin-left:8px;vertical-align:middle}.adcard .dots5 i{display:block;width:6px;height:6px;border-radius:50%;background:currentColor;opacity:.35;animation:dots5 1s infinite ease-in-out}.adcard .dots5 i:nth-child(1){animation-delay:0ms}.adcard .dots5 i:nth-child(2){animation-delay:120ms}.adcard .dots5 i:nth-child(3){animation-delay:240ms}.adcard .dots5 i:nth-child(4){animation-delay:360ms}.adcard .dots5 i:nth-child(5){animation-delay:480ms}@keyframes dots5{0%,100%{opacity:.25;transform:translateY(0)}50%{opacity:1;transform:translateY(-2px)}}.adcard .adbtn.ghost{background:#e5e7eb;color:#111827;border:1px solid #9ca3af}.adcard .adbtn:disabled{opacity:0.9;cursor:default}.adcard .chip{background:#f3f4f6;border-radius:999px;padding:4px 8px;color:#374151;font-weight:600}#adminEntriesCardRoot .adcard.modal-overlay{position:fixed;inset:0;background:rgba(15,23,42,.45);display:none;align-items:flex-start;justify-content:center;padding:40px 16px;z-index:20}#adminEntriesCardRoot .adcard.modal-overlay.open{display:flex}.adcard #entriesPanel{position:relative;background:#fff;border-radius:16px;max-width:720px;width:100%;max-height:90vh;overflow:auto;padding:20px 24px;box-shadow:0 20px 45px rgba(15,23,42,.35)}.adcard .modal-header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px}.adcard .modal-header h2{margin:0;font-size:18px}.adcard .adsections{display:flex;flex-direction:column;gap:6px;margin-top:8px}.adcard .adsection{border:1px solid var(--line);border-radius:var(--radius);padding:12px 14px;background:#f9fafb}.adcard .adsection.compact{padding:8px 12px;margin-top:6px}.adcard .adsection h3{margin:0 0 4px;font-size:15px}.adcard .adsection p{margin:0 0 6px}.adcard .adsection-actions{display:flex;flex-wrap:wrap;gap:8px}.adcard .adbadge{display:inline-flex;align-items:center;font-size:12px;border-radius:999px;padding:2px 8px;background:#e5e7eb;color:#374151}.adcard .adbadge.ok{background:#dcfce7;color:#166534}.adcard .adbadge.warn{background:#fee2e2;color:#b91c1c}.adcard .adbtn.adsmall{padding:7px 10px;font-size:12px}.adcard .adbtn.micro{padding:5px 9px;font-size:10px}.adcard .adbtn.off{background:#9ca3af;color:#f9fafb}.adcard .adcard .adbtn.off:hover{background:#9ca3af}#adminEntriesCardRoot .adcard .adbtn.whatsapp.off{background:#9ca3af;color:#f9fafb}.adcard .adbtn.whatsapp.off:hover{background:#9ca3af}#adminEntriesCardRoot #webAppUrl.nudge{box-shadow:0 0 0 2px #fca5a5}.adcard .adrow{display:flex;gap:8px;margin:10px 0}.adcard .adrow>label{min-width:120px;color:#374151;padding-top:8px}.adcard input[type="text"],.adcard input[type="email"],.adcard input[type="number"],.adcard input[type="tel"]{flex:1;border:1px solid var(--line);border-radius:8px;padding:10px 12px}#adminEntriesCardRoot .hr{height:1px;background:var(--line);margin:14px 0}#adminEntriesCardRoot .links a{display:inline-block;margin-right:8px}.adcard .note{color:var(--muted)}.adcard .adtoast{position:absolute;right:16px;bottom:16px;background:#111827;color:#fff;border-radius:10px;padding:10px 14px;opacity:0;transform:translateY(10px);transition:.25s;z-index:30}.adcard #toast[data-kind="loading"]{left:583px;top:354px;right:auto;bottom:auto;transform:none}.adcard .adtoast.show{opacity:1;transform:translateY(0)}.adcard .adcard #toast[data-kind="loading"].show{transform:none}#adminEntriesCardRoot .sg-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}#adminEntriesCardRoot .sg-grid input{width:100%;box-sizing:border-box;text-align:center}#adminEntriesCardRoot .pill{display:inline-flex;align-items:center;gap:8px}#adminEntriesCardRoot .small{font-size:12px}#adminEntriesCardRoot .entries-table-wrap{overflow:auto;margin-top:8px}#adminEntriesCardRoot .entries-table{width:100%;border-collapse:collapse;font-size:13px;min-width:900px}#adminEntriesCardRoot .entries-table th,#adminEntriesCardRoot .entries-table td{border:1px solid var(--line);padding:6px 8px;text-align:left;white-space:nowrap}#adminEntriesCardRoot .entries-table th{background:#f3f4f6;font-weight:600}#adminEntriesCardRoot .entries-table td.entry-cell{text-align:center}#adminEntriesCardRoot .entries-table td.sg-cell{text-align:center;max-width:48px}#adminEntriesCardRoot .btn.busy{opacity:0.45 !important;cursor:default;box-shadow:none}#adminEntriesCardRoot .pillInput{appearance:none;border:1px solid #d1d5db;background:#f3f4f6;border-radius:999px;padding:8px 12px;font-weight:600;font-size:14px;color:#111827;outline:none;min-width:220px}#adminEntriesCardRoot .rectHeaderInput{appearance:none;border:1px solid #d1d5db;background:#fff;border-radius:10px;padding:10px 12px;box-shadow:0 1px 0 rgba(0,0,0,.03)inset;font-weight:600;font-size:14px;color:#111827;outline:none;min-width:260px;text-align:left}#adminEntriesCardRoot .pillInput:focus{box-shadow:0 0 0 3px rgba(59,130,246,.25)}#adminEntriesCardRoot .adcard .ad-engineBand{padding:0 10px}.adcard .ad-mt6{margin-top:6px}.adcard .ad-rowHead{align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;margin:4px 0 2px}.adcard .ad-flexRow{display:flex;align-items:center;gap:8px;flex-wrap:wrap}.adcard .ad-h3{margin:0}.adcard .ad-actionsRow{display:flex;align-items:center;gap:8px;flex-wrap:wrap}.adcard .section-actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap}.adcard .ad-noteHelper{margin:0 0 6px 0}.adcard .ad-rowWrap{align-items:center;gap:8px;flex-wrap:wrap}.adcard .ad-formHeaderInput{width:100%;max-width:520px}#adminEntriesCardRoot{font:14px/1.35 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.35}#adminEntriesCardRoot *,#adminEntriesCardRoot *:before,#adminEntriesCardRoot *:after{box-sizing:border-box}#adminEntriesCardRoot h1,#adminEntriesCardRoot h2,#adminEntriesCardRoot h3{text-transform:none;letter-spacing:normal}#adminEntriesCardRoot .spacer{flex:1}</style>
<style id="adCardHostZFix">#adminEntriesCardRoot .adcard.modal-overlay{z-index:13000 !important}</style>
<style id="sgDropdownZFix">#sgCtrl,#daysCtrl{position:relative;z-index:6000}.sg-menu.portal,.dd-menu.portal{z-index:12000 !important;width:90px !important;min-width:90px !important}</style>

<style>input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}input[type=number]{-moz-appearance:textfield;appearance:textfield}</style>

<style>.pm-wrap{display:inline-flex;align-items:center;gap:6px}.pm-btn{display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;line-height:22px;border-radius:5px;border:1px solid #aaa;background:#fff;cursor:pointer;font-weight:700;padding:0}.pm-btn:active{background:#e6e6e6}.pm-wrap input[type=number]{width:44px;min-width:44px;max-width:44px;text-align:center;padding:0 6px;height:28px;line-height:28px;box-sizing:border-box}#sg1Value,#sg2Value,#sg3Value,#sg4Value{width:44px;min-width:44px;max-width:44px;height:28px;line-height:28px;padding:0 6px;text-align:center}.speed-group-row,.sg-row,.speedLimitsRow{display:flex;align-items:center}#daysStripInner .day-col:first-child .pm-wrap{margin-left:10px}
/* v2.7.10: Harden Entries overlay visibility */
#entriesOverlay.open{display:flex !important;}
</style>


<!-- trace panel CSS removed in v2.6.61 -->


</head><body><!-- New Rally modal (v2.4.40) --><div id="newRallyModal" style="display:none; position:fixed; inset:0; z-index:99999;"><div id="nrModal" style="position:absolute; inset:0; display:flex; align-items:flex-start; justify-content:center; padding-top:12vh;"><div id="newRallyBackdrop" style="position:absolute; inset:0; background:rgba(0,0,0,0.35);"></div><div style="position:relative; width:min(520px, calc(100vw - 32px)); background:#fff; border-radius:16px; box-shadow:0 12px 40px rgba(0,0,0,0.35); padding:18px 18px 14px;"><div style="font-weight:700; font-size:16px; margin-bottom:10px;">New Rally</div><div id="newRallyWarn" style="font-size:13px; color:#6b7280; margin:-6px 0 10px 0;">New Rally overwrites your project — consider saving first.</div><div style="font-size:13px; opacity:0.85; margin-bottom:8px;">Enter new rally title:</div><input id="newRallyTitleInput" type="text" value="" placeholder="New Rally" style="width:100%; font-size:16px; padding:12px 14px; border:1px solid #cbd5e1; border-radius:12px; outline:none;" /><input id="nrTitleInput" type="text" value="New Rally" style="display:none;" /><div style="display:flex; justify-content:flex-end; gap:10px; margin-top:14px;"><button id="newRallyCancelBtn" style="border:0; background:#e5e7eb; padding:10px 18px; border-radius:999px; font-weight:600; cursor:pointer;">Cancel</button><button id="newRallyOkBtn" style="border:0; background:#2563eb; color:#fff; padding:10px 22px; border-radius:999px; font-weight:700; cursor:pointer;">OK</button></div></div></div></div><div class="container"><!-- Schedule --><div aria-label="Entries and Time" class="panel" id="schedulePanel"><div id="scheduleGrid"><div class="left-col"><div class="form-row"><div class="label">Rally Days</div><div aria-label="Rally Days" class="dd-ctrl" id="daysCtrl"><div aria-expanded="false" aria-haspopup="listbox" class="dd-display" id="daysDisplay" role="button" tabindex="0"><span id="daysDisplayText">1</span><span>▾</span></div><div class="dd-menu" id="daysMenu" role="listbox"></div></div></div><div class="form-row"><div class="label">Speed Groups</div><div aria-label="Speed Groups" class="sg-ctrl" id="sgCtrl"><div aria-expanded="false" aria-haspopup="listbox" class="sg-display" id="sgDisplay" role="button" tabindex="0"><span id="sgDisplayText">1</span><span>▾</span></div><div class="sg-menu" id="sgMenu" role="listbox"><div class="sg-item" data-val="1"><span class="swatch" style="background:var(--sg1)"></span>1</div><div class="sg-item" data-val="2"><span class="swatch" style="background:var(--sg2)"></span>2</div><div class="sg-item" data-val="3"><span class="swatch" style="background:var(--sg3)"></span>3</div><div class="sg-item" data-val="4"><span class="swatch" style="background:var(--sg4)"></span>4</div></div></div></div><div class="subtitle">Entries and Time</div></div><div id="daysStrip"><div id="daysStripInner"></div></div></div></div><!-- Actions --><div aria-label="Actions panel" class="panel" id="actionsPanel"><div class="bar actions-bar"><div class="actions-left"><button class="btn btn--green" id="addRowBtn">ADD ROW</button><button class="btn btn--grey" id="sortBtn">Sort ▾</button><div class="sep"></div><button class="btn btn--blue" id="saveBtn">Save</button><button class="btn btn--blue" id="loadBtn">Load</button><button class="btn btn--blue" id="printBtn">Print Menu</button></div><div aria-hidden="true" class="actions-spacer"></div><div class="actions-center"><div aria-label="Rally Title" class="rally-pill title muted pristine" contenteditable="true" id="rallyTitlePill" role="textbox" spellcheck="false" style="max-width:250px;">Enter Rally Title</div><div class="rally-pill rev" id="rallyRevPill">r000</div><button class="btn btn--view" id="viewModeBtn" type="button" aria-pressed="false" title="Toggle Compact view (screen only)">Normal</button></div><div aria-hidden="true" class="actions-spacer"></div><div class="actions-right"><div class="actions-right-reserve"><div id="startDelaysToggleWrap" class="start-delays-wrap" style="display:none;" aria-hidden="true"><div class="start-delays-text"><div>Include</div><div>Start Delays</div></div><input id="includeStartDelaysChk" type="checkbox"></div></div><button class="btn btn--blue disabled" id="entriesBtn" type="button" aria-disabled="true" disabled>Entries</button><button class="btn btn--green" id="toolsBtn">Tools</button></div></div><div aria-label="Tools menu" id="toolsMenu"><div class="item" data-action="set-workspace" style="font-weight:600;">Set Rally Workspace…</div><!-- Save As modal --><div class="item disabled" data-action="save-as">Save As…</div><div class="item disabled" data-action="load">Load</div><div class="item" data-action="new-rally">New Rally…</div></div></div><!-- Table boxed panel --><div class="panel table-panel"><div class="table-wrap"><table aria-label="Entries table" id="grid"><colgroup><col class="c0"/><col class="c1"/><col class="c2"/><col class="c3"/><col class="c4"/><col class="c5"/><col class="c6"/><col class="c7"/><col class="c8"/><col class="c9"/><col class="c10"/><col class="c11"/></colgroup><thead><tr class="row1"><th class="gutter"></th><th colspan="2">Driver</th><th colspan="2">Navigator</th><th colspan="2">Driver</th><th colspan="2">Car</th><th>Speed</th><th>Rally</th><th>Start</th></tr><tr class="row2"><th class="gutter"></th><th>First name</th><th>Surname</th><th>First name</th><th>Surname</th><th>Mobile number</th><th>Email</th><th>Make</th><th>Year</th><th>Group</th><th>No</th><th>Time</th></tr></thead><tbody id="tbody"></tbody></table></div></div></div>
<script>

  /* ===============================
     ENGINE ROOM (Admin Clean E1.2)

// Storage helper (real, not stub)
- Legacy TD_RALLIES plumbing deleted.
     - Preserve localStorage schema contract ONLY (no reads/writes yet).
     =============================== */

  const TD_RALLIES_KEY = 'TD_RALLIES';
  /* =========================================
     DOC LINKS (EDIT HERE ONLY)
     - These are opened by the two “First time setup” buttons.
     - Use relative filenames (same folder) or full https:// URLs.
     ========================================= */
  const DOC_CODE_GS = 'Rally_Controls_Code_v2.77.txt';
  const DOC_HTML_SETUP_GUIDE = 'App_script.html';



  

  // v2.8.97 — Minimal Google stamp helpers (Admin only)
  function _fmtGoogleStamp_(ms){
    try{
      const d = new Date(ms || Date.now());
      const dd = String(d.getDate()).padStart(2,'0');
      const mons = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      const mon = mons[d.getMonth()] || 'Jan';
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      const ss = String(d.getSeconds()).padStart(2,'0');
      return `${dd} ${mon} ${hh}:${mm}:${ss}`;
    }catch(_e){ return ''; }
  }
  function _adminSetGoogleStamp_(kind){
    try{
      const k = String(kind||'');
      if (k !== 'upload' && k !== 'download') return false;
      const td = _lsReadTdObjSafe_();
      if (!td || typeof td !== 'object') return false;
      const rid = (td.global && td.global.activeRallyId) ? String(td.global.activeRallyId)
                : (td.global && td.global.lastRallyId) ? String(td.global.lastRallyId)
                : String(window.__ACTIVE_RID__ || 'RID-DEV');
      if (!rid) return false;
      td.rallies = td.rallies || {};
      const r = td.rallies[rid] || (td.rallies[rid] = {});
      r.admin = r.admin || {};
      r.admin.google = (r.admin.google && typeof r.admin.google === 'object') ? r.admin.google : {};
      const stamp = _fmtGoogleStamp_(Date.now());
      if (k === 'upload') r.admin.google.lastUploadAt = stamp;
      if (k === 'download') r.admin.google.lastDownloadAt = stamp;
      return _lsWriteTdObjSafe_(td);
    }catch(_e){ return false; }
  }

/* ===============================
     TD_RALLIES WRITE (v2.5.83) — Admin wiring (SORT only)
     - Debounced commit (400ms) after sort menu selection
     - Writes: rallies[rid].admin.ui.sortMode + rallies[rid].admin.table (ordered)
     - Emits TD_RALLIES_CHANGED after commit
     - BOOT_MUTE guarded (no writes until BOOT_LIVE)
     =============================== */

  function _lsReadTdObjSafe_(){
    try{
      const raw = localStorage.getItem(TD_RALLIES_KEY);
      if (!raw) return null;
      const obj = JSON.parse(raw);
      return (obj && typeof obj === 'object') ? obj : null;
    }catch(_e){ return null; }
  }

  function _lsWriteTdObjSafe_(obj){
    try{
      localStorage.setItem(TD_RALLIES_KEY, JSON.stringify(obj));
      return true;
    }catch(_e){ return false; }
  }

  // TD_RALLIES revision bump (monotonic) for consumer gating (e.g., Controls hydrate)
  
  // v2.8.34 — committed page rally title helper (source of truth = TD_RALLIES)
  function _getCommittedPageRallyTitle_(){
    try{
      const td = _lsReadTdObjSafe_();
      if (!td) return '';
      const rid = td.global && td.global.activeRallyId ? String(td.global.activeRallyId) : '';
      if (!rid) return '';
      const title = td.rallies && td.rallies[rid] && td.rallies[rid].meta ? td.rallies[rid].meta.title : '';
      return String(title || '').trim();
    }catch(_e){ return ''; }
  }

function _tdBumpRev_(root, rid){
    try{
      if (!root || typeof root !== 'object') return 0;
      rid = String(rid || '');
      if (!rid) return 0;
      root.rallies = root.rallies || {};
      const r = root.rallies[rid] || (root.rallies[rid] = {});
      r.meta = r.meta || {};
      let rev = Number(r.meta.rev || 0);
      if (!Number.isFinite(rev) || rev < 0) rev = 0;
      rev = Math.floor(rev) + 1;
      r.meta.rev = rev;
      r.meta.lastUpdatedMs = Date.now();
      return rev;
    }catch(_e){ return 0; }
  }


  // sort quiet-mode gate (blocks writes during sort/menu)
  const __sortQuiet = {
    active: false,
    timer: null,
    startedMs: 0,
    mode: 'none'
  };

  /* v2.6.85 — ER1: persist “end-of-pipeline switch”
     OFF when:
       - no title committed / no store for rid
       - BOOT mute
       - SORT quiet (active)
     ON otherwise.
     This centralises the final write gate without changing behaviour.
  */
  function __adminHasStoreForRid_(rid){
    try{
      if (!rid) return false;
      const root = (typeof _lsReadTdObjSafe_ === 'function') ? _lsReadTdObjSafe_() : null;
      return !!(root && root.rallies && root.rallies[rid]);
    }catch(_e){ return false; }
  }
  function __adminPersistGateAllows_(rid, ctx){
    try{
      if (!rid) return false;

      // v2.8.60 — HARD GATE: never create or write TD_RALLIES unless Title has been committed.
      // Title commit path uses channel==='title' and bypasses this gate.
      try{
        const hasKey = !!localStorage.getItem(TD_RALLIES_KEY);
        if (!hasKey) return false;
      }catch(_e){ return false; }

      // Require a committed title (non-empty) for the active rid.
      try{
        const t = (typeof _getCommittedPageRallyTitle_ === 'function') ? _getCommittedPageRallyTitle_() : '';
        if (!String(t||'').trim()) return false;
      }catch(_e){ return false; }

      if (window.BOOT_MUTE) return false;
      if (__sortQuiet && __sortQuiet.active && !(String(ctx||'').indexOf('sort:')===0)) return false;

      return true;
    }catch(_e){ return false; }
  }

  function __getRidForAdmin_(){
    // For now, keep RID stable; later Admin will set this explicitly.
    try{ return String(window.__ACTIVE_RID__ || 'RID-DEV'); }catch(_e){ return 'RID-DEV'; }
  }

    
  // Build full entrant rows payload (row-ordered; identity = array order)
  
  // Admin Unbundle — Bake 3 helper
  // Ensure truth has at least as many rows as the current visible DOM table.
  // This prevents "dirty-only" / partial-truth snapshots from dropping untouched rows.
  function __ensureStateRowsMatchDomCount_(){
    try{
      if (!window.state || !Array.isArray(window.state.rows)) return;
      const tb = document.getElementById('tbody');
      if (!tb) return;
      const domCount = Array.from(tb.querySelectorAll('tr')).filter(tr=>!tr.classList.contains('row-template')).length;
      const stCount  = window.state.rows.length;

      // ER4b1 (v2.6.93): assert/log only — DO NOT pad truth to match DOM.
      // Any mismatch should be treated as a bug in the commit/render pipeline.
      if (domCount !== stCount){
        try{ __bootLog_ && __bootLog_('UNBUNDLE_ASSERT_STATE_DOM_MISMATCH', { domCount, stCount }); }catch(_e){}
      }
    }catch(_e){}
  }


  // v2.8.64 — Slot model: rallyNo is the fixed slot identity (1..N). index travels with payload.
  
  // v2.8.68 — Slot normaliser (tidy-only): one place defines the slot contract.
  // mode:
  //  - 'ensure': fill missing rallyNo/index from current slot position (init/repair only)
  //  - 'resequence': force rallyNo/index to 1..N by slot position (structural edits only)
  function __normalizeSlots_(mode){
    try{
      if (!window.state || !Array.isArray(window.state.rows)) return;
      const rows = window.state.rows;
      const m = String(mode||'ensure');
      for (let i=0;i<rows.length;i++){
        const r = rows[i];
        if (!r || typeof r !== 'object') continue;
        const n = (i+1);

        if (m === 'resequence'){
          r.rallyNo = n;
          r.index = n;
          if ('startTime' in r){
            try{ r.startTime = (typeof startTimeForRallyNo === 'function') ? startTimeForRallyNo(n) : r.startTime; }catch(_e){}
          }
          continue;
        }

        // ensure (init/repair only)
        if (r.rallyNo == null || r.rallyNo === '' || !Number.isFinite(Number(r.rallyNo))){
          r.rallyNo = n;
        } else {
          r.rallyNo = Number(r.rallyNo);
        }
        if (r.index == null || r.index === '' || !Number.isFinite(Number(r.index))){
          r.index = n;
        } else {
          r.index = Number(r.index);
        }
      }
    }catch(_e){}
  }

function __ensureSlotIdentity_(){ try{ __normalizeSlots_('ensure'); }catch(_e){} }

function __buildAdminEntriesPayload_(){
    try{ __ensureStateRowsMatchDomCount_(); }catch(_e){}

    try{
      const rows = Array.isArray(state.rows) ? state.rows : [];
      return rows.map((r, idx)=>({
        index: (r && r.index!=null) ? r.index : (idx + 1),
        rallyNo: (r && r.rallyNo!=null) ? r.rallyNo : (idx + 1),
        speedGroup: (r && r.speedGroup!=null) ? r.speedGroup : 1,
        driver: (r && r.driver) ? {
          first: r.driver.first || '',
          last: r.driver.last || '',
          mobile: r.driver.mobile || '',
          email: r.driver.email || ''
        } : { first:'', last:'', mobile:'', email:'' },
        navigator: (r && r.navigator) ? {
          first: r.navigator.first || '',
          last: r.navigator.last || ''
        } : { first:'', last:'' },
        car: (r && r.car) ? {
          make: r.car.make || '',
          year: r.car.year || ''
        } : { make:'', year:'' }
      }));
    }catch(_e){ return []; }
  }

function __buildAdminRowsPayload_(){
  return __buildAdminEntriesPayload_();
}

  /* ===============================
     CONTROLS DATA FEED 
     - Derived from Admin truth (state.rows + day start/inc)
     - Written into TD_RALLIES.rallies[rid].controls.days[dayKey].rows
     - Preserves any other properties under controls.days[dayKey]
     =============================== */
  function __buildControlsRowsForDay_(dayIdx, entriesOverride, speedGroupsOverride){
    try{
      const entries = Array.isArray(entriesOverride) ? entriesOverride : __buildAdminRowsPayload_();
      const speedGroups = (speedGroupsOverride && typeof speedGroupsOverride === 'object') ? speedGroupsOverride : null;

      const __coerceSgIdx = (e)=>{
        // Accept: e.sgIdx (truth), e.speedGroup (UI), or string labels like "SG2 (82)".
        let v = null;
        try{
          if (e && e.sgIdx != null) v = e.sgIdx;
          else if (e && e.speedGroup != null) v = e.speedGroup;
          else if (e && e.speedGroupLabel != null) v = e.speedGroupLabel;
        }catch(_e){}
        if (typeof v === 'string'){
          const m = v.match(/([1-4])/);
          v = m ? Number(m[1]) : NaN;
        }
        v = Number(v);
        if (!Number.isFinite(v)) v = 1;
        v = Math.max(1, Math.min(4, Math.round(v)));
        return v;
      };

      const __surname = (e)=>{
        try{
          if (!e) return '';
          if (e.driverSurname != null) return String(e.driverSurname||'');
          if (e.driver && e.driver.last != null) return String(e.driver.last||'');
          if (e.driverName != null) {
            const s = String(e.driverName||'').trim();
            if (!s) return '';
            const parts = s.split(/\s+/);
            return parts.length ? parts[parts.length-1] : s;
          }
        }catch(_e){}
        return '';
      };

      const __speedFromGroups = (sgIdx, e)=>{
        try{
          const k = String(__coerceSgIdx({sgIdx}));
          const v = speedGroups && speedGroups[k] ? Number(speedGroups[k].speed) : NaN;
          if (Number.isFinite(v)) return Math.round(v);
        }catch(_e){}
        // Fallback: accept an already-materialized numeric speed on the entry (if any)
        try{
          const s = Number(e && (e.speed!=null ? e.speed : e.sgSpeed));
          if (Number.isFinite(s)) return Math.round(s);
        }catch(_e){}
        return 60;
      };

      return entries.map((e)=> {
        const sgIdx = __coerceSgIdx(e);
        const rallyNo = Number((e && (e.rallyNo!=null ? e.rallyNo : e.rallyNumber)) ) || 0;
        return {
          rallyNo,
          driverSurname: __surname(e),
          sgIdx,
          speed: __speedFromGroups(sgIdx, e),
          startTime: String(startTimeForDay(Number(dayIdx)||0, rallyNo, (state && state.__lastRowsView)) || '')
        };
      });
    }catch(_e){ return []; }
  }


  function __adminRebuildControlsFromAdmin_(r){
    try{
      if (!r || typeof r !== 'object') return;
      const uiDayCount = (r.admin && r.admin.ui) ? Number(r.admin.ui.dayCount) : NaN;
      const inferred = (state && state.schedule && Array.isArray(state.schedule.startTimes)) ? state.schedule.startTimes.length : NaN;
      let dayCount = Number.isFinite(uiDayCount) ? uiDayCount : (Number.isFinite(inferred) ? inferred : 1);
      dayCount = Math.max(1, Math.min(9, Math.round(dayCount)));

      r.controls = (r.controls && typeof r.controls === 'object') ? r.controls : {};
      r.controls.days = (r.controls.days && typeof r.controls.days === 'object') ? r.controls.days : {};

            const __entriesOverride = (r.admin && Array.isArray(r.admin.entries)) ? r.admin.entries : null;
for(let d=0; d<dayCount; d++){
        const dayKey = String(d+1);
        const dayObj = (r.controls.days[dayKey] && typeof r.controls.days[dayKey] === 'object') ? r.controls.days[dayKey] : {};
        dayObj.rows = __buildControlsRowsForDay_(d, __entriesOverride, (r.admin && r.admin.speedGroups) ? r.admin.speedGroups : null);
        r.controls.days[dayKey] = dayObj;
      }
r.controls.lastBuilt = Date.now();
    }catch(_e){}
  }

  /* v2.6.90 — ER3a: remove redundant persist schedulers (router owns debouncing)
   - Deletes legacy multi-channel scheduler plumbing.
   - All persist requests go through _adminRequestPersist / _adminPersistNow.
   - No behaviour change (final gate still: title committed + BOOT mute + SORT quiet).
*/
const _adminPersistRouter = {
  timers: Object.create(null),
  pending: Object.create(null),
  lastReason: Object.create(null)
};
function _adminPersistSetPending_(channel, v){
  try{ _adminPersistRouter.pending[String(channel||'admin')] = !!v; }catch(_e){}
}

  /* v2.6.87 — ER2: single admin persist router (no behaviour change)
     All persist triggers should call:
       _adminRequestPersist(reason, delay, channel)
     Which schedules:
       _adminPersistNow(reason, channel)
     Final write decision remains in __adminPersistGateAllows_ (BOOT mute / SORT quiet / title committed).
  */
  function _adminRequestPersist(reason, delayMs, channel){
    try{
      reason = String(reason || 'admin');
      channel = String(channel || 'admin');

      const rid = __getRidForAdmin_();
      const ms = (delayMs == null) ? 400 : Number(delayMs||0);

      _adminPersistRouter.lastReason[channel] = reason;
      _adminPersistSetPending_(channel, true);

      if (_adminPersistRouter.timers[channel]) clearTimeout(_adminPersistRouter.timers[channel]);
      _adminPersistRouter.timers[channel] = setTimeout(()=>{
        _adminPersistRouter.timers[channel] = null;
        try{ _adminPersistNow(reason, channel); }catch(_e){}
      }, (Number.isFinite(ms) ? ms : 400));
    }catch(_e){}
  }
  
  /* v2.6.90 — ER3b: single entries snapshot builder for persist (no behaviour change)
     - Consolidates rows + sort snapshot building into one helper.
     - PersistNow becomes: build snapshot → write via __adminPersistEntriesSnapshot_.
  */
  function _adminBuildEntriesSnapshotFromTruth_(channel){
    try{
      channel = String(channel || 'rows');
      const sortMode = (state && state.tableSortState) ? String(state.tableSortState) : 'none';

      // Default: rows snapshot is just the current truth order.
      if (channel !== 'sort'){
        const entries = (typeof __buildAdminRowsPayload_ === 'function') ? __buildAdminRowsPayload_() : [];
        return { entries, sortMode, reason: (channel==='rows' ? 'rows_commit' : (channel + '_commit')) };
      }

      // Sort snapshot: persist the sorted view order without mutating truth during the quiet window.
      let entriesSnap = [];
      try{
        const base = (typeof __buildAdminRowsPayload_ === 'function') ? __buildAdminRowsPayload_() : [];
        entriesSnap = base.slice();

      }catch(_e){ entriesSnap = []; }

      return { entries: entriesSnap, sortMode, reason: 'sort_commit' };
    }catch(_e){
      return { entries: [], sortMode: 'none', reason: 'persist_commit' };
    }
  }

function _adminPersistNow(reason, channel){
    try{
      reason = String(reason || 'admin');
      channel = String(channel || 'admin');

      // v2.8.13 — ensure rid is always defined for persist paths (rows/sort/etc.)
      const rid = (typeof __getRidForAdmin_ === 'function' ? (__getRidForAdmin_() || '') : '') || String(window.__ACTIVE_RID__ || 'RID-DEV');

      // Title commit path: allow create and use caller-provided root override if present.
      if (channel === 'title'){
        // Title commit path: write a caller-provided root override (bypasses final gate).
        try{
          const td = window.__ADMIN_TD_WRITE_OVERRIDE__;
          const rid = __getRidForAdmin_() || (td && td.global && td.global.activeRallyId) || window.__ACTIVE_RID__ || '';
          if (!rid || !td) return { ok:false };
          let ok = false;
          try{
            ok = (typeof _lsWriteTdObjSafe_ === 'function') ? _lsWriteTdObjSafe_(td) : false;
            // v2.8.36: treat store presence as success (gate relies on key presence)
            try{ ok = ok || (!!localStorage.getItem('TD_RALLIES')); }catch(_e){}
            try{ __bootLog_('TITLE_COMMIT', { rid, ok: !!ok }); }catch(_e){}
            try{ window._setEntriesBtnGate_(); }catch(_e){}
          }catch(_e){}
          return { ok: !!ok };
        }catch(_e){
          return { ok:false };
        }
      }

// Special: end sort quiet-mode immediately before sort persist attempt (matches v2.6.85 behaviour)
      if (channel === 'sort'){
        // v2.8.60 — sort must never create TD_RALLIES; gate all writes behind Title Commit.
                if (!__adminPersistGateAllows_(rid, 'sort:'+reason)) {
          try{ _adminPersistSetPending_('sort', false); }catch(_e){}
          return;
        }
        const snap = _adminBuildEntriesSnapshotFromTruth_('sort');
        const res = __adminPersistEntriesSnapshot_(rid, snap.entries, snap.sortMode, snap.reason);
      try{ _adminPersistSetPending_('sort', false); }catch(_e){}
      // sort complete: drop quiet-mode now that the single sort commit has been attempted
      try{ if (__sortQuiet) __sortQuiet.active = false; }catch(_e){}
      
      return;
      }

      if (!__adminPersistGateAllows_(rid, channel+':'+reason)) {
        try{ __bootLog_('PERSIST_GATE_OFF', { ctx: channel+':'+reason, rid }); }catch(_e){}
        try{ _adminPersistSetPending_(channel, false); }catch(_e){}
return;
      }

      if (channel === 'rows'){
        try{ __bootLog_('ROWS_COMMIT_FIRE', { reason }); }catch(_e){}
        const snap = _adminBuildEntriesSnapshotFromTruth_('rows');
        const res = __adminPersistEntriesSnapshot_(rid, snap.entries, snap.sortMode, snap.reason);
        try{ _adminPersistSetPending_('rows', false); }catch(_e){}
        return;
      }

      // [ER5e1] Deleted unreachable duplicate sort persist block (legacy; single pipeline already handles sort)


      // default: treat as rows persist
      _adminPersistNow(reason, 'rows');

    }catch(_e){}
  }

  

  /* ===============================
     ADMIN RENDER-FROM-STATE  — prep for hydrate
     - Pure render: applies TD_RALLIES.admin → in-memory state → UI
     - MUST NOT trigger commits or storage writes
     - Caller is responsible for BOOT_MUTE gating
     =============================== */
  function __renderFromAdminState_(r){
    try{
      if (!r || !r.admin) return;

      // --- Apply stored admin truth into runtime state (UI-only, no commits) ---
      const admin = r.admin || {};
      const ui = admin.ui || {};
      // hydrate sort button state from stored ui.sortMode (UI-only)
      try{
        let sm = (ui && ui.sortMode != null) ? String(ui.sortMode) : 'none';
        if (sm === 'sort-none') sm = 'none';
        if (sm === 'sort-sg-asc') sm = 'sg-asc';
        if (sm === 'sort-sg-desc') sm = 'sg-desc';
        if (sm !== 'sg-asc' && sm !== 'sg-desc') sm = 'none';
        if (window.state) window.state.tableSortState = sm;
      }catch(_e){}


      // hydrate Rally Title + issue label (rXXX) into pills; pristine cleared on hydrate
      try{
        const meta = (r.meta && typeof r.meta === 'object') ? r.meta : {};
        const titleEl = document.getElementById('rallyTitlePill');
        if (titleEl){
          const storeTitle = (typeof meta.title === 'string') ? meta.title.trim() : '';
          if (storeTitle){
            titleEl.textContent = storeTitle;
            try{ titleEl.classList.remove('muted'); }catch(_e){}
            try{ titleEl.classList.remove('pristine'); }catch(_e){}
            try{ titleEl.classList.add('filled'); }catch(_e){}
          }else{
            // no stored title; leave placeholder/state as-is
            try{ titleEl.classList.remove('pristine'); }catch(_e){}
          }
        }
        const revEl = document.getElementById('rallyRevPill');
        if (revEl){
          const issue = (typeof meta.issue === 'string') ? meta.issue.trim() : '';
          if (issue) revEl.textContent = issue;
        }
      }catch(_e){}


      // counts (clamped)
      const dayCount = Math.max(1, Math.min(7, parseInt(ui.dayCount,10) || 1));
      const sgCount  = Math.max(1, Math.min(4, parseInt(ui.sgCount,10)  || 1));

      // Ensure schedule container exists
      try{ if (!state.schedule) state.schedule = {}; }catch(_e){}

      // Keep both legacy top-level mirrors (state.dayCount/sgCount) and schedule counts
      try{ state.dayCount = dayCount; }catch(_e){}
      try{ state.sgCount  = sgCount; }catch(_e){}
      try{ state.schedule.days = dayCount; }catch(_e){}
      try{ state.schedule.speedGroups = sgCount; }catch(_e){}

      // Day arrays (dates/start/inc)
      try{
        if (!Array.isArray(state.schedule.dayDates)) state.schedule.dayDates = [];
        if (!Array.isArray(state.schedule.startTimes)) state.schedule.startTimes = [];
        if (!Array.isArray(state.schedule.incrementsMin)) state.schedule.incrementsMin = [];
        // prefill to length
        for(let i=0;i<dayCount;i++){
          if (state.schedule.dayDates[i]==null) state.schedule.dayDates[i] = '';
          if (state.schedule.startTimes[i]==null) state.schedule.startTimes[i] = '08:30:00';
          if (state.schedule.incrementsMin[i]==null) state.schedule.incrementsMin[i] = 1.0;
        }
      }catch(_e){}

      // Overlay stored admin.days (keyed "1".."7") onto schedule arrays
      try{
        const daysObj = (admin.days && typeof admin.days === 'object') ? admin.days : null;
        if (daysObj){
          for (const k in daysObj){
            if (!Object.prototype.hasOwnProperty.call(daysObj,k)) continue;
            const idx = Math.max(0, (parseInt(k,10)||0) - 1);
            if (idx >= dayCount) continue;
            const d = daysObj[k] || {};
            if (typeof d.date === 'string') state.schedule.dayDates[idx] = d.date;
            if (typeof d.start === 'string' && d.start) state.schedule.startTimes[idx] = d.start;
            if (d.incMin!=null && isFinite(Number(d.incMin))) state.schedule.incrementsMin[idx] = Number(d.incMin);
          }
        }
      }catch(_e){}

      // Speed limits (SG1..SG4) from admin.speedGroups
      try{
        if (!Array.isArray(state.schedule.speedLimits)) state.schedule.speedLimits = [];
        for(let i=0;i<4;i++){
          if (state.schedule.speedLimits[i]==null) state.schedule.speedLimits[i] = 60;
        }
        const sgObj = (admin.speedGroups && typeof admin.speedGroups === 'object') ? admin.speedGroups : null;
        if (sgObj){
          for (const k in sgObj){
            if (!Object.prototype.hasOwnProperty.call(sgObj,k)) continue;
            const idx = Math.max(0, (parseInt(k,10)||0) - 1);
            if (idx < 0 || idx > 3) continue;
            const v = Number((sgObj[k]||{}).speed);
            if (isFinite(v)) state.schedule.speedLimits[idx] = Math.round(v);
          }
        }
      }catch(_e){}

      // Update top selectors (text + sg class state)
      try{
        const dEl = document.getElementById('daysDisplayText');
        if (dEl) dEl.textContent = String(dayCount);
        const sgEl = document.getElementById('sgDisplayText');
        if (sgEl){
          sgEl.textContent = String(sgCount);
          const host = (sgEl.closest && sgEl.closest('.dropdown')) ? sgEl.closest('.dropdown') : sgEl.parentElement;
          const box = host || sgEl;
          if (box && box.classList){
            box.classList.remove('sg2','sg3','sg4');
            if (sgCount===2) box.classList.add('sg2');
            if (sgCount===3) box.classList.add('sg3');
            if (sgCount===4) box.classList.add('sg4');
          }
        }
      }catch(_e){}

      // Entries rows
      const rowsIn = Array.isArray(admin.entries) ? admin.entries : [];
      const rows = rowsIn.map((row, idx)=>{
        const r2 = (row && typeof row === 'object') ? row : {};
        // enforce rallyNo 1..N top-to-bottom (slot identity)
        r2.rallyNo = idx + 1;
        if (r2.index==null) r2.index = idx + 1;
        if (r2.speedGroup==null) r2.speedGroup = 1;
        if (!r2.driver) r2.driver = { first:'', last:'', mobile:'', email:'' };
        if (!r2.navigator) r2.navigator = { first:'', last:'' };
        if (!r2.car) r2.car = { make:'', year:'' };
        return r2;
      });

      try{ state.rows = rows; }catch(_e){}

      // Render pipeline (UI only)
      try{ renderDays(); }catch(_e){}
}catch(_e){}
  }

  // === Consolidation C3: single snapshot+write helper for admin.entries (no behaviour change) ===
  // Centralizes: write admin.entries + ui.sortMode (+ optional controls-from-entries hint) through the single-writer.
  function __adminPersistEntriesSnapshot_(rid, entries, sortMode, reason, extraMeta){
    try{
      const meta = Object.assign(
        { branch:'admin.entries', reason: String(reason||'entries_commit'), allowCreate:true },
        (extraMeta && typeof extraMeta === 'object') ? extraMeta : {}
      );
      return __adminTdWrite_(rid, (root, r)=>{
        if (!r.admin) r.admin = {};
        if (!r.admin.ui) r.admin.ui = {};
        r.admin.ui.sortMode = String(sortMode || 'none');
        r.admin.entries = Array.isArray(entries) ? entries : [];

// v2.8.60 — Controls feed regeneration is handled via __buildControlsRowsForDay_ (admin.entries + admin.speedGroups). Legacy DOM-based projection removed.

        try{
          if (typeof __buildControlsRowsForDay_ === 'function'){
            if (!r.admin.controls || typeof r.admin.controls !== 'object') r.admin.controls = {};
            const uiDayCount = (r.admin && r.admin.ui) ? Number(r.admin.ui.dayCount) : NaN;
            let dayCount = Number.isFinite(uiDayCount) ? uiDayCount : 1;
            dayCount = Math.max(1, Math.min(9, Math.round(dayCount)));
            r.admin.controls.days = (r.admin.controls.days && typeof r.admin.controls.days === 'object') ? r.admin.controls.days : {};
            for(let d=0; d<dayCount; d++){
              const dayKey = String(d+1);
              const dayObj = (r.admin.controls.days[dayKey] && typeof r.admin.controls.days[dayKey] === 'object') ? r.admin.controls.days[dayKey] : {};
              dayObj.entries = __buildControlsRowsForDay_(d, r.admin.entries, r.admin.speedGroups);
              r.admin.controls.days[dayKey] = dayObj;
            }
            // legacy mirror (Day 1)
            r.admin.controls.entries = (r.admin.controls.days["1"] && Array.isArray(r.admin.controls.days["1"].entries)) ? r.admin.controls.days["1"].entries : [];
            r.admin.controls.meta = Object.assign({}, (r.admin.controls.meta||{}), {
              updatedAtMs: Date.now(),
              rowCount: Array.isArray(r.admin.controls.entries) ? r.admin.controls.entries.length : 0
            });
          }
        }catch(_e){}

      }, meta);
    }catch(_e){
      return { ok:false, why:'err' };
    }
  }

function requestAdminEntriesPersistAfterSettle_(reason){
    try{
      if (window.BOOT_MUTE) return; // hard gate
      _adminRequestPersist(String(reason || 'entries'), 400, 'rows');
    }catch(_e){}
  }

function requestAdminSortPersistAfterSettle_(reason){
    try{
      const __reason = String(reason || 'sort');
// Keep/enter quiet-mode until the debounce fires (independent of store presence)
      __sortQuiet.active = true;
      __sortQuiet.startedMs = Date.now();
      __sortQuiet.mode = (state && state.tableSortState) ? String(state.tableSortState) : 'none';

      _adminRequestPersist(__reason, 400, 'sort');
    }catch(_e){}
  }


  
  /* ===============================
     Admin Unbundle — Bake 2 helpers
     - Flush active edit before sort
     - Apply sort order into truth (state.rows) so DOM and truth converge
     =============================== */
  function __flushActiveEditBeforeSort_(){
    try{
      const ae = document.activeElement;
      if (!ae) return;
      const tag = String(ae.tagName||'').toUpperCase();
      const isEdit = ae.isContentEditable || tag === 'INPUT' || tag === 'SELECT' || tag === 'TEXTAREA';
      if (isEdit && typeof ae.blur === 'function') ae.blur();
    }catch(_e){}
  }

  
function __applySortOrderToTruth_(mode){
    // v2.6.79 — Sort must NOT move rallyNo (row slots are fixed).
    // Instead: build a payload list (everything except rallyNo/start time),
    // sort that payload list, then write the payloads back into the fixed
    // rallyNo slots in rallyNo order.
    try{
      if (!window.state || !Array.isArray(window.state.rows)) return;
      const rows = window.state.rows;
      const n = rows.length;

      // Slot order = rallyNo ascending (fallback to current array order).
      const slots = rows.map((row, i)=>({ row, i })).sort((a,b)=>{
        const ra = (a.row && a.row.rallyNo!=null) ? Number(a.row.rallyNo) : (a.i+1);
        const rb = (b.row && b.row.rallyNo!=null) ? Number(b.row.rallyNo) : (b.i+1);
        if (ra !== rb) return ra - rb;
        return a.i - b.i;
      });

      // Payloads travel (includes entry.index). DO NOT carry rallyNo.
      const payloads = rows.map((r, i)=>({
        __srcI: i,
        index: (r && r.index!=null) ? Number(r.index) : (i+1),
        speedGroup: (r && r.speedGroup!=null) ? Number(r.speedGroup) : 1,
        driver: r && r.driver ? {
          first: String(r.driver.first||''),
          last: String(r.driver.last||''),
          mobile: String(r.driver.mobile||''),
          email: String(r.driver.email||'')
        } : { first:'', last:'', mobile:'', email:'' },
        navigator: r && r.navigator ? {
          first: String(r.navigator.first||''),
          last: String(r.navigator.last||'')
        } : { first:'', last:'' },
        car: r && r.car ? {
          make: String(r.car.make||''),
          year: String(r.car.year||'')
        } : { make:'', year:'' }
      }));

      const m = String(mode || 'none');

      // Stable sort helper: keep previous relative order for equal keys.
      const stable = payloads.map((p, i)=>({ p, i }));

      let sorted;
      if (m === 'sg-asc' || m === 'sort-sg-asc'){
        sorted = stable.slice().sort((a,b)=>{
          const ga = Number(a.p.speedGroup)||1;
          const gb = Number(b.p.speedGroup)||1;
          if (ga !== gb) return ga - gb;
          // secondary: index ascending (travels with payload)
          const ia = Number(a.p.index)||0;
          const ib = Number(b.p.index)||0;
          if (ia !== ib) return ia - ib;
          return a.i - b.i;
        }).map(o=>o.p);
      } else if (m === 'sg-desc' || m === 'sort-sg-desc'){
        sorted = stable.slice().sort((a,b)=>{
          const ga = Number(a.p.speedGroup)||1;
          const gb = Number(b.p.speedGroup)||1;
          if (ga !== gb) return gb - ga;
          const ia = Number(a.p.index)||0;
          const ib = Number(b.p.index)||0;
          if (ia !== ib) return ia - ib;
          return a.i - b.i;
        }).map(o=>o.p);
      } else {
        // Restore entry order: payload.index ascending.
        sorted = stable.slice().sort((a,b)=>{
          const ia = Number(a.p.index)||0;
          const ib = Number(b.p.index)||0;
          if (ia !== ib) return ia - ib;
          return a.i - b.i;
        }).map(o=>o.p);
      }

      // Write payloads into fixed slots (rallyNo stays on slot.row).
      for (let i=0; i<n; i++){
        const slot = slots[i] && slots[i].row ? slots[i].row : null;
        const pay = sorted[i] || null;
        if (!slot || !pay) continue;
                // Keep slot.rallyNo as-is (fixed foundation).
        // index is the entrant ID (unsort key) and must travel with the payload.
        slot.index = isFinite(pay.index) ? pay.index : slot.index;
        slot.speedGroup = isFinite(pay.speedGroup) ? pay.speedGroup : 1;
        slot.driver = pay.driver;
        slot.navigator = pay.navigator;
        slot.car = pay.car;
      }

      try{ __bootLog_('SORT_PAYLOAD_APPLIED', { mode: m, n }); }catch(_e){}    }catch(_e){}
  }


/* ===============================
     EVENT PLUMBING (v2.5.80) — signals only
     - Single event: TD_RALLIES_CHANGED { rid, branch, reason, ts }
     - No localStorage reads/writes for this phase
     - Global BOOT_MUTE gate (Phase1/2 muted, Phase3 live)
     =============================== */

  // --- Boot/timing gate (locked foundations) ---
  window.__BOOT_PHASE__ = 1;          // 1=UI boot+settle, 2=hydrate+settle, 3=live
  window.BOOT_MUTE = true;            // hard gate: ALL listeners must respect
  window.__BOOT_T0__ = (performance && performance.now) ? performance.now() : Date.now();

  function __bootLog_(tag, data){ /* removed BOOT LOG */ }

  // Phase 1 -> 2 after ~400ms
  setTimeout(()=>{
    window.__BOOT_PHASE__ = 2;
    __bootLog_('BOOT_PHASE_2', {ts: Date.now()});
    // Hydrate (read-only) after first settle: if TD_RALLIES exists, render from stored admin state.
    try{
      const td = _lsReadTdObjSafe_();
      if (td && td.rallies && typeof td.rallies === 'object'){
        let rid = null;
        try{
          if (td.global && (td.global.activeRallyId || td.global.lastRallyId)){
            rid = String(td.global.activeRallyId || td.global.lastRallyId);
          }
        }catch(_e){}
        if (!rid){
          const keys = Object.keys(td.rallies || {});
          if (keys && keys.length) rid = String(keys[0]);
        }
        if (rid && td.rallies[rid]){
          try{ window.__ACTIVE_RID__ = rid; }catch(_e){}
          let rev = null;
          try{ rev = td.rallies[rid].meta && td.rallies[rid].meta.rev; }catch(_e){}
          __bootLog_('HYDRATE_BEGIN', {rid, rev, ts: Date.now()});
          try{ __renderFromAdminState_(td.rallies[rid]); }catch(_e){}
          __bootLog_('HYDRATE_DONE', {rid, rev, ts: Date.now()});
        }
      }
    }catch(_e){}
    // Phase 2 -> 3 after ~400ms (second settle)
    setTimeout(()=>{
      window.__BOOT_PHASE__ = 3;
      window.BOOT_MUTE = false;
      
      try{ setTimeout(__adminSeedBootLive_, 0); }catch(_e){}
__bootLog_('BOOT_LIVE', {ts: Date.now()});
    }, 400);
  }, 400);

  

  /* Trace panel removed in v2.6.61 */

;

  // --- TD_RALLIES_CHANGED emitter ---
  const __tdEvt = {
    bc: null,
    lastSig: '',
    lastAt: 0,
    timers: Object.create(null)
  };

  function __tdEnsureBC_(){
    try{
      if (__tdEvt.bc) return __tdEvt.bc;
      if ('BroadcastChannel' in window){
        __tdEvt.bc = new BroadcastChannel('TD_RALLIES_CHANGED');
      }
    }catch(_e){}
    return __tdEvt.bc;
  }

  function emitTdChanged_(detail){
    try{
      const rid = detail && detail.rid ? String(detail.rid) : (window.__ACTIVE_RID__ || 'RID-DEV');
      const branch = String(detail.branch || '');
      const reason = String(detail.reason || '');
      const ts = Date.now();
      const rev = (detail && (detail.rev !== undefined)) ? Number(detail.rev) : undefined;
      const payload = (rev === undefined || !Number.isFinite(rev)) ? { rid, branch, reason, ts } : { rid, branch, reason, ts, rev };
      try{ if (detail && Array.isArray(detail.branches)) payload.branches = detail.branches.slice(0); }catch(_e){}

      // de-dupe bursts (same branch+reason within 180ms)
      let sig = `${rid}|${branch}|${reason}` + ((payload.rev!==undefined)?`|rev:${payload.rev}`:'');
      try{ if (detail && detail.sigExtra) sig += `|${String(detail.sigExtra)}`; }catch(_e){}
      const now = ts;
      if (__tdEvt.lastSig === sig && (now - __tdEvt.lastAt) < 180) return;
      __tdEvt.lastSig = sig;
      __tdEvt.lastAt = now;

      // intra-page
      try{ window.dispatchEvent(new CustomEvent('TD_RALLIES_CHANGED', { detail: payload })); }catch(_e){}

      // cross-tab (no localStorage writes)
      const bc = __tdEnsureBC_();
      try{ bc && bc.postMessage(payload); }catch(_e){}}catch(_e){}
  }

  function emitTdChangedDebounced_(key, detail, waitMs){
    waitMs = Math.max(0, Number(waitMs)||0);
    const k = String(key||'');
    try{
      if (__tdEvt.timers[k]) clearTimeout(__tdEvt.timers[k]);
      __tdEvt.timers[k] = setTimeout(()=>{ __tdEvt.timers[k]=null; emitTdChanged_(detail); }, waitMs);
    }catch(_e){}
  }

  // v2.8.23 — external meta sync (title + rXXX pill) on TD_RALLIES changes from other pages
  function __adminRefreshTitleIssuePills_(){
    try{
      const rid = (typeof __getRidForAdmin_ === 'function') ? (__getRidForAdmin_() || '') : String(window.__ACTIVE_RID__ || 'RID-DEV');
      const root = (typeof _lsReadTdObjSafe_ === 'function') ? (_lsReadTdObjSafe_() || null) : null;
      const r = (root && root.rallies && rid && root.rallies[rid]) ? root.rallies[rid] : null;
      const meta = (r && r.meta && typeof r.meta === 'object') ? r.meta : {};
      const storeTitle = (typeof meta.title === 'string') ? meta.title.trim() : '';
      const storeIssue = (typeof meta.issue === 'string') ? meta.issue.trim() : '';

      const titleEl = document.getElementById('rallyTitlePill');
      if (titleEl && storeTitle){
        // Only overwrite when the store has a real committed title.
        titleEl.textContent = storeTitle;
        try{ titleEl.classList.remove('muted'); }catch(_e){}
        try{ titleEl.classList.remove('pristine'); }catch(_e){}
        try{ titleEl.classList.add('filled'); }catch(_e){}
      }

      const revEl = document.getElementById('rallyRevPill');
      if (revEl && storeIssue){
        revEl.textContent = storeIssue;
      }
    }catch(_e){}
  }

  (function __adminInstallExternalTdMetaSync_(){
    try{
      let t = null;
      const schedule = ()=>{
        try{ if (t) clearTimeout(t); }catch(_e){}
        t = setTimeout(__adminRefreshTitleIssuePills_, 30);
      };

      // Intra-page signal
      try{
        window.addEventListener('TD_RALLIES_CHANGED', (ev)=>{
          try{
            const d = (ev && ev.detail) ? ev.detail : null;
            const rid = d && d.rid ? String(d.rid) : '';
            const arid = String(window.__ACTIVE_RID__ || 'RID-DEV');
            if (rid && rid !== arid) return;
          }catch(_e){}
          schedule();
        }, true);
      }catch(_e){}

      // Cross-tab signal (BroadcastChannel)
      try{
        const bc = (typeof __tdEnsureBC_ === 'function') ? __tdEnsureBC_() : null;
        if (bc && !bc.__adminMetaListenBound){
          bc.__adminMetaListenBound = true;
          try{
            bc.addEventListener('message', (ev)=>{
              try{
                const d = (ev && ev.data) ? ev.data : null;
                const rid = d && d.rid ? String(d.rid) : '';
                const arid = String(window.__ACTIVE_RID__ || 'RID-DEV');
                if (rid && rid !== arid) return;
              }catch(_e){}
              schedule();
            });
          }catch(_e){
            try{
              bc.onmessage = (ev)=>{ schedule(); };
            }catch(_e2){}
          }
        }
      }catch(_e){}

      // Fallback: storage event when TD_RALLIES is written (other tabs)
      try{
        window.addEventListener('storage', (ev)=>{
          try{
            if (!ev) return;
            if (ev.key !== TD_RALLIES_KEY) return;
          }catch(_e){}
          schedule();
        });
      }catch(_e){}
    }catch(_e){}
  })();

  // v2.5.93 — Rally Title pill -> TD_RALLIES generator (meta.title)
  function commitRallyTitleToTd_(title){
    try{
      if (window.BOOT_MUTE) return { ok:false, why:'BOOT_MUTE' };
      title = String(title||'').trim();
      if (!title) return { ok:false, why:'empty' };

      const rid = (typeof __getRidForAdmin_ === 'function') ? __getRidForAdmin_() : String(window.__ACTIVE_RID__ || 'RID-DEV');
      const root = (typeof _lsReadTdObjSafe_ === 'function') ? (_lsReadTdObjSafe_() || { global:{}, rallies:{} }) : { global:{}, rallies:{} };

      if (!root.global || typeof root.global !== 'object') root.global = {};
      root.global.activeRallyId = rid;
      root.global.lastRallyId = rid;

      // v2.8.81 — if workspace already exists (IDB-restored or previously set), stamp TD_RALLIES.global mirror now.
      try{
        if (window.__WORKSPACE && window.__WORKSPACE.ready){
          root.global.workspaceReady = true;
          root.global.workspaceLabel = String(window.__WORKSPACE.label || '');
        }
      }catch(_e){}
      if (!root.rallies || typeof root.rallies !== 'object') root.rallies = {};
      const r = root.rallies[rid] || (root.rallies[rid] = {});
      r.meta = (r.meta && typeof r.meta === 'object') ? r.meta : {};

      r.meta.title = title;

      // Keep issue label mirrored when present (e.g. r000)
      try{
        const el = document.getElementById('rallyRevPill');
        const issue = el ? String(el.textContent||'').trim() : '';
        if (issue) r.meta.issue = issue;
      }catch(_e){}

      
      // v2.5.95 — post-title seed days/speedGroups (missing-only, single emit)
      try{
        const dayCount = Math.max(1, Math.min(7, Number(
          (state && state.schedule && state.schedule.days) ||
          (document.getElementById('daysDisplayText') && document.getElementById('daysDisplayText').textContent) ||
          1
        )));
        const sgCount  = Math.max(1, Math.min(4, Number(
          (state && state.schedule && state.schedule.speedGroups) ||
          (document.getElementById('sgDisplayText') && document.getElementById('sgDisplayText').textContent) ||
          1
        )));
        const rr = (typeof __tdEnsureAdminBranch_ === 'function') ? __tdEnsureAdminBranch_(root, rid) : r;
        if (rr && rr.admin){
          if (rr.admin.ui && rr.admin.ui.dayCount == null) rr.admin.ui.dayCount = dayCount;
          if (rr.admin.ui && rr.admin.ui.sgCount == null) rr.admin.ui.sgCount = sgCount;
          if (rr.admin.ui && rr.admin.ui.sortMode == null) rr.admin.ui.sortMode = (state && state.tableSortState) ? state.tableSortState : 'none';
          if (typeof __seedMissingDays_ === 'function') __seedMissingDays_(rr, dayCount);
          if (typeof __seedMissingSpeedGroups_ === 'function') __seedMissingSpeedGroups_(rr, sgCount);
          // On title-confirm (store creation), seed admin.entries (even if blank)
          try{
            if (rr && rr.admin){
              rr.admin.entries = (typeof __buildAdminRowsPayload_ === 'function') ? __buildAdminRowsPayload_() : (rr.admin.entries || []);
            }
          }catch(_e){}
          // v2.8.91 — seed admin.controls (derived Controls feed) day-based via __buildControlsRowsForDay_ (no DOM reads)
          try{
            if (rr && rr.admin && typeof __buildControlsRowsForDay_ === 'function'){
              if (!rr.admin.controls || typeof rr.admin.controls !== 'object') rr.admin.controls = {};
              const uiDayCount = (rr.admin && rr.admin.ui) ? Number(rr.admin.ui.dayCount) : NaN;
              let dayCount = Number.isFinite(uiDayCount) ? uiDayCount : 1;
              dayCount = Math.max(1, Math.min(9, Math.round(dayCount)));
              rr.admin.controls.days = (rr.admin.controls.days && typeof rr.admin.controls.days === 'object') ? rr.admin.controls.days : {};
              for(let d=0; d<dayCount; d++){
                const dayKey = String(d+1);
                const dayObj = (rr.admin.controls.days[dayKey] && typeof rr.admin.controls.days[dayKey] === 'object') ? rr.admin.controls.days[dayKey] : {};
                dayObj.entries = __buildControlsRowsForDay_(d, rr.admin.entries, rr.admin.speedGroups);
                rr.admin.controls.days[dayKey] = dayObj;
              }
              // legacy mirror (Day 1)
              rr.admin.controls.entries = (rr.admin.controls.days["1"] && Array.isArray(rr.admin.controls.days["1"].entries)) ? rr.admin.controls.days["1"].entries : [];
              rr.admin.controls.meta = Object.assign({}, (rr.admin.controls.meta||{}), { updatedAtMs: Date.now(), rowCount: Array.isArray(rr.admin.controls.entries) ? rr.admin.controls.entries.length : 0 });
            }
          }catch(_e){}{}

        }
      }catch(_e){}
let rev = Number(r.meta.rev || 0);
      if (!Number.isFinite(rev) || rev < 0) rev = 0;
      rev = Math.floor(rev) + 1;
      r.meta.rev = rev;
      r.meta.lastUpdatedMs = Date.now();let ok = false;

      try{
        window.__ADMIN_TD_WRITE_OVERRIDE__ = root;
        const __res = (typeof _adminPersistNow === 'function') ? _adminPersistNow('title_commit','title') : null;
        ok = !!(__res && __res.ok);
      }finally{
        try{ window.__ADMIN_TD_WRITE_OVERRIDE__ = null; }catch(_e){}
      }try{ emitTdChangedDebounced_ && emitTdChangedDebounced_('admin.meta.title', { rid, branch:'meta', reason:'title_commit', rev, sigExtra:'title' }, 0); }catch(_e){}

      return { ok: !!ok, rev };
    }catch(_e){
      return { ok:false, why:'err' };
    }
  }


  /* v2.5.93 — TD_RALLIES writers (days + speedGroups only)
     - Uses the proven “commit points” (change/commit handlers)
     - Single write + single meta.rev bump per commit
     - Returns {ok, rid, rev} for event payloads
     - BOOT_MUTE respected
  */

  function __tdBumpRevForRid_(root, rid){
    try{
      root.rallies = root.rallies || {};
      const r = root.rallies[rid] || (root.rallies[rid] = {});
      r.meta = r.meta || {};
      let rev = Number(r.meta.rev || 0);
      if (!Number.isFinite(rev) || rev < 0) rev = 0;
      rev = Math.floor(rev) + 1;
      r.meta.rev = rev;
      r.meta.lastUpdatedMs = Date.now();
      return rev;
    }catch(_e){ return 0; }
  }

  function __tdEnsureRootForRid_(rid){
    const root = (typeof _lsReadTdObjSafe_ === 'function') ? (_lsReadTdObjSafe_() || { global:{}, rallies:{} }) : { global:{}, rallies:{} };
    if (!root.global || typeof root.global !== 'object') root.global = {};
    if (!root.rallies || typeof root.rallies !== 'object') root.rallies = {};
    root.global.activeRallyId = rid;
    root.global.lastRallyId = rid;
    const r = root.rallies[rid] || (root.rallies[rid] = {});
    r.admin = r.admin || {};
    return { root, r };
  }

  // NEAT&TIDY: writers never create TD_RALLIES.
  // Only Title confirm is allowed to create a store/rally branch.
  function __tdPeekRootForRid_(rid){
    try{
      rid = String(rid||'');
      if (!rid) return null;
      const root = (typeof _lsReadTdObjSafe_ === 'function') ? _lsReadTdObjSafe_() : null;
      if (!root || typeof root !== 'object') return null;
      if (!root.rallies || typeof root.rallies !== 'object') return null;
      const r = root.rallies[rid];
      if (!r || typeof r !== 'object') return null;
      return { root, r };
    }catch(_e){ return null; }
  }


  // SINGLE WRITER: all Admin TD_RALLIES mutations funnel through here.
  function __adminTdWrite_(rid, mutatorFn, meta){
    try{
      if (window.BOOT_MUTE) return { ok:false, why:'BOOT_MUTE' };
      rid = String(rid || '');
      if (!rid) return { ok:false, why:'no_rid' };

      const __allowCreate = !!(meta && meta.allowCreate);

      // v2.8.91 — patch-only writer: always merge into the latest TD_RALLIES root.
      // Never overwrite non-admin lanes (schedule/controls/timeline/results).
      let root = (typeof _lsReadTdObjSafe_ === 'function') ? _lsReadTdObjSafe_() : null;
      if (!root || typeof root !== 'object') {
        if (!__allowCreate) return { ok:false, why:'NO_STORE' };
        root = { global:{}, rallies:{} };
      }
      if (!root.global || typeof root.global !== 'object') root.global = {};
      if (!root.rallies || typeof root.rallies !== 'object') root.rallies = {};

      if (__allowCreate){
        root.global.activeRallyId = rid;
        root.global.lastRallyId = rid;
      }

      let r = root.rallies[rid];
      if (!r || typeof r !== 'object'){
        if (!__allowCreate) return { ok:false, why:'NO_STORE' };
        r = (root.rallies[rid] = {});
      }

      // Capture lane references from the latest root (these must survive any admin mutation).
      const __laneRef = {
        schedule: r.schedule,
        controls: r.controls,
        timeline: r.timeline,
        results: r.results
      };

      // Ensure admin branch containers exist but NEVER replace existing objects.
      if (!r.admin || typeof r.admin !== 'object') r.admin = {};
      if (!r.admin.ui || typeof r.admin.ui !== 'object') r.admin.ui = {};

      // cleanup: remove legacy admin.rows branch if present.
      try{ if (r.admin && Object.prototype.hasOwnProperty.call(r.admin,'rows')) delete r.admin.rows; }catch(_e){}

      // Apply mutation (caller mutates r.admin / root as needed).
      if (typeof mutatorFn === 'function') mutatorFn(root, r);

      // Keep derived admin.controls feed up to date (admin-owned only).
      try{
        if (r && r.admin && typeof __buildControlsRowsForDay_ === 'function'){
          if (!r.admin.controls || typeof r.admin.controls !== 'object') r.admin.controls = {};
          const uiDayCount = (r.admin && r.admin.ui) ? Number(r.admin.ui.dayCount) : NaN;
          let dayCount = Number.isFinite(uiDayCount) ? uiDayCount : 1;
          dayCount = Math.max(1, Math.min(9, Math.round(dayCount)));
          r.admin.controls.days = (r.admin.controls.days && typeof r.admin.controls.days === 'object') ? r.admin.controls.days : {};
          for(let d=0; d<dayCount; d++){
            const dayKey = String(d+1);
            const dayObj = (r.admin.controls.days[dayKey] && typeof r.admin.controls.days[dayKey] === 'object') ? r.admin.controls.days[dayKey] : {};
            dayObj.entries = __buildControlsRowsForDay_(d, r.admin.entries, (r.admin && r.admin.speedGroups) ? r.admin.speedGroups : null);
            r.admin.controls.days[dayKey] = dayObj;
          }
          r.admin.controls.lastBuilt = Date.now();
        }
      }catch(_e){}

      // Restore non-admin lanes from the latest root snapshot (prevent clobber).
      try{
        r.schedule = __laneRef.schedule;
        r.controls = __laneRef.controls;
        r.timeline = __laneRef.timeline;
        r.results = __laneRef.results;
      }catch(_e){}

      // Touch + rev bump + write + single emit.
      r.admin.lastTouched = Date.now();
      root.rallies[rid] = r;

      const rev = (typeof __tdBumpRevForRid_ === 'function') ? __tdBumpRevForRid_(root, rid) : _tdBumpRev_(root, rid);
      const ok = (typeof _lsWriteTdObjSafe_ === 'function') ? _lsWriteTdObjSafe_(root) : false;

      // Notify consumers (single debounced emit).
      try{
        const baseMeta = (meta && typeof meta === 'object') ? meta : {};
        const branches = Array.isArray(baseMeta.branches) ? baseMeta.branches.slice(0) : [];
        if (baseMeta.branch && !branches.includes(baseMeta.branch)) branches.push(baseMeta.branch);
        const payload = Object.assign({ rid, rev, ok, branches }, baseMeta);
        emitTdChangedDebounced_(payload);
      }catch(_e){}

      return { ok: !!ok, rid, rev };
    }catch(_e){
      return { ok:false, why:'err' };
    }
  }


  function commitAdminDayToTd_(dayIdx, reason){
    try{
      const rid = (typeof __getRidForAdmin_ === 'function') ? __getRidForAdmin_() : String(window.__ACTIVE_RID__ || 'RID-DEV');
      const dayKey = String((Number(dayIdx)||0) + 1);

      // Gather from UI state
      const date = (state && state.schedule && Array.isArray(state.schedule.dayDates)) ? String(state.schedule.dayDates[dayIdx] || '') : '';
      let start = (state && state.schedule && Array.isArray(state.schedule.startTimes)) ? String(state.schedule.startTimes[dayIdx] || '') : '';
      if (start && start.length === 5) start = start + ':00';
      if (start && start.length === 8) start = start.slice(0,8);

      let incMin = (state && state.schedule && Array.isArray(state.schedule.incrementsMin)) ? Number(state.schedule.incrementsMin[dayIdx]) : NaN;
      if (!Number.isFinite(incMin)) incMin = 1;
      incMin = Math.round(incMin * 2) / 2;

      const res = __adminTdWrite_(rid, (root, r)=>{
        r.admin.days = r.admin.days || {};
        r.admin.days[dayKey] = { date, start, incMin };
      }, { branch:'admin.days', reason: String(reason || 'day_commit') });

      try{ __bootLog_('TD_WRITE_ADMIN_DAY', { rid, day: dayKey, ok: res.ok, date, start, incMin, rev: res.rev }); }catch(_e){}
      return res;
    }catch(_e){ return { ok:false, why:'exception' }; }
  }

  function commitAdminSpeedGroupToTd_(sgIdx, speed){
    try{
      const rid = (typeof __getRidForAdmin_ === 'function') ? __getRidForAdmin_() : String(window.__ACTIVE_RID__ || 'RID-DEV');
      const sgKey = String(Math.max(1, Math.min(4, Number(sgIdx)||1)));
      let v = Number(speed);
      if (!Number.isFinite(v)) v = 60;
      v = Math.round(v);

      const res = __adminTdWrite_(rid, (root, r)=>{
        r.admin.speedGroups = r.admin.speedGroups || {};
        r.admin.speedGroups[sgKey] = { speed: v };
      }, { branch:'admin.speedGroups', reason:'sg_commit', sg: sgKey });

      try{ __bootLog_('TD_WRITE_ADMIN_SG', { rid, sg: sgKey, ok: res.ok, speed: v, rev: res.rev }); }catch(_e){}
      return res;
    }catch(_e){ return { ok:false, why:'exception' }; }
  }

  /* ===============================
     TD_RALLIES SEEDERS (v2.5.94) — no overwrite, no prune, single emit
     - BootLive: if TD_RALLIES exists, seed missing admin.ui/dayCount/sgCount + admin.days + admin.speedGroups
     - dayCount commit: seed missing days (and admin.ui.dayCount)
     - sgCount commit: seed missing speedGroups (and admin.ui.sgCount)
     =============================== */

  function __tdGetExistingRoot_(){
    // IMPORTANT: do NOT create TD_RALLIES here (Title pill is the generator).
    return _lsReadTdObjSafe_();
  }

  function __tdEnsureAdminBranch_(root, rid){
    root.global = root.global && typeof root.global === 'object' ? root.global : {};
    root.rallies = root.rallies && typeof root.rallies === 'object' ? root.rallies : {};
    const r = root.rallies[rid] && typeof root.rallies[rid] === 'object' ? root.rallies[rid] : {};
    r.meta = r.meta && typeof r.meta === 'object' ? r.meta : {};
    r.admin = r.admin && typeof r.admin === 'object' ? r.admin : {};
    r.admin.ui = r.admin.ui && typeof r.admin.ui === 'object' ? r.admin.ui : {};
    r.admin.days = r.admin.days && typeof r.admin.days === 'object' ? r.admin.days : {};
    r.admin.speedGroups = r.admin.speedGroups && typeof r.admin.speedGroups === 'object' ? r.admin.speedGroups : {};
    root.rallies[rid] = r;
    // keep globals in sync (non-destructive)
    root.global.activeRallyId = root.global.activeRallyId || rid;
    root.global.lastRallyId = root.global.lastRallyId || rid;
    return r;
  }

  function __uiGetDayCardValue_(dayIndex1, kind){
    // dayIndex1 is 1-based
    try{
      const host = document.getElementById('daysStripInner');
      if (!host) return '';
      const cols = host.querySelectorAll('.day-col');
      const col = cols && cols.length ? cols[dayIndex1] : null; // col[0] is Speed Limits
      if (!col) return '';
      if (kind === 'date'){
        const el = col.querySelector('input.date, input[type="date"]');
        return el && el.value ? String(el.value) : '';
      }
      if (kind === 'start'){
        const el = col.querySelector('input.time, input[type="time"]');
        const v = el && el.value ? String(el.value) : '';
        return v ? v.slice(0,5) : '';
      }
      if (kind === 'inc'){
        const el = col.querySelector('input.inc');
        const v = el && (el.value !== undefined) ? String(el.value).trim() : '';
        return v;
      }
    }catch(_e){}
    return '';
  }

  function __uiGetSgSpeed_(sgIdx1){
    try{
      // Speed limits inputs are in the first day-col (Speed Limits card)
      const host = document.getElementById('daysStripInner');
      const col0 = host ? host.querySelector('.day-col[data-kind="speed-limits"], .day-col') : null;
      const el = col0 ? col0.querySelector('input.sg-limit.sg'+sgIdx1) : null;
      if (el && el.value !== undefined) return Number(el.value);
    }catch(_e){}
    // fallback to in-memory state
    try{
      const L = state && state.schedule && Array.isArray(state.schedule.speedLimits) ? state.schedule.speedLimits : null;
      if (L && L[sgIdx1-1] != null) return Number(L[sgIdx1-1]);
    }catch(_e){}
    return NaN;
  }

  function __seedMissingDays_(r, dayCount){
    let changed = false;
    const days = r.admin.days;
    for (let i=1;i<=dayCount;i++){
      const k = String(i);
      const d = (days[k] && typeof days[k]==='object') ? days[k] : {};
      if (!days[k]) { days[k]=d; changed = true; }
      // fill missing fields only
      if (d.date == null || d.date === ''){
        const v = (state && state.schedule && Array.isArray(state.schedule.dayDates) && state.schedule.dayDates[i-1]) ? String(state.schedule.dayDates[i-1]) : __uiGetDayCardValue_(i,'date');
        if (v) { d.date = v; changed = true; }
      }
      if (d.start == null || d.start === ''){
        const v0 = (state && state.schedule && Array.isArray(state.schedule.startTimes) && state.schedule.startTimes[i-1]) ? String(state.schedule.startTimes[i-1]) : __uiGetDayCardValue_(i,'start');
        const v = v0 ? v0.slice(0,5) : '';
        if (v) { d.start = v; changed = true; }
      }
      if (d.incMin == null || d.incMin === ''){
        const raw = (state && state.schedule && Array.isArray(state.schedule.incrementsMin) && (state.schedule.incrementsMin[i-1] != null)) ? state.schedule.incrementsMin[i-1] : __uiGetDayCardValue_(i,'inc');
        const n = Number(raw);
        if (Number.isFinite(n)) { d.incMin = n; changed = true; }
      }
    }
    return changed;
  }

  function __seedMissingSpeedGroups_(r, sgCount){
    let changed = false;
    const sgs = r.admin.speedGroups;
    for (let i=1;i<=sgCount;i++){
      const k = String(i);
      const g = (sgs[k] && typeof sgs[k]==='object') ? sgs[k] : {};
      if (!sgs[k]) { sgs[k]=g; changed = true; }
      if (g.speed == null || g.speed === ''){
        const n = __uiGetSgSpeed_(i);
        if (Number.isFinite(n)) { g.speed = Math.round(n); changed = true; }
      }
    }
    return changed;
  }

  function __adminSeedBootLive_(){
    // v2.8.70 — apply pending New Rally title (after reload) and seed fresh TD_RALLIES
    try{
      const pending = sessionStorage.getItem('TD_PENDING_NEW_RALLY_TITLE');
      if (pending){
        sessionStorage.removeItem('TD_PENDING_NEW_RALLY_TITLE');
        const title = String(pending||'').trim() || 'New Rally';
        try{
          const el = document.getElementById('rallyTitlePill');
          if (el){
            el.textContent = title;
            el.classList.remove('muted');
            el.classList.remove('pristine');
            el.classList.add('filled');
          }
        }catch(_e){}
        try{ commitRallyTitleToTd_ && commitRallyTitleToTd_(title); }catch(_e){}
      }
    }catch(_e){}

    try{
      // Runs after BOOT_LIVE (BOOT_MUTE false). Single-write seed.
      if (window.__ADMIN_ENTRIES_BOOTSEEDED__) return;

      const rid = __getRidForAdmin_();

      // Infer UI counts (prefer state, then display text)
      const dayCount = Math.max(1, Math.min(7, Number((state && state.dayCount) || (document.getElementById('daysDisplayText') && document.getElementById('daysDisplayText').textContent) || 1) || 1));
      const sgCount  = Math.max(1, Math.min(4, Number((state && state.sgCount)  || (document.getElementById('sgDisplayText')  && document.getElementById('sgDisplayText').textContent)  || 1) || 1));

      // Only seed if TD_RALLIES missing OR admin.entries missing for this rid.
      const existing = __tdGetExistingRoot_();
      
      if (!existing) return; // No TD_RALLIES yet; title commit is the generator.
const hasEntriesAlready = (()=>{
        try{
          if (!existing) return false;
          const r = existing.rallies && existing.rallies[rid];
          const a = r && r.admin;
          return !!(a && (a.entries || a.rows));
        }catch(_e){ return false; }
      })();
      if (hasEntriesAlready) { 
        // Bake 1: if store already has admin entries, grow UI row skeleton to match (no writes).
        try{
          const r0 = existing && existing.rallies && existing.rallies[rid];
          const a0 = r0 && r0.admin;
          const arr0 = (a0 && Array.isArray(a0.entries)) ? a0.entries
                     : (a0 && Array.isArray(a0.rows)) ? a0.rows : null;
          if (arr0 && arr0.length) {
            __ensureStateRowsCount_(arr0.length);
            if (typeof window.render === 'function') window.render();
          }
        }catch(_e){}
 
        window.__ADMIN_ENTRIES_BOOTSEEDED__ = true;
return; 
      }

      __adminTdWrite_(rid, (root, r)=>{
        // Ensure counts exist
        r.admin.ui.dayCount = (r.admin.ui.dayCount == null) ? dayCount : r.admin.ui.dayCount;
        r.admin.ui.sgCount  = (r.admin.ui.sgCount  == null) ? sgCount  : r.admin.ui.sgCount;

        // Ensure admin branches exist
        if (!r.admin.days || typeof r.admin.days !== 'object') r.admin.days = {};
        if (!r.admin.speedGroups || typeof r.admin.speedGroups !== 'object') r.admin.speedGroups = {};

        // Seed missing day/sg slots (no overwrite)
        try{ __seedMissingDays_(r, dayCount); }catch(_e){}
        try{ __seedMissingSpeedGroups_(r, sgCount); }catch(_e){}
        // Seed entries snapshot from current UI rows 1..n if missing.
        if (!r.admin.entries) {
          try{ r.admin.entries = __buildAdminRowsPayload_(); }catch(_e){ r.admin.entries = []; }
        }
}, { branch:'admin.seed', reason:'seed_boot_entries' });

      window.__ADMIN_ENTRIES_BOOTSEEDED__ = true;
    }catch(_e){}
  }

  function __adminDayCountCommit_(dayCount){
    try{
      dayCount = Math.max(1, Math.min(7, Number(dayCount)||1));

      // rAF + rAF settle
      try{
        if (window.__dayCountSettleRaf1){ cancelAnimationFrame(window.__dayCountSettleRaf1); window.__dayCountSettleRaf1 = 0; }
        if (window.__dayCountSettleRaf2){ cancelAnimationFrame(window.__dayCountSettleRaf2); window.__dayCountSettleRaf2 = 0; }
      }catch(_e){}

      window.__dayCountSettleRaf1 = requestAnimationFrame(()=>{
        window.__dayCountSettleRaf2 = requestAnimationFrame(()=>{
          try{
            const rid = __getRidForAdmin_();
            const res = __adminTdWrite_(rid, (root, r)=>{
              if (!r.admin.ui || typeof r.admin.ui !== 'object') r.admin.ui = {};
              r.admin.ui.dayCount = dayCount;
              __seedMissingDays_(r, dayCount);

              // Day semantics: Day1 is mandatory; Day2-7 are optional.
              // When dayCount is reduced, prune optional days above dayCount so the store reflects reality.
              try{
                if (r.admin && r.admin.days && typeof r.admin.days === 'object'){
                  for (const k of Object.keys(r.admin.days)){
                    const n = Number(k);
                    if (Number.isFinite(n) && n > dayCount) delete r.admin.days[k];
                  }
                }
              }catch(_e2){}
            }, { branch:'admin.ui', reason:'day_count_seed' });

            if (!res || !res.ok) return;
            emitTdChangedDebounced_('admin.days.count', { rid, branch:'admin.days', reason:'day_count', rev: res.rev }, 0);
          }catch(_e){}
        });
      });
    }catch(_e){}
  }

  function __adminSgCountCommit_(sgCount){
    try{
      sgCount = Math.max(1, Math.min(4, Number(sgCount)||1));

      const rid = __getRidForAdmin_();
      const res = __adminTdWrite_(rid, (root, r)=>{
        if (!r.admin.ui || typeof r.admin.ui !== 'object') r.admin.ui = {};
        r.admin.ui.sgCount = sgCount;
        __seedMissingSpeedGroups_(r, sgCount);

        // SG semantics: SG1 is mandatory; SG2–SG4 are optional.
        // When sgCount is reduced, prune optional groups above sgCount so the store reflects reality.
        try{
          if (r.admin && r.admin.speedGroups && typeof r.admin.speedGroups === 'object'){
            for (const k of Object.keys(r.admin.speedGroups)){
              const n = Number(k);
              if (Number.isFinite(n) && n > sgCount) delete r.admin.speedGroups[k];
            }
          }
        }catch(_e2){}
        // v2.8.94 — When SG count changes, normalize stored entrants and rebuild the Controls feed
        try{
          if (Array.isArray(r.admin && r.admin.entries ? r.admin.entries : null)){
            for (let i=0; i<r.admin.entries.length; i++){
              const row = r.admin.entries[i];
              if (!row || typeof row !== 'object') continue;
              const v = Number(row.speedGroup);
              let sg = Number.isFinite(v) ? Math.round(v) : 1;
              sg = Math.max(1, Math.min(sgCount, sg));
              row.speedGroup = sg;
            }
          }
        }catch(_e3){}

        try{
          if (typeof __buildControlsRowsForDay_ === 'function'){
            if (!r.admin.controls || typeof r.admin.controls !== 'object') r.admin.controls = {};
            const uiDayCount = (r.admin && r.admin.ui) ? Number(r.admin.ui.dayCount) : NaN;
            let dayCount = Number.isFinite(uiDayCount) ? uiDayCount : 1;
            dayCount = Math.max(1, Math.min(9, Math.round(dayCount)));
            r.admin.controls.days = (r.admin.controls.days && typeof r.admin.controls.days === 'object') ? r.admin.controls.days : {};
            for(let d=0; d<dayCount; d++){
              const dayKey = String(d+1);
              const dayObj = (r.admin.controls.days[dayKey] && typeof r.admin.controls.days[dayKey] === 'object') ? r.admin.controls.days[dayKey] : {};
              dayObj.entries = __buildControlsRowsForDay_(d, r.admin.entries, r.admin.speedGroups);
              r.admin.controls.days[dayKey] = dayObj;
            }
            r.admin.controls.entries = (r.admin.controls.days["1"] && Array.isArray(r.admin.controls.days["1"].entries)) ? r.admin.controls.days["1"].entries : [];
            r.admin.controls.meta = Object.assign({}, (r.admin.controls.meta||{}), {
              updatedAtMs: Date.now(),
              rowCount: Array.isArray(r.admin.controls.entries) ? r.admin.controls.entries.length : 0
            });
          }
        }catch(_e4){}

      }, { branch:'admin.ui', reason:'sg_count_seed' });

      if (!res || !res.ok) return;
      emitTdChangedDebounced_('admin.speedGroups.sg_count', { rid, branch:'admin.speedGroups', reason:'sg_count', rev: res.rev }, 0);
    }catch(_e){}
  }


  // Listen for cross-tab messages (to prove no echo loops; we only log receipt for now)
  try{
    const bc = __tdEnsureBC_();
    if (bc){
      bc.onmessage = (ev)=>{
        try{
          const d = ev && ev.data ? ev.data : null;
          if (!d) return;
          // Do NOT re-emit (avoid echo loops). Just log receipt.
        }catch(_e){}
      };
    }
  }catch(_e){}


  // Schema contract (compat): TD_RALLIES root shape (informational; engine will enforce later).
  const TD_SCHEMA = {
    version: '0.3',
    global: {
      activeRallyId: 'RID-*',
      lastRallyId: 'RID-*',
      // Optional: titleIndex / other global helpers
    },
    rallies: {
      'RID-*': {
        meta: { title: 'string', issue: 'rNNN' },
        admin: {
          ui: { dayCount: '1..7', sgCount: '1..4', sortMode: 'string' },
          days: { '1..7': { date:'YYYY-MM-DD', start:'HH:MM', incMin:'number' } },
          speedGroups: { '1..4': { speed:'number' } },

          // Truth: entrant records (NO rallyNo / startTime stored here)
          entries: [
            '{ entryId, driverFirst, driverSurname, navFirst, navSurname, mobile, email, make, year, sgIdx }'
          ],

          // Truth: defines Rally No order across pages (Rally No = index+1)
          order: [ 'entryId...' ]
        },

        // Controls-only view/cache (generated from admin truth; read by Controls)
        controls: {
          days: {
            '1..7': {
              rows: [
                '{ rallyNo, driverSurname, sgIdx, startTime }'
              ]
            }
          }
        }

        // schedule/results/etc. own their branches
      }
    }
  };


// Tiny pure helpers (no side effects)
  // Clamp year input (blank-safe). Used by validate() and paste/row ops.
  function clampYear(val){
    const s = String(val ?? '').trim();
    if(!s) return '';
    let y = parseInt(s, 10);
    if(!Number.isFinite(y)) return '';
    const nowY = new Date().getFullYear();
    const minY = 1900;
    const maxY = nowY + 1;
    if(y < minY) y = minY;
    if(y > maxY) y = maxY;
    return String(y);
  }

// UI-only bootstrap: keep legacy UI code alive while engine-room is rebuilt
  window.state = window.state || {};
  const state = window.state;
  if (!('tableSortState' in state)) state.tableSortState = 'none';
  if (!state.schedule) state.schedule = {};
  if (!Array.isArray(state.schedule.startTimes)) state.schedule.startTimes = ['08:30:00'];
  if (!Array.isArray(state.schedule.incrementsMin)) state.schedule.incrementsMin = [1.0];
  if (!Array.isArray(state.rows)) state.rows = [];


  /* ===============================
     ER4a (v2.6.93) — truth-only commit funnel
     - JS in-memory state is the single source of truth
     - DOM is view/editor only
     - All cell commits must route through adminCommitCell(...)
     - No behaviour change: this only centralises mutation points
     =============================== */
  function adminCommitCell(rowSrcIndex, field, value){
    try{
      if (!window.state || !Array.isArray(window.state.rows)) return;
      const rows = window.state.rows;
      const idx = Number(rowSrcIndex);
      if (!Number.isFinite(idx) || idx < 0 || idx >= rows.length) return;
      const r = rows[idx];
      if (!r) return;
      const v = (value==null) ? '' : value;

      switch(String(field||'')){
        case 'driverFirst':
          r.driver = r.driver || {};
          r.driver.first = String(v);
          break;
        case 'driverSurname':
          r.driver = r.driver || {};
          r.driver.last = String(v);
          break;
        case 'navFirst':
          r.navigator = r.navigator || {};
          r.navigator.first = String(v);
          break;
        case 'navSurname':
          r.navigator = r.navigator || {};
          r.navigator.last = String(v);
          break;
        case 'mobile':
          r.driver = r.driver || {};
          r.driver.mobile = String(v);
          break;
        case 'email':
          r.driver = r.driver || {};
          r.driver.email = String(v);
          break;
        case 'make':
          r.car = r.car || {};
          r.car.make = String(v);
          break;
        case 'year':
          r.car = r.car || {};
          r.car.year = String(v);
          break;
        case 'speedGroup':{
          const maxG = Math.max(1, Number((window.state.schedule && window.state.schedule.speedGroups) || 1));
          const sg = Math.max(1, Math.min(maxG, Number(v)||1));
          r.speedGroup = sg;
          break;
        }
        default:
          // Unknown field: do nothing (safety)
          break;
      }
    }catch(_e){}
  }

function renderSpeedLimitsCard(){
  // Ensure array length and monotone defaults
  let L = (state.schedule.speedLimits || [90,80,70,60]).slice(0,4);
  while(L.length<4){ L.push(60); }
  // Enforce G1 >= G2 >= G3 >= G4 within 6..120
  function clamp(v, hi){ v = Math.round(+v||0); hi = (hi==null?120:hi); return Math.max(6, Math.min(hi, v)); }
  L[0]=clamp(L[0],150);
  for(let i=1;i<4;i++){ L[i]=clamp(L[i],120); if(L[i] > L[i-1]) L[i]=L[i-1]; }
  state.schedule.speedLimits = L;

  const col=document.createElement('div'); col.className='day-col';
  const grid=document.createElement('div'); grid.className='day-grid';

  const count = Math.max(1, Math.min(4, +state.schedule.speedGroups||1));
  col.dataset.kind = 'speed-limits';
  for(let i=0; i<4; i++){
    const f=document.createElement('div'); f.className='day-field';
    f.dataset.sg = String(i+1);
    if(i>=count) f.style.display='none';
    const lab=document.createElement('div'); lab.className='label'; lab.textContent='Speed Group ' + (i+1);
    const inp=document.createElement('input'); 
    inp.type='number'; inp.className='inc sg-limit';
    inp.classList.add('sg' + (i+1)); 
    inp.min='6'; inp.max=(i===0?'150':'120'); inp.step='1'; 
    inp.value = state.schedule.speedLimits[i];
    const handle = ()=>{
  const L2 = state.schedule.speedLimits.slice(0,4);
  let v = Math.round(+inp.value||0);
  v = Math.max(6, Math.min(120, v));
  if(i>0){ v = Math.min(v, L2[i-1]); }
  L2[i] = v;
  for(let j=i+1;j<4;j++){ if(L2[j] > L2[j-1]) L2[j] = L2[j-1]; }
  state.schedule.speedLimits = L2;
  // Avoid full Days strip rebuild (it causes multi-write bursts). Instead, update the visible Speed Limits inputs in-place.
  try {
    const host = document.getElementById('daysStripInner');
    const card = host && host.querySelector('.day-col'); // first col is Speed Limits card
    const ins = card && card.querySelectorAll('input.sg-limit');
    if (ins && ins.length) {
      ins.forEach((el, idx)=>{ if (idx < 4 && state.schedule.speedLimits[idx] != null) el.value = state.schedule.speedLimits[idx]; });
    }
  } catch(e) { /* no-op */ }
  // Signals-only: broadcast SG speed change (no LS writes)
  try{
  const _w = (typeof commitAdminSpeedGroupToTd_ === 'function') ? commitAdminSpeedGroupToTd_((i+1), v) : null;
  const _rid = (_w && _w.rid) ? _w.rid : (window.__ACTIVE_RID__ || 'RID-DEV');
  const _rev = (_w && Number.isFinite(_w.rev)) ? _w.rev : undefined;
  emitTdChangedDebounced_('admin.speedGroups.sg_speed.'+(i+1), (_rev===undefined?{ rid:_rid, branch:'admin.speedGroups', reason:'sg_speed', sg:(i+1), speed:v, sigExtra:('sg'+(i+1)) }:{ rid:_rid, branch:'admin.speedGroups', reason:'sg_speed', sg:(i+1), speed:v, rev:_rev, sigExtra:('sg'+(i+1)) }), 140);
}catch(_e){}
  if (typeof render === 'function') render();
  };
inp.addEventListener('input', handle);
inp.addEventListener('change', handle);
f.appendChild(lab); f.appendChild(inp); grid.appendChild(f);
  
    // v2.8.81: add +/- buttons (v2.8.68 layout) to SG speed pills
    try{ pmWrapInput(inp); }catch(_e){}
}
  col.appendChild(grid);
  return col;
}

function cascadeDayDatesFrom(dayIndex){
  try {
    const host = document.getElementById('daysStripInner');
    if (!host) return;
    const cols = host.querySelectorAll('.day-col');
    // index 0 is the Speed Limits card, so days start at 1
    const startColIndex = dayIndex + 1;
    if (startColIndex < 1 || startColIndex >= cols.length) return;
    const startCol = cols[startColIndex];
    if (!startCol) return;
    const startInput = startCol.querySelector('input.date');
    if (!startInput || !startInput.value) return;

    const base = new Date(startInput.value);
    if (isNaN(base.getTime())) return;

    if (!state.schedule) state.schedule = {};
    if (!Array.isArray(state.schedule.dayDates)) state.schedule.dayDates = [];

    const totalDays = state.schedule.days || (cols.length - 1);
    if (state.schedule.dayDates.length < totalDays) {
      state.schedule.dayDates.length = totalDays;
    }

    // store anchor
    state.schedule.dayDates[dayIndex] = startInput.value;

    for (let idx = startColIndex + 1; idx < cols.length; idx++) {
      const col = cols[idx];
      const inp = col.querySelector('input.date');
      if (!inp) continue;
      const offset = idx - startColIndex;
      const d = new Date(base);
      d.setDate(d.getDate() + offset);
      const iso = d.toISOString().slice(0, 10);
      inp.value = iso;
      state.schedule.dayDates[idx - 1] = iso;
    }

    // v2.8.91 — Persist cascaded day dates to TD_RALLIES (single commit, dates only).
    try{
      const rid = (typeof __getRidForAdmin_ === 'function') ? __getRidForAdmin_() : String(window.__ACTIVE_RID__ || 'RID-DEV');
      const fromIdx = Math.max(0, Number(dayIndex)||0) + 1; // persist days AFTER the edited anchor (anchor is already committed by the caller)
      const maxIdx = Math.min((Number(totalDays)||0) - 1, (state && state.schedule && Array.isArray(state.schedule.dayDates)) ? (state.schedule.dayDates.length - 1) : -1);
      if (rid && Number.isFinite(fromIdx) && Number.isFinite(maxIdx) && maxIdx >= fromIdx){
        __adminTdWrite_(rid, (root, r)=>{
          r.admin.days = r.admin.days || {};
          for (let i = fromIdx; i <= maxIdx; i++){
            const dayKey = String(i + 1);
            const date = (state && state.schedule && Array.isArray(state.schedule.dayDates)) ? String(state.schedule.dayDates[i] || '') : '';
            if (!r.admin.days[dayKey] || typeof r.admin.days[dayKey] !== 'object') r.admin.days[dayKey] = {};
            r.admin.days[dayKey].date = date;
          }
        }, { branch:'admin.days', reason:'cascade_day_dates' });
      }
    }catch(_e){}

  } catch(e) {
    // no-op
  }
}


// v2.4.69 — DOMContentLoaded gate: no DOM writes + no TD_RALLIES hydrate before DOM is ready.
window.__DOM_READY__ = (document.readyState !== 'loading');
window.__RENDER_DAYS_PENDING__ = false;
window.__RENDER_DAYS_SCHEDULED__ = false;
document.addEventListener('DOMContentLoaded', ()=>{
  window.__DOM_READY__ = true;

  // v2.8.96 — Normal/Compact view (screen only)
  try{
    const btn = document.getElementById('viewModeBtn');
    const KEY = 'TD_ADMIN_VIEW_COMPACT';
    const apply = (on)=>{
      try{ document.body.classList.toggle('td-compact', !!on); }catch(_e){}
      try{
        if(btn){
          btn.setAttribute('aria-pressed', on ? 'true':'false');
          btn.textContent = on ? 'Compact' : 'Normal';
        }
      }catch(_e){}
    };
    if(btn){
      btn.addEventListener('click', ()=>{
        const on = !document.body.classList.contains('td-compact');
        try{ localStorage.setItem(KEY, on ? '1':'0'); }catch(_e){}
        apply(on);
      });
      let stored = null;
      try{ stored = localStorage.getItem(KEY); }catch(_e){}
      apply(stored === '1');
    }
  }catch(_e){}

  // v2.8.34 — Entries button gate on boot (TD_RALLIES present only).
  try{ if (typeof window._setEntriesBtnGate_ === 'function') window._setEntriesBtnGate_(); }catch(_e){}

  // v2.8.13 — Include Start Delays: re-render Start Time columns when toggled.
  try{
    const __isd = document.getElementById('includeStartDelaysChk');
    if (__isd){
      __isd.addEventListener('change', ()=>{
        try{ if (window.state) window.state.__startDelayCache = null; }catch(_e){}
        try{ render(); }catch(_e){}
        // v2.8.91 — after toggle settles, persist Admin-owned controls start times (day-based)
        try{
          setTimeout(()=>{
            try{
              const __rid = (typeof __getRidForAdmin_ === 'function') ? __getRidForAdmin_() : String(window.__ACTIVE_RID__ || 'RID-DEV');
              if (typeof __adminTdWrite_ === 'function'){
                __adminTdWrite_(__rid, ()=>{}, { branch:'admin.controls', reason:'start_delays_toggle', branches:['admin.controls'] });
              }
            }catch(_e){}
          }, 180);
        }catch(_e){}
      });
    }
  }catch(_e){}
  // v2.5.88 — Rally Title pill: placeholder→filled styling + select-all on focus + clear pristine on commit
  try{
    const __rtp = document.getElementById('rallyTitlePill');
    if (__rtp){
      const __TITLE_PLACEHOLDER__ = 'Enter Rally Title';
      const __syncTitlePillState = ()=>{
        try{
          const t = (__rtp.textContent||'').trim();
          const isPlaceholder = (t === __TITLE_PLACEHOLDER__);
          const filled = (t.length>0 && !isPlaceholder);
          __rtp.classList.toggle('filled', !!filled);
          __rtp.classList.toggle('muted', !!isPlaceholder);
        }catch(_e){}
      };

      // confirm title prior to first commit (prevents accidental TD_RALLIES seed)
      let __tcOpen = false;
      let __tcPending = '';
      const __tcModal = document.getElementById('titleConfirmModal');
      const __tcTitle = document.getElementById('tcTitleText');
      const __tcBack  = document.getElementById('tcBackBtn');
      const __tcOk    = document.getElementById('tcConfirmBtn');
      const __tcBd    = document.getElementById('tcBackdrop');

      const __closeTitleConfirm_ = ()=>{
        try{
          if (__tcModal) __tcModal.style.display = 'none';
          __tcOpen = false;
          window.__TITLE_CONFIRM_OPEN__ = false;
        }catch(_e){}
      };

      const __openTitleConfirm_ = (title)=>{
        try{
          if (!__tcModal || !__tcTitle) return false;
          __tcPending = String(title||'').trim();
          __tcTitle.textContent = __tcPending || '';
          __tcModal.style.display = 'block';
          __tcOpen = true;
          window.__TITLE_CONFIRM_OPEN__ = true;
          setTimeout(()=>{ try{ (__tcOk||__tcBack||__tcModal).focus && (__tcOk||__tcBack||__tcModal).focus(); }catch(_e){} }, 0);
          return true;
        }catch(_e){}
        return false;
      };

      // Wire modal buttons once
      try{
        if (__tcBack && !__tcBack.__wired){
          __tcBack.__wired = true;
          __tcBack.addEventListener('click', ()=>{
            try{
              __closeTitleConfirm_();
              // keep typed text; return focus to pill for editing
              setTimeout(()=>{ try{ __rtp.focus(); try{ const sel=window.getSelection&&window.getSelection(); if(sel){ sel.removeAllRanges(); const r=document.createRange(); r.selectNodeContents(__rtp); sel.addRange(r); } }catch(_e){} }catch(_e){} }, 0);
            }catch(_e){}
          });
        }
        if (__tcOk && !__tcOk.__wired){
          __tcOk.__wired = true;
          __tcOk.addEventListener('click', ()=>{
            try{
              const t = String(__tcPending||'').trim();
              __closeTitleConfirm_();
              if (t){
                __rtp.classList.remove('pristine');
                try{ commitRallyTitleToTd_ && commitRallyTitleToTd_(t); }catch(_e){}
                try{ window._setEntriesBtnGate_ && window._setEntriesBtnGate_(); }catch(_e){}
                __syncTitlePillState();
                try{ __rtp.blur && __rtp.blur(); }catch(_e){}
              }
            }catch(_e){}
          });
        }
        if (__tcBd && !__tcBd.__wired){
          __tcBd.__wired = true;
          __tcBd.addEventListener('click', ()=>{ try{ __tcBack && __tcBack.click(); }catch(_e){} });
        }
      }catch(_e){}
      // modal keyboard shortcuts (Esc=Back, Enter=Confirm)
      try{
        if (!document.__tcKeyWired){
          document.__tcKeyWired = true;
          document.addEventListener('keydown', (e)=>{
            try{
              if (!__tcOpen) return;
              if (e.key === 'Escape'){
                e.preventDefault();
                e.stopPropagation();
                __tcBack && __tcBack.click();
                return;
              }
              if (e.key === 'Enter'){
                // confirm from modal
                e.preventDefault();
                e.stopPropagation();
                __tcOk && __tcOk.click();
                return;
              }
            }catch(_e){}
          }, true);
        }
      }catch(_e){}


      // UI-only: after any hydrate, ensure pristine ring reflects actual stored/visible title
      const __normalizePristineUI_ = ()=>{
        try{
          const t = (__rtp.textContent||'').trim();
          const filled = (t.length>0 && t !== __TITLE_PLACEHOLDER__);
          __rtp.classList.toggle('pristine', !filled);
        }catch(_e){}
      };

      // Future-proof hook: pages that hydrate from TD_RALLIES may dispatch this event when done.
      window.addEventListener('TD_RALLIES_HYDRATE_DONE', ()=>{ try{ __normalizePristineUI_(); }catch(_e){} }, true);

      __syncTitlePillState();
      __rtp.addEventListener('input', __syncTitlePillState);
      let __rtpFocusSeq = 0; // guard against post-focus caret timer re-arming after blur

      __rtp.addEventListener('keydown', (e)=>{
        try{
          if (!e) return;
          if (e.key === 'Enter') { e.preventDefault(); try{ e.stopPropagation(); }catch(_e){}; setTimeout(()=>{ try{ __rtp.blur(); }catch(_e){} }, 0); return; }
          if (e.key === 'Escape') {
            e.preventDefault();
            try{ e.stopPropagation(); }catch(_e){}
            __rtp.textContent = __TITLE_PLACEHOLDER__;
            __rtp.classList.add('pristine');
            __syncTitlePillState();
            __rtp.blur();
            return;
          }
        }catch(_e){}
      });
      __rtp.addEventListener('blur', ()=>{
        try{ __rtpFocusSeq++; }catch(_e){}

        try{
          if (__tcOpen || window.__TITLE_CONFIRM_OPEN__) { __syncTitlePillState(); return; }

          const t = (__rtp.textContent||'').trim();
          const filled = (t.length>0 && t !== __TITLE_PLACEHOLDER__);
          if (!filled){
            // restore placeholder + keep pristine
            __rtp.textContent = __TITLE_PLACEHOLDER__;
            __rtp.classList.add('pristine');
          }else{
            // If TD_RALLIES does not yet exist OR title differs from last committed title, confirm before commit/update
            let hasStore = false;
            let storeTitle = '';
            try{
              const raw = localStorage.getItem('TD_RALLIES');
              hasStore = !!(raw && String(raw).length>0);
            }catch(_e){}

            if (hasStore){
              try{
                const rid = (typeof __getRidForAdmin_ === 'function') ? __getRidForAdmin_() : String(window.__ACTIVE_RID__ || 'RID-DEV');
                const root = (typeof _lsReadTdObjSafe_ === 'function') ? _lsReadTdObjSafe_() : null;
                const r = root && root.rallies ? root.rallies[rid] : null;
                storeTitle = r && r.meta && typeof r.meta.title === 'string' ? r.meta.title.trim() : '';
              }catch(_e){}
            }

            const needsConfirm = (!hasStore) || (!storeTitle) || (storeTitle !== t);
            if (needsConfirm){
              // Keep pristine until user confirms
              __openTitleConfirm_(t);
              __syncTitlePillState();
              return;
            }


// committed real title: clear pristine ring
            __rtp.classList.remove('pristine');
            try{ commitRallyTitleToTd_ && commitRallyTitleToTd_(t); }catch(_e){}
          }
        }catch(_e){}
        __syncTitlePillState();
      });

      __rtp.addEventListener('focus', ()=>{
        try{
          const t = (__rtp.textContent||'').trim();
          if (t === __TITLE_PLACEHOLDER__){
            __rtp.textContent = '';
          }
        }catch(_e){}
        __syncTitlePillState();

        const __seq = ++__rtpFocusSeq;

        // Place caret ready for typing (no select-all).
        setTimeout(()=>{
          try{
            if (document.activeElement !== __rtp) return;
            if (__seq !== __rtpFocusSeq) return;
          }catch(_e){}

          try{
            const sel = window.getSelection && window.getSelection();
            if (!sel) return;
            const range = document.createRange();
            range.selectNodeContents(__rtp);
            range.collapse(true);
            sel.removeAllRanges();
            sel.addRange(range);
          }catch(_e){}
        }, 0);
      });
    }
  }catch(_e){}
  if (window.__RENDER_DAYS_PENDING__ && !window.__RENDER_DAYS_SCHEDULED__){
    window.__RENDER_DAYS_SCHEDULED__ = true;
    setTimeout(()=>{ try{ renderDays(); }catch(_e){} }, 0);
  }
}, { once:true });

// v2.5.80 — seed day dates from machine date when empty (UI defaults only; no LS writes / no broadcasts)
function seedDayDatesIfEmpty_(){
  try{
    if (!state || !state.schedule) return;

    // Prefer state value, but fall back to UI selector (boot can run before state is updated).
    const uiDays = (()=>{ try{
      const t = String((document.getElementById('daysDisplayText')||{}).textContent||'').trim();
      return Number(t);
    }catch(_){ return NaN; } })();
    const days = Math.max(1, Number(state.schedule.days || uiDays || 1));

    const dayDatesIn = Array.isArray(state.schedule.dayDates) ? state.schedule.dayDates.slice() : [];
    const hasDay1 = String(dayDatesIn[0]||'').trim();

    // Base date: Day 1 if present/valid, else machine today (local).
    let base = new Date();
    if (hasDay1){
      const d1 = new Date(String(dayDatesIn[0]).trim());
      if (!isNaN(d1.getTime())) base = d1;
    }

    const out = new Array(days);

    for(let i=0;i<days;i++){
      const existing = String(dayDatesIn[i]||'').trim();
      if (existing){
        out[i] = existing; // do not overwrite user/stored values
        continue;
      }
      const d = new Date(base);
      d.setDate(base.getDate()+i);
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const da = String(d.getDate()).padStart(2,'0');
      out[i] = `${y}-${m}-${da}`;
    }

    state.schedule.dayDates = out;
  }catch(e){
    /* no-op */
  }
}


function renderDays(){
    // v2.4.69 — hard gate: no-op until DOMContentLoaded; coalesce to one deferred render
    if (!window.__DOM_READY__ && document.readyState === 'loading') {
      window.__RENDER_DAYS_PENDING__ = true;
      return;
    }
    window.__DOM_READY__ = true;
    if (window.__renderDaysRunning) { window.__renderDaysQueued = true; return; }
    window.__renderDaysRunning = true;
    try{ window.__bootlog && window.__bootlog('renderDays:ENTER', {days: (document.getElementById('daysDisplayText')||{}).textContent||null, sgs: (document.getElementById('sgDisplayText')||{}).textContent||null}); }catch(e){}
    try {
    // Defaults: if no stored dates (or only Day 1 exists), seed/cascade across days (UI only)
    seedDayDatesIfEmpty_();
    daysStripInner.innerHTML='';
    // Insert Speed Group Limits card first
    daysStripInner.appendChild(renderSpeedLimitsCard());
    const days=state.schedule.days;
    for(let d=0; d<days; d++){
      const col=document.createElement('div'); col.className='day-col';
      const title=document.createElement('div'); title.className='day-title'; title.textContent=`Day ${d+1}`; col.appendChild(title);
      const grid=document.createElement('div'); grid.className='day-grid';
      const f0=document.createElement('div'); f0.className='day-field'; f0.innerHTML='<div class="label">Date</div>'; const wrap0=document.createElement('div'); wrap0.className='input-wrap'; const dateInp=document.createElement('input'); dateInp.type='date'; dateInp.className='date'; wrap0.appendChild(dateInp);
      if (Array.isArray(state.schedule.dayDates) && state.schedule.dayDates[d]) {
        dateInp.value = state.schedule.dayDates[d];
      }
      dateInp.addEventListener('change', function(){
        if (!Array.isArray(state.schedule.dayDates)) state.schedule.dayDates = [];
        state.schedule.dayDates[d] = dateInp.value || '';
        if (dateInp.value && typeof cascadeDayDatesFrom === 'function') {
          cascadeDayDatesFrom(d);
        }
        (function(){
          const _w = (typeof commitAdminDayToTd_ === 'function') ? commitAdminDayToTd_(d, 'day_date') : null;
          const _rid = (_w && _w.rid) ? _w.rid : (window.__ACTIVE_RID__ || 'RID-DEV');
          const _rev = (_w && Number.isFinite(_w.rev)) ? _w.rev : undefined;
          emitTdChangedDebounced_('admin.days.date.'+d, (_rev===undefined?{ rid:_rid, branch:'admin.days', reason:'day_date', day:(d+1) }:{ rid:_rid, branch:'admin.days', reason:'day_date', day:(d+1), rev:_rev }), 120);
        })();
        });  f0.appendChild(wrap0); grid.appendChild(f0); const f1=document.createElement('div'); f1.className='day-field'; f1.innerHTML='<div class="label">Start Time</div>';
      const t=document.createElement('input'); t.type='time'; t.step='1'; t.value=(state.schedule.startTimes[d]||'08:30:00').slice(0,8);
      // v2.7.15: seed shown defaults into state (prevents Day N falling back to Day 1 silently)
      if (!Array.isArray(state.schedule.startTimes)) state.schedule.startTimes = [];
      if (state.schedule.startTimes[d] == null || String(state.schedule.startTimes[d]).trim() === '') state.schedule.startTimes[d] = t.value;

      t.addEventListener('change', ()=>{
        let v = String(t.value||'').trim();
        if(v && v.length===5) v = v + ':00';
        state.schedule.startTimes[d] = v || '';
        if (typeof recomputeAllStartTimes==='function') recomputeAllStartTimes();
        (function(){
          const _w = (typeof commitAdminDayToTd_ === 'function') ? commitAdminDayToTd_(d, 'start_time') : null;
          const _rid = (_w && _w.rid) ? _w.rid : (window.__ACTIVE_RID__ || 'RID-DEV');
          const _rev = (_w && Number.isFinite(_w.rev)) ? _w.rev : undefined;
          emitTdChangedDebounced_('admin.days.start.'+d, (_rev===undefined?{ rid:_rid, branch:'admin.days', reason:'start_time', day:(d+1) }:{ rid:_rid, branch:'admin.days', reason:'start_time', day:(d+1), rev:_rev }), 120);
        })();
      });
      t.addEventListener('input', ()=>{ });
      const wrap1=document.createElement('div'); wrap1.className='input-wrap'; wrap1.appendChild(t);  f1.appendChild(wrap1); grid.appendChild(f1);

      const f2=document.createElement('div'); f2.className='day-field inc'; f2.innerHTML='<div class="label">Increment Min</div>';
      const inc=document.createElement('input'); inc.type='number'; inc.className='inc inc-min'; inc.step='0.5'; inc.min='0'; inc.max='9.5';
      inc.value=String((state.schedule.incrementsMin[d] ?? 1.0).toFixed(1));
      // v2.7.15: seed shown default increment into state (do not overwrite valid 0)
      if (!Array.isArray(state.schedule.incrementsMin)) state.schedule.incrementsMin = [];
      if (state.schedule.incrementsMin[d] == null) state.schedule.incrementsMin[d] = Number(inc.value);

      inc.addEventListener('change', ()=>{ state.schedule.incrementsMin[d]=window.clampIncMin(inc.value); inc.value=Number(state.schedule.incrementsMin[d]).toFixed(1); recomputeAllStartTimes();  });
      
      // v2.3.91: spinner-only controls (disable typing & paste; allow arrows and spinner buttons)
      inc.addEventListener('keydown', (e)=>{
        const allowed = ['ArrowUp','ArrowDown','Tab'];
        if (!allowed.includes(e.key)) { e.preventDefault(); }
      });
      inc.addEventListener('paste', (e)=>{ e.preventDefault(); });
      inc.addEventListener('wheel', (e)=>{ e.preventDefault(); }, { passive:false });
      // Extra safety: clamp & snap to step on input as well
      function clampInc(){
        let v = Number(inc.value);
        if (!isFinite(v)) v = Number(state.schedule.incrementsMin[d] ?? 1.0);
        if (v < 0) v = 0;
        if (v > 9.5) v = 9.5;
        v = Math.round(v * 2) / 2; // snap to 0.5 steps
        inc.value = Number(v).toFixed(1);
        state.schedule.incrementsMin[d] = v;
      }

      inc.addEventListener('input', ()=>{ clampInc(); if (typeof recomputeAllStartTimes==='function') recomputeAllStartTimes();  (function(){
          const _w = (typeof commitAdminDayToTd_ === 'function') ? commitAdminDayToTd_(d, 'increment_min') : null;
          const _rid = (_w && _w.rid) ? _w.rid : (window.__ACTIVE_RID__ || 'RID-DEV');
          const _rev = (_w && Number.isFinite(_w.rev)) ? _w.rev : undefined;
          emitTdChangedDebounced_('admin.days.inc.'+d, (_rev===undefined?{ rid:_rid, branch:'admin.days', reason:'increment_min', day:(d+1) }:{ rid:_rid, branch:'admin.days', reason:'increment_min', day:(d+1), rev:_rev }), 120);
        })(); });
    f2.appendChild(inc);
      // v2.8.81: add +/- buttons (v2.8.68 layout) to Increment Min pill
      try{ pmWrapInput(inc); }catch(_e){}
      grid.appendChild(f2);
      col.appendChild(grid); daysStripInner.appendChild(col);
    }
  
    } finally {
      try{ window.__bootlog && window.__bootlog('renderDays:EXIT', {sgInputs: document.querySelectorAll('#daysStripInner input[id^=\"sg\"][id$=\"Value\"]').length, incInputs: document.querySelectorAll('#daysStripInner input[data-role=\"inc\"]').length}); }catch(e){}
      window.__renderDaysRunning = false;
      if (window.__renderDaysQueued) { window.__renderDaysQueued = false; renderDays(); }
    }

    // keep entries header aligned with day count
    syncEntriesHeaderToDays_();

    // v2.5.80 — after rendering day cards, ensure Day 1 default cascades through visible days when later days are blank.
    try{
      if (typeof seedDayDatesIfEmpty_ === 'function') seedDayDatesIfEmpty_();
      const daysN = Math.max(1, Number(state && state.schedule && state.schedule.days) || 1);
      const dd = (state && state.schedule && Array.isArray(state.schedule.dayDates)) ? state.schedule.dayDates : [];
      const needsCascade = String(dd[0]||'').trim() && dd.slice(1, daysN).every(v => !String(v||'').trim());
      if (needsCascade && typeof cascadeDayDatesFrom === 'function') cascadeDayDatesFrom(0);
    }catch(_e){}
}

  // Time calc

  // v2.3.89: Standardized time input validation (HH:MM:SS or 6 digits on commit)
  const isValidHHMMSS = s => /^([01]\d|2[0-3]):[0-5]\d:[0-5]\d$/.test(String(s||''));
  const digitsToHHMMSS = d => {
    d = String(d||'').replace(/\D/g,'').slice(0,6);
    if (d.length !== 6) return null;
    return d.slice(0,2)+':'+d.slice(2,4)+':'+d.slice(4,6);
  };
  const coerceTime = raw => {
    const s = String(raw||'').trim();
    if (/^\d{6}$/.test(s)) { const f = digitsToHHMMSS(s); return isValidHHMMSS(f) ? f : null; }
    return isValidHHMMSS(s) ? s : null;
  };
  // === v2.3.1 (h1): helper for per-day start time (no UI change) ===
  
  // --- Time helpers (seconds-based) ---
  function pad2_(n){ return String(n).padStart(2,'0'); }

  // Accepts HH:MM or HH:MM:SS, returns HH:MM:SS (best-effort; clamps parts)
  function normalizeTime(t){
    let s = String(t ?? '').trim();
    if (!s) return '00:00:00';
    if (/^\d{1,2}:\d{2}$/.test(s)) s = s + ':00';
    const m = s.match(/^(\d{1,2}):(\d{2}):(\d{2})$/);
    if (!m) return '00:00:00';
    let hh = Math.max(0, Math.min(23, parseInt(m[1],10) || 0));
    let mm = Math.max(0, Math.min(59, parseInt(m[2],10) || 0));
    let ss = Math.max(0, Math.min(59, parseInt(m[3],10) || 0));
    return pad2_(hh)+':'+pad2_(mm)+':'+pad2_(ss);
  }

  function parseHMS(t){
    const s = normalizeTime(t);
    const parts = s.split(':');
    return {
      h: parseInt(parts[0],10) || 0,
      m: parseInt(parts[1],10) || 0,
      s: parseInt(parts[2],10) || 0
    };
  }

  // deltaMin may be fractional (e.g., 0.5 / 1.5). Uses seconds precision and wraps 24h.
  function addMinutes(h,m,s, deltaMin){
    const base = (Number(h)||0)*3600 + (Number(m)||0)*60 + (Number(s)||0);
    const add = Math.round((Number(deltaMin)||0) * 60);
    let total = base + add;
    total = ((total % 86400) + 86400) % 86400;
    const hh = Math.floor(total/3600);
    const mm = Math.floor((total%3600)/60);
    const ss = total%60;
    return pad2_(hh)+':'+pad2_(mm)+':'+pad2_(ss);
  }

function startTimeForDay(dayIndex, rallyNo, rowsView){
  try {
    const sched = state && state.schedule ? state.schedule : {};
    const startTimes = Array.isArray(sched.startTimes) ? sched.startTimes : [];
    const incs = Array.isArray(sched.incrementsMin) ? sched.incrementsMin : [];
    const base = startTimes[dayIndex] || startTimes[0] || '08:30:00';
    const incMin = (Number(incs[dayIndex]) || Number(incs[0]) || 0);
    const n = Math.max(1, Number(rallyNo) || 1) - 1;

    // Start-delays inclusion (Timeline → Admin): only when SG-desc sort + checkbox ON.
    try{
      const __chk = document.getElementById('includeStartDelaysChk');
      const __include = !!(__chk && __chk.checked && state && state.tableSortState === 'sg-desc' && Array.isArray(rowsView) && rowsView.length);
      if (__include){
        const __rid = (typeof __getRidForAdmin_ === 'function') ? __getRidForAdmin_() : 'RID-DEV';
        const __bundle = (typeof __tdPeekRootForRid_ === 'function') ? __tdPeekRootForRid_(__rid) : null;
        const __dayKey = String((Number(dayIndex)||0) + 1);
        const __delays = (__bundle && __bundle.r && __bundle.r.schedule && __bundle.r.schedule.days && __bundle.r.schedule.days[__dayKey] &&
          __bundle.r.schedule.days[__dayKey].timeline && __bundle.r.schedule.days[__dayKey].timeline.delaysMin) || {};
        const __sig = String(__dayKey)+'|'+String(base)+'|'+String(incMin)+'|'+String(rowsView.length)+'|'+rowsView.map(p=>String((p&&p.row&&p.row.speedGroup)||'')).join(',')+
          '|'+String(__delays.sg1||0)+','+String(__delays.sg2||0)+','+String(__delays.sg3||0);

        if (!state.__startDelayCache || state.__startDelayCache.sig !== __sig){
          let cur = normalizeTime(base);
          let prevSg = null;
          const out = new Array(rowsView.length);
          for (let i=0; i<rowsView.length; i++){
            const sg = Math.max(1, Math.min(4, Number(rowsView[i] && rowsView[i].row ? rowsView[i].row.speedGroup : 1) || 1));
            if (prevSg == null) prevSg = sg;
            if (sg !== prevSg){
              const dk = 'sg'+String(sg);
              const dMin = Number(__delays && __delays[dk]) || 0;
              if (dMin){
                const t = parseHMS(normalizeTime(cur));
                cur = addMinutes(t.h, t.m, t.s, dMin);
              }
              prevSg = sg;
            }
            out[i] = cur;
            if (incMin){
              const t2 = parseHMS(normalizeTime(cur));
              cur = addMinutes(t2.h, t2.m, t2.s, incMin);
            }
          }
          state.__startDelayCache = { sig: __sig, times: out };
        }

        const __t = (state.__startDelayCache && state.__startDelayCache.times) ? state.__startDelayCache.times[n] : null;
        if (__t) return __t;
      }
    }catch(_e){ /* fall through to non-delay calc */ }

    const t = normalizeTime(base);
    const {h,m,s} = parseHMS(t);
    return addMinutes(h,m,s, n * incMin);
  } catch (e) {
    // Fallback: first day start time or default
    const st0 = (state && state.schedule && Array.isArray(state.schedule.startTimes) && state.schedule.startTimes[0]) || '08:30:00';
    return st0;
  }
}
function startTimeForRallyNo(rNo){
    try{ return startTimeForDay(0, rNo); }catch(_e){
      const base = (state && state.schedule && Array.isArray(state.schedule.startTimes) && state.schedule.startTimes[0]) ? state.schedule.startTimes[0] : '08:30:00';
      return base;
    }
  }
  

function recomputeAllStartTimes() {
  try {
    const tbody = document.querySelector('#tbody');
    if (!tbody) return;
    const rows = Array.from(tbody.querySelectorAll('tr'));
    rows.forEach((tr, rowIdx) => {
      const rallyNoCell = tr.querySelector('.readonly.rallyNo, [data-col="rallyNo"]');
      const _raw = rallyNoCell ? (rallyNoCell.textContent || rallyNoCell.value || '').toString() : '';
      const _rn = parseInt(_raw, 10);
      const rallyNo = (isFinite(_rn) && _rn>0) ? _rn : (rowIdx+1);
      const dayTimeCells = Array.from(tr.querySelectorAll('.readonly.time'));
      dayTimeCells.forEach((cell, dIdx) => {
        let t = null;
        try { t = startTimeForDay(dIdx, rallyNo); } catch (e) {}
        const str = (typeof t === 'string') ? t : (t != null ? String(t) : '');
        if (/^\d{2}:\d{2}:\d{2}$/.test(str)) {
          cell.textContent = str;
        } else if (str) {
          cell.textContent = str;
        } else {
          cell.textContent = '';
        }
      });
    });
  } catch (e) {
    if (typeof render === 'function') render();
  }
}
  function __tableCommitLog_(inp, value){ /* cleanup: no-op */ }

  function tdInput(type,val,oncommit,opts={}){
    const td=document.createElement('td'); const inp=document.createElement('input');
    if (opts.placeholder) inp.placeholder = opts.placeholder;
    if (opts.field) inp.setAttribute('data-field', opts.field);
    const __isYear = (opts && (opts.validate==='year' || opts.field==='year'));
    inp.type=(type==='email')?'email':((type==='number' && !__isYear)?'number':'text');
    if(type==='number' && !__isYear) inp.step='1';
    inp.value=val??'';
    if(__isYear){
      inp.inputMode='numeric';
      inp.autocomplete='off';
      inp.setAttribute('data-year-picker','1');
    }
    function validate(){
      // UI-only: keep Year clamp only. Mobile/Email validation & toasts removed.
      if(opts.validate==='year'){ const y=clampYear(inp.value); if(inp.value && +inp.value!==+y){ inp.value=y } }
    }

    // Commit semantics:
    // - Only emit TABLE_COMMIT when the user actually edited the field (dirty flag).
    // - Normalize undefined/null to '' so click-through does not generate commits.
    // - Year: menu-driven selection emits on change; blur never emits (avoids dupes).
    let __dirty = false;
    let __before = '';
    inp.addEventListener('focusin', ()=>{ __before = (inp.value==null ? '' : String(inp.value)); __dirty = false; });
    inp.addEventListener('input', ()=>{ __dirty = true; });

    function __maybeLogCommit_(){
      if(window.BOOT_MUTE) return;
      if(!__dirty) return;
      const b = (__before==null ? '' : String(__before));
      const a = (inp.value==null ? '' : String(inp.value));
      if(b === a) return;
      __tableCommitLog_(inp, a);
    }

    if(__isYear){
      inp.addEventListener('blur', ()=>{ if(window.BOOT_MUTE) return; validate(); oncommit(inp.value); });
      inp.addEventListener('change', ()=>{ if(window.BOOT_MUTE) return; validate(); oncommit(inp.value); __tableCommitLog_(inp, (inp.value==null ? '' : String(inp.value))); });
    }else{
      inp.addEventListener('blur', ()=>{ 
        if(window.BOOT_MUTE) return; 
        validate(); 
        oncommit(inp.value); 
        // commit log (UI-only) + emit-only broadcast for driver surname commit
        const b = (__before==null ? '' : String(__before));
        const a = (inp.value==null ? '' : String(inp.value));
        __maybeLogCommit_();
        try{ if(__dirty && b !== a){ requestAdminEntriesPersistAfterSettle_(opts && opts.field ? String(opts.field) : 'cell'); } }catch(_e){}

        try{
          if(opts && opts.field === 'driverSurname' && __dirty && b !== a){
            emitTdChangedDebounced_('admin.entries.driverSurname', {
              rid: __getRidForAdmin_(),
              branch: 'admin.entries',
              reason: 'driver_surname',
              value: a
            }, 160);
          }
        }catch(_e){}
      });
}

    if(opts.center) inp.style.textAlign='center';
    td.appendChild(inp); return td;
  }
  function paintSpeedGroupCell(td, value){
  const sched = (typeof state==='object' && state && state.schedule) ? state.schedule : {};
  const groups = Math.max(1, Number(sched.speedGroups || 1));
  const limits = Array.isArray(sched.speedLimits) ? sched.speedLimits : [90,80,70,60];
  const gRaw = Number(value || 1);
  const g = Math.min(Math.max(isNaN(gRaw)?1:gRaw, 1), groups);
  const limit = (g>=1 && g<=limits.length) ? limits[g-1] : '';
  td.classList.add('sg-cell');
  td.setAttribute('data-display', String(limit));
  const ctrl = td.querySelector('input, select');
  if (ctrl && String(ctrl.value) !== String(g)) ctrl.value = String(g);
  td.style.background = (groups>1 && g===2) ? 'var(--sg2)'
                     : (groups>1 && g===3) ? 'var(--sg3)'
                     : (groups>1 && g===4) ? 'var(--sg4)'
                     : '';
}


function syncEntriesHeaderToDays_(){
  try{
    const table = document.getElementById('grid');
    if(!table) return;
    const cg = table.querySelector('colgroup');
    const thead = table.querySelector('thead');
    if(!cg || !thead) return;

    const daysCnt = Math.max(1, +((state && state.schedule && state.schedule.days) || 1) || 1);

    // Colgroup: base cols + one 100px Start column per day
    let cgHtml = ''
      + '<col class="c0"/><col class="c1"/><col class="c2"/><col class="c3"/><col class="c4"/><col class="c5"/>'
      + '\n<col class="c6"/><col class="c7"/><col class="c8"/><col class="c9"/><col class="c10"/>';
    for(let d=0; d<daysCnt; d++) cgHtml += '<col class="c11"/>';
    cg.innerHTML = '\n' + cgHtml + '\n';

    // Thead: mirror body columns so extra day cards add Start columns + headers
    let row1 = ''
      + '<tr class="row1">'
      + '\n<th class="gutter"></th>'
      + '\n<th colspan="2">Driver</th>'
      + '\n<th colspan="2">Navigator</th>'
      + '\n<th colspan="2">Driver</th>'
      + '\n<th colspan="2">Car</th>'
      + '\n<th>Speed</th>'
      + '\n<th>Rally</th>';
    for(let d=0; d<daysCnt; d++) row1 += '\n<th>Start ' + (d+1) + '</th>';
    row1 += '\n</tr>';

    let row2 = ''
      + '<tr class="row2">'
      + '\n<th class="gutter"></th>'
      + '\n<th>First name</th>'
      + '\n<th>Surname</th>'
      + '\n<th>First name</th>'
      + '\n<th>Surname</th>'
      + '\n<th>Mobile number</th>'
      + '\n<th>Email</th>'
      + '\n<th>Make</th>'
      + '\n<th>Year</th>'
      + '\n<th>Group</th>'
      + '\n<th>No</th>';
    for(let d=0; d<daysCnt; d++) row2 += '\n<th>Time</th>';
    row2 += '\n</tr>';

    thead.innerHTML = '\n' + row1 + '\n' + row2 + '\n';
  }catch(e){}
}


function render(){
  // backfill origSpeedGroup on existing rows (SG pipeline step 1)
  if (Array.isArray(state.rows)) {
    state.rows.forEach(r => {
      if (r && r.origSpeedGroup == null && r.speedGroup != null) {
        r.origSpeedGroup = r.speedGroup;
      }
    });
  }

  // keep table header/colgroup in sync with current day count
  syncEntriesHeaderToDays_();

    // v2.8.64 — Slot model: do NOT reorder table rows for sort.
    // Rows (Rally No + Start Time) are fixed foundations; sorting redistributes payload into slots.
    let rowsView = state.rows.map((r,src)=>({ row: r, src }));

    try{ state.__lastRowsView = rowsView; }catch(_e){}

    tbody.innerHTML='';
    rowsView.forEach((p,i)=>{
      const row = p.row;
      const src = p.src;
      const tr=document.createElement('tr'); tr.dataset.index=src; tr.dataset.rowId=String(row.rowId??'');
      const tdG=document.createElement('td'); tdG.className='gutter';
      const idxSpan=document.createElement('span'); idxSpan.className='row-index'; const entryNum = (row && row.index!=null) ? row.index : (src+1); tr.dataset.rowIndex=String(entryNum); idxSpan.textContent=String(entryNum); tdG.appendChild(idxSpan);
      const gear=document.createElement('button'); gear.className='gear'; gear.type='button'; gear.title='Row actions'; gear.setAttribute('aria-haspopup','menu'); gear.setAttribute('aria-expanded','false'); gear.title='Row actions'; gear.setAttribute('aria-haspopup','menu'); gear.setAttribute('aria-expanded','false');
      gear.innerHTML='\u2699';
      tdG.appendChild(gear); tr.appendChild(tdG);

      tr.appendChild(tdInput('text', row.driver.first, v=>adminCommitCell(src,'driverFirst',v), {placeholder:"Driver's First name", field:"driverFirst"}));
      tr.appendChild(tdInput('text', row.driver.last, v=>adminCommitCell(src,'driverSurname',v), {placeholder:"Driver's Surname", field:"driverSurname"}));
      tr.appendChild(tdInput('text', row.navigator.first, v=>adminCommitCell(src,'navFirst',v), {placeholder:"Navigator's First name", field:"navFirst"}));
      tr.appendChild(tdInput('text', row.navigator.last, v=>adminCommitCell(src,'navSurname',v), {placeholder:"Navigator's Surname", field:"navSurname"}));
      tr.appendChild(tdInput('text', row.driver.mobile, v=>adminCommitCell(src,'mobile',v), {placeholder:"Driver's Mobile No", field:"mobile"}));
      tr.appendChild(tdInput('email', row.driver.email, v=>adminCommitCell(src,'email',v), {placeholder:"Driver's Email", field:"email"}));
      tr.appendChild(tdInput('text', row.car.make, v=>adminCommitCell(src,'make',v), {placeholder:"Car Make/model", field:"make"}));
      tr.appendChild(tdInput('number', row.car.year, v=>adminCommitCell(src,'year',v), {validate:'year',center:true, placeholder:"Car year", field:"year"}));

      const tdSG=document.createElement('td'); tdSG.className='sg-cell'; const sgInput=document.createElement('select'); sgInput.className='sg-limit'; sgInput.value=row.speedGroup;
      {
        const groups=Math.max(1, Number(state.schedule.speedGroups||1));
        const limits=Array.isArray(state.schedule.speedLimits)?state.schedule.speedLimits:[90,80,70,60];
        sgInput.innerHTML='';
        for(let g=1; g<=groups; g++){
          const opt=document.createElement('option');
          opt.className = 'sg' + g;
          opt.value=String(g);
          opt.textContent=(g<=limits.length?limits[g-1]:String(g));
          sgInput.appendChild(opt);
        }
      }
      sgInput.classList.toggle('single', Number(state.schedule && state.schedule.speedGroups || 1) === 1);
      sgInput.disabled = (state.tableSortState && state.tableSortState !== 'none');

 sgInput.style.textAlign='center';
      sgInput.addEventListener('change', ()=>{
        const maxG = Math.max(1, Number((state.schedule && state.schedule.speedGroups) || 1));
        const sg = Math.max(1, Math.min(maxG, Number(sgInput.value)||1));
        adminCommitCell(src,'speedGroup', sg);
        paintSpeedGroupCell(tdSG, sg);
        __tableCommitLog_(sgInput, String(sg));
        try{ requestAdminEntriesPersistAfterSettle_('sg'); }catch(_e){}

        // Emit-only: tell consumers (e.g., Controls) that entry SG index changed (no storage writes)
        try{
          emitTdChangedDebounced_('admin.entries.sgIdx.'+(i+1), {
            rid: __getRidForAdmin_(),
            branch: 'admin.entries',
            reason: 'entry_sg',
            row: (i+1),
            sgIdx: sg
          }, 140);
        }catch(_e){}
      });
tdSG.appendChild(sgInput); paintSpeedGroupCell(tdSG,row.speedGroup); tr.appendChild(tdSG);

      const tdNo=document.createElement('td'); 
      const no=document.createElement('div'); 
      no.className='readonly rallyNo'; 
      no.textContent=String((row && row.rallyNo!=null)?row.rallyNo:''); 
      tdNo.appendChild(no); 
      tr.appendChild(tdNo);
      const daysCnt = Math.max(1, +state.schedule.days || 1);
      for(let d=0; d<daysCnt; d++){
        const tdTime=document.createElement('td'); 
        tdTime.style.width='100px'; tdTime.style.minWidth='100px'; tdTime.style.maxWidth='100px';
        tdTime.classList.add('day-time');
        tdTime.dataset.dayIndex = String(d+1);
        const timeDiv=document.createElement('div'); 
        timeDiv.className='readonly time'; 
        const __rn = (row && row.rallyNo!=null)?row.rallyNo:0;
        timeDiv.textContent = startTimeForDay(d, __rn, rowsView) || '00:00:00'; 
        tdTime.appendChild(timeDiv); 
        tr.appendChild(tdTime);
      }

      tbody.appendChild(tr);
    });
    // lock/unlock UI based on sort state
    const sorted = state.tableSortState !== 'none';
    const sdWrap = document.getElementById('startDelaysToggleWrap');
    if (sdWrap){
      const showSd = (state.tableSortState === 'sg-desc');
      sdWrap.style.display = showSd ? 'flex' : 'none';
      sdWrap.setAttribute('aria-hidden', showSd ? 'false' : 'true');
    }
    const addBtn = document.getElementById('addRowBtn');
    const sortBtnEl = document.getElementById('sortBtn');
    const gears = document.querySelectorAll('button.gear');
    if (addBtn) {
      addBtn.disabled = sorted;
      // make add row grey when sorted, green otherwise
      addBtn.classList.toggle('btn--green', !sorted);
      addBtn.classList.toggle('btn--grey', sorted);
    }
    if (sortBtnEl) {
      // make sort green when sorted, grey otherwise
      sortBtnEl.classList.toggle('btn--green', sorted);
      sortBtnEl.classList.toggle('btn--grey', !sorted);
    }
    gears.forEach(g => {
      g.style.display = sorted ? 'none' : '';
    });

    // v2.8.91 — When sorted, lock SG speed limits (inputs + −/+ buttons) like Add Row.
    try{
      const sgInputs = document.querySelectorAll('input.sg-limit');
      sgInputs.forEach(inp=>{
        try{ inp.disabled = sorted; }catch(_e){}
        const wrap = inp.closest && inp.closest('.pm-wrap');
        if (wrap){
          const btns = wrap.querySelectorAll('button.pm-btn');
          btns.forEach(b=>{ try{ b.disabled = sorted; }catch(_e){} });
        }
      });
    }catch(_e){}

  }
// Sorting (speed group; stable by original order)
    sortBtn.addEventListener('click', (ev)=>{
    ev.stopPropagation();
    const menu = document.getElementById('sortMenu');
    if (!menu) { alert('Sort menu goes here.'); return; }

    const isOpen = menu.style.display === 'block';

    // Enter quiet-mode immediately when opening the sort menu
    if (!isOpen) {
      __sortQuiet.active = true;
      __sortQuiet.startedMs = Date.now();
      try{ __bootLog_('SORT_QUIET_ON', { src:'sortBtn' }); }catch(_e){}
    }

    menu.style.display = isOpen ? 'none' : 'block';

    // If user closes menu without selecting, drop quiet-mode immediately
    if (isOpen) {
      if (__sortQuiet.active && !(_adminPersistRouter && _adminPersistRouter.timers && _adminPersistRouter.timers['sort'])) {
        __sortQuiet.active = false;
        try{ __bootLog_('SORT_QUIET_OFF', { src:'sortBtn_cancel' }); }catch(_e){}
      }
      return;
    }

    // position near button (simple)
    const rect = sortBtn.getBoundingClientRect();
    menu.style.position = 'absolute';
    menu.style.top = (rect.bottom + window.scrollY + 4) + 'px';
    menu.style.left = (rect.left + window.scrollX) + 'px';
  });
  // delegated sort-menu handler (menu DOM may be rebuilt; avoid stale element listeners)
  document.addEventListener('click', (e) => {
    const sortMenu = document.getElementById('sortMenu');
    if (!sortMenu) return;
    // Only handle clicks intended for the sort menu while it is visible
    if (sortMenu.style.display === 'none') return;
    const withinMenu = e.target && e.target.closest && e.target.closest('#sortMenu');
    if (!withinMenu) return;

    // allow menu selection even while BOOT_MUTE is true (BOOT_MUTE gates writes only).

    const target = e.target.closest('[data-action]');
    if (!target) return;
    const action = target.dataset.action;

    // Bake 2: flush any in-progress edit before sorting
    try{ __flushActiveEditBeforeSort_(); }catch(_e){}

    if (action === 'sort-none') {
      state.tableSortState = 'none';
    } else if (action === 'sort-sg-asc') {
      state.tableSortState = 'sg-asc';
    } else if (action === 'sort-sg-desc') {
      state.tableSortState = 'sg-desc';
    } else {
      return;
    }

        // v2.8.64 — Apply slot/payload sort into truth (rows stay fixed).
    try{ __flushActiveEditBeforeSort_(); }catch(_e){}
    try{ __ensureSlotIdentity_(); }catch(_e){}
    try{ __applySortOrderToTruth_(state.tableSortState); }catch(_e){}

// Refresh Admin modal button states (Download is blocked while sorted)
    try{ if (typeof applyAdminStatus_==='function') applyAdminStatus_(adminStatus_); }catch(_e){}

    try { __bootLog_('SORT_SELECT', { action, sortMode: state.tableSortState }); } catch(_e) {}    // Close menu immediately (UI)
    sortMenu.style.display = 'none';

    // v2.8.64 — view-only sort: do not mutate state.rows
    // Re-render (UI only)
    if (typeof render === 'function') {
      render();
    }

    // Debounced end-of-sort persist (quiet off + optional store write)
    requestAdminSortPersistAfterSettle_('sort');

    e.stopPropagation();
  }, true);


  // Add / save / export / print (export stub)
  // addRowBtn click handler is wired later (single handler).
  // === Entries Grid save schema (single source of truth) ===
  function buildEntriesGridState(){

    const titleEl = document.getElementById('rallyTitlePill');
    const issueEl = document.getElementById('rallyRevPill');
    const rallyName = (titleEl && titleEl.textContent.trim()) && titleEl.textContent.trim() !== 'Rally Title'
      ? titleEl.textContent.trim()
      : '';
    const rallyIssue = (issueEl && issueEl.textContent.trim()) ? issueEl.textContent.trim() : 'r001';

    const daysVisible = (state && state.schedule && state.schedule.days) ? state.schedule.days : 1;
    const sgSelected = (state && state.schedule && state.schedule.speedGroups) ? state.schedule.speedGroups : 1;

    // read day cards from DOM (skip first card = speed limits)
    const days = [];
    const dayCols = document.querySelectorAll('#daysStripInner .day-col');
    // first is speed limits, actual days start at index 1
    for (let i = 1; i < dayCols.length; i++) {
      const col = dayCols[i];
      const dateInp = col.querySelector('input.date');
      const timeInp = col.querySelector('input[type="time"]');
      const incInp = col.querySelector('.day-field.inc input');
      days.push({
        dayIndex: i,
        date: dateInp ? dateInp.value : '',
        time: timeInp ? timeInp.value : '',
        increment: incInp ? Number(incInp.value || 0) : 0
      });
    }

    // table rows from state
    const table = Array.isArray(state.rows) ? state.rows.map((r, idx) => ({
      rowId: r.rowId || (idx + 1),
      index: (Number.isFinite(r.index) && r.index>0 ? r.index : (idx + 1)),
      driver: r.driver,
      navigator: r.navigator,
      car: r.car,
      speedGroup: r.speedGroup,
      rallyNo: r.rallyNo
    })) : [];

    return {
      page: "entries-grid",
      pageVersion: '2.3.345-daydate-140',
      rally: {
        name: rallyName,
        issue: rallyIssue,
        savedAt: new Date().toISOString()
      },
      view: {
        daysVisible: daysVisible,
        sgSelected: sgSelected
      , sortMode: (state && state.tableSortState) ? state.tableSortState : "none"},
      days: days,
      table: table
    };
  }

// expose real builder for Save and Save As
window.buildEntriesGridState = buildEntriesGridState;

async function saveEntriesGrid(){
  try{
    if (!window.isSecureContext){
      if (window.showToast) window.showToast('Save requires https or localhost');
      return;
    }

    // Require workspace
    if (typeof window.__WORKSPACE === 'undefined' || !window.__WORKSPACE || !window.__WORKSPACE.ready || !window.__WORKSPACE.handle){
      if (window.showToast) window.showToast('Set Rally Workspace');
      return;
    }

    // Ensure permission (user gesture already occurred via menu)
    let perm = 'granted';
    try{
      perm = await window.__WORKSPACE.handle.queryPermission({ mode:'readwrite' });
      if (perm !== 'granted'){
        perm = await window.__WORKSPACE.handle.requestPermission({ mode:'readwrite' });
      }
    }catch(_e){}
    if (perm !== 'granted'){
      if (window.showToast) window.showToast('Workspace permission needed');
      return;
    }

    // Require committed title / TD_RALLIES
    const td = (typeof _lsReadTdObjSafe_ === 'function') ? _lsReadTdObjSafe_() : null;
    if (!td){
      if (window.showToast) window.showToast('Commit Rally Title');
      return;
    }

    const rid = (typeof __getRidForAdmin_ === 'function') ? __getRidForAdmin_() : String((td.global && td.global.activeRallyId) || window.__ACTIVE_RID__ || 'RID-DEV');
    const r = (td.rallies && td.rallies[rid]) ? td.rallies[rid] : null;

    const metaTitle = (r && r.meta && r.meta.title) ? String(r.meta.title||'').trim() : '';
    const pill = document.getElementById('rallyTitlePill');
    const pillTitle = pill ? String(pill.textContent||'').trim() : '';
    const rallyName = metaTitle || pillTitle;

    if (!rallyName || rallyName === 'Enter Rally Title'){
      if (window.showToast) window.showToast('Commit Rally Title');
      return;
    }

    // Next r### based on current issue pill
    const issueEl = document.getElementById('rallyRevPill');
    const cur = issueEl ? String(issueEl.textContent||'r000').trim() : 'r000';
    let n = parseInt(cur.replace(/[^0-9]/g,''), 10);
    if (!isFinite(n)) n = 0;
    const nextIssue = 'r' + String(n + 1).padStart(3, '0');

    const fullData = {
      kind: 'TD_RALLIES_SNAPSHOT',
      version: String(document.title||'Entries Grid').trim(),
      savedAt: new Date().toISOString(),
      activeRallyId: rid,
      td_rallies: td
    };

    // Folder based on rally title
    const rallyDir = await window.__WORKSPACE.handle.getDirectoryHandle(rallyName, { create: true });
    const fileHandle = await rallyDir.getFileHandle(nextIssue + '.json', { create: true });
    const writable = await fileHandle.createWritable();
    await writable.write(JSON.stringify(fullData, null, 2));
    await writable.close();

    // Update issue pill + mirror into TD_RALLIES meta
    try{
      if (issueEl){
        issueEl.textContent = nextIssue;
        issueEl.classList.remove('muted');
      }
    }catch(_e){}
    try{
      if (r){
        r.meta = (r.meta && typeof r.meta === 'object') ? r.meta : {};
        r.meta.issue = nextIssue;
      }
    }catch(_e){}
    try{
      localStorage.setItem(TD_RALLIES_KEY, JSON.stringify(td));
    }catch(_e){}

    if (window.showToast) window.showToast('Saved ' + rallyName + ' • ' + nextIssue);
  }catch(err){
    console.error(err);
    if (window.showToast) window.showToast('Save failed');
  }
}

// ===== Load Rally File (common pipeline) =====
function openLoadWarnModal_(){
  return new Promise((resolve)=>{
    try{
      const m = document.getElementById('loadWarnModal');
      const ok = document.getElementById('lwOkBtn');
      const cc = document.getElementById('lwCancelBtn');
      if (!m || !ok || !cc){ resolve(true); return; }
      const close = (v)=>{
        try{ m.style.display = 'none'; }catch(_e){}
        try{ ok.onclick = null; cc.onclick = null; }catch(_e){}
        resolve(!!v);
      };
      try{ m.style.display = 'flex'; }catch(_e){}
      ok.onclick = ()=> close(true);
      cc.onclick = ()=> close(false);
      // ESC support
      const onKey = (e)=>{ if (e.key === 'Escape'){ document.removeEventListener('keydown', onKey, true); close(false); } };
      document.addEventListener('keydown', onKey, true);
    }catch(_e){
      resolve(true);
    }
  });
}

function __extractTdFromLoaded_(obj){
  try{
    if (!obj || typeof obj !== 'object') return null;
    if (obj.td_rallies && obj.td_rallies.rallies) return obj.td_rallies;
    if (obj.TD_RALLIES && obj.TD_RALLIES.rallies) return obj.TD_RALLIES;
    if (obj.rallies && obj.global) return obj;
  }catch(_e){}
  return null;
}

async function __pickSnapshotFile_(){
  // Prefer File System Access API (Chrome/Edge) with startIn = workspace dir handle
  if (window.showOpenFilePicker && window.__WORKSPACE && window.__WORKSPACE.ready && window.__WORKSPACE.handle){
    const [h] = await window.showOpenFilePicker({
      multiple: false,
      startIn: window.__WORKSPACE.handle,
      types: [{ description: 'Rally snapshot', accept: { 'application/json': ['.json'] } }]
    });
    return h || null;
  }

  // Fallback: input[type=file]
  return await new Promise((resolve)=>{
    try{
      const inp = document.createElement('input');
      inp.type = 'file';
      inp.accept = '.json,application/json';
      inp.style.position = 'fixed';
      inp.style.left = '-9999px';
      document.body.appendChild(inp);
      inp.addEventListener('change', async ()=>{
        try{
          const f = inp.files && inp.files[0] ? inp.files[0] : null;
          document.body.removeChild(inp);
          if (!f){ resolve(null); return; }
          // Shim a "handle-like" object
          resolve({ __file: f, name: f.name });
        }catch(_e){
          try{ document.body.removeChild(inp); }catch(__e){}
          resolve(null);
        }
      }, { once:true });
      inp.click();
    }catch(_e){
      resolve(null);
    }
  });
}

async function startLoadFlow_(){
  try{
    if (!window.isSecureContext){
      if (window.showToast) window.showToast('Load requires https or localhost');
      return;
    }
    if (!window.__WORKSPACE || !window.__WORKSPACE.ready){
      if (window.showToast) window.showToast('Set Rally Workspace');
      return;
    }

    const ok = await openLoadWarnModal_();
    if (!ok) return;

    const handle = await __pickSnapshotFile_();
    if (!handle) return;

    let file = null;
    try{
      file = handle.getFile ? await handle.getFile() : (handle.__file || null);
    }catch(_e){}
    if (!file) { if (window.showToast) window.showToast('Load cancelled'); return; }

    const raw = await file.text();
    const obj = JSON.parse(raw);
    const td = __extractTdFromLoaded_(obj);
    if (!td){
      if (window.showToast) window.showToast('Not a TD_RALLIES snapshot');
      return;
    }

    // Determine active RID
    let rid = '';
    try{ rid = String(obj.activeRallyId || (td.global && td.global.activeRallyId) || window.__ACTIVE_RID__ || 'RID-DEV'); }catch(_e){ rid = (window.__ACTIVE_RID__||'RID-DEV'); }
    if (!td.global || typeof td.global !== 'object') td.global = {};
    td.global.activeRallyId = rid;
    td.global.lastRallyId = rid;

    // Write TD_RALLIES to localStorage (source of truth)
    try{ localStorage.setItem('TD_RALLIES', JSON.stringify(td)); }catch(_e){
      if (window.showToast) window.showToast('Load failed (storage)');
      return;
    }

    // Update quick UI pills (best-effort) before reload
    try{
      const r = (td.rallies && td.rallies[rid]) ? td.rallies[rid] : null;
      const title = r && r.meta && typeof r.meta.title === 'string' ? r.meta.title.trim() : '';
      const pill = document.getElementById('rallyTitlePill');
      if (pill && title){
        pill.textContent = title;
        pill.classList.remove('muted');
        pill.classList.add('filled');
      }
    }catch(_e){}
    try{
      const nm = (handle && handle.name) ? String(handle.name) : '';
      const m = nm.match(/\br(\d{3})\b/i);
      if (m){
        const rev = document.getElementById('rallyRevPill');
        if (rev) rev.textContent = 'r' + m[1];
      }
    }catch(_e){}

    // Notify other tabs/pages
    try{
      if (typeof emitTdChanged_ === 'function'){
        emitTdChanged_({ rid, branch:'snapshot', reason:'load' });
      }
    }catch(_e){}

    if (window.showToast) window.showToast('Loaded');
    // Reload this page to ensure a clean hydrate from LS (no partial UI state)
    setTimeout(()=>{ try{ location.reload(); }catch(_e){} }, 60);
  }catch(err){
    console.error(err);
    if (window.showToast) window.showToast('Load failed');
  }
}

function openSaveAsModal(){
  try{
    // Preconditions: workspace + TD_RALLIES exists
    if (!window.isSecureContext){
      if (window.showToast) window.showToast('Save requires https or localhost');
      return;
    }
    if (!window.__WORKSPACE || !window.__WORKSPACE.ready || !window.__WORKSPACE.handle){
      if (window.showToast) window.showToast('Set Rally Workspace');
      return;
    }
    const td = (typeof _lsReadTdObjSafe_ === 'function') ? _lsReadTdObjSafe_() : null;
    if (!td){
      if (window.showToast) window.showToast('Commit Rally Title');
      return;
    }

    const modal = document.getElementById('saveAsModal');
    const input = document.getElementById('saveAsInput');
    if (!modal || !input) return;

    // Seed with current title
    const pill = document.getElementById('rallyTitlePill');
    const cur = pill ? String(pill.textContent||'').trim() : '';
    input.value = (cur && cur !== 'Enter Rally Title') ? cur : '';
    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden','false');
    setTimeout(()=>{ try{ input.focus(); input.select(); }catch(_e){} }, 0);
  }catch(_e){}
}

function closeSaveAsModal(){
  try{
    const modal = document.getElementById('saveAsModal');
    if (!modal) return;
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden','true');
  }catch(_e){}
}

async function performSaveAs_(newTitle){
  // Validate + normalize
  const title = String(newTitle||'').trim().replace(/\s+/g,' ');
  if (!title){
    if (window.showToast) window.showToast('Enter a title');
    return;
  }
  if (!window.isSecureContext){
    if (window.showToast) window.showToast('Save requires https or localhost');
    return;
  }
  if (!window.__WORKSPACE || !window.__WORKSPACE.ready || !window.__WORKSPACE.handle){
    if (window.showToast) window.showToast('Set Rally Workspace');
    return;
  }

  // Ensure permission (user gesture already occurred via modal OK click)
  try{
    const perm = await window.__WORKSPACE.handle.queryPermission({ mode:'readwrite' });
    if (perm !== 'granted'){
      const req = await window.__WORKSPACE.handle.requestPermission({ mode:'readwrite' });
      if (req !== 'granted'){
        if (window.showToast) window.showToast('Workspace permission needed');
        return;
      }
    }
  }catch(_e){}

  const td = (typeof _lsReadTdObjSafe_ === 'function') ? _lsReadTdObjSafe_() : null;
  if (!td){
    if (window.showToast) window.showToast('Commit Rally Title');
    return;
  }

  const rid = (typeof __getRidForAdmin_ === 'function') ? __getRidForAdmin_() : (td.global && td.global.activeRallyId) || window.__ACTIVE_RID__ || 'RID-DEV';
  td.global = (td.global && typeof td.global === 'object') ? td.global : {};
  td.global.activeRallyId = rid;

  td.rallies = (td.rallies && typeof td.rallies === 'object') ? td.rallies : {};
  const r = td.rallies[rid] = (td.rallies[rid] && typeof td.rallies[rid] === 'object') ? td.rallies[rid] : {};
  r.meta = (r.meta && typeof r.meta === 'object') ? r.meta : {};
  r.meta.title = title;
  r.meta.issue = 'r001';

  // Update UI title pill + issue pill
  try{
    const pill = document.getElementById('rallyTitlePill');
    if (pill){
      pill.textContent = title;
      pill.classList.add('filled');
      pill.classList.remove('muted');
    }
  }catch(_e){}
  try{
    const issueEl = document.getElementById('rallyRevPill');
    if (issueEl){
      issueEl.textContent = 'r001';
      issueEl.classList.remove('muted');
    }
  }catch(_e){}

    // Ensure admin.entries is seeded for the new title
  try{
    r.admin = (r.admin && typeof r.admin === 'object') ? r.admin : {};
    r.admin.ui = (r.admin.ui && typeof r.admin.ui === 'object') ? r.admin.ui : {};
    r.admin.entries = (typeof __buildAdminRowsPayload_ === 'function') ? __buildAdminRowsPayload_() : (r.admin.entries || []);
    try{ r.admin.ui.sortMode = (state && state.tableSortState) ? state.tableSortState : (r.admin.ui.sortMode || 'none'); }catch(_e){}
    try{ r.admin.ui.dayCount = (state && state.schedule && state.schedule.days) ? Number(state.schedule.days) : (r.admin.ui.dayCount || 1); }catch(_e){}
    try{ r.admin.ui.sgCount  = (state && state.schedule && state.schedule.speedGroups) ? Number(state.schedule.speedGroups) : (r.admin.ui.sgCount || 1); }catch(_e){}
}catch(_e){}

// Persist TD_RALLIES under new title/issue
  try{ window.__ADMIN_TD_WRITE_OVERRIDE__ = td; _adminPersistNow('title_commit','title'); }catch(_e){} finally{ try{ window.__ADMIN_TD_WRITE_OVERRIDE__ = null; }catch(_e2){} }

  // Export snapshot to workspace/{title}/r001.json
  try{
    const fullData = {
      kind: 'TD_RALLIES_SNAPSHOT',
      version: String(document.title||'Entries Grid').trim(),
      savedAt: new Date().toISOString(),
      issue: 'r001',
      title: title,
      activeRallyId: rid,
      td_rallies: td
    };
    const rallyDir = await window.__WORKSPACE.handle.getDirectoryHandle(title, { create: true });
    const fileHandle = await rallyDir.getFileHandle('r001.json', { create: true });
    const writable = await fileHandle.createWritable();
    await writable.write(JSON.stringify(fullData, null, 2));
    await writable.close();
    if (window.showToast) window.showToast('Saved ' + title + ' • r001');
  }catch(err){
    console.error(err);
    if (window.showToast) window.showToast('Save As failed');
  }
}

// Hook up modal controls once DOM exists
(function(){
  try{
    const modal = document.getElementById('saveAsModal');
    const input = document.getElementById('saveAsInput');
    const ok = document.getElementById('saveAsOkBtn');
    const cancel = document.getElementById('saveAsCancelBtn');
    if (!modal || !input || !ok || !cancel) return;

    const doOk = async ()=>{
      const t = String(input.value||'');
      closeSaveAsModal();
      await performSaveAs_(t);
    };

    ok.addEventListener('click', ()=>{ doOk(); });
    cancel.addEventListener('click', ()=>{ closeSaveAsModal(); });

    // Click backdrop closes
    modal.addEventListener('click', (e)=>{
      if (e.target === modal) closeSaveAsModal();
    });

    // Enter/Esc in input
    input.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter'){ e.preventDefault(); doOk(); }
      if (e.key === 'Escape'){ e.preventDefault(); closeSaveAsModal(); }
    });

    // Escape anywhere
    document.addEventListener('keydown', (e)=>{
      if (e.key === 'Escape' && modal.style.display === 'flex'){
        closeSaveAsModal();
      }
    });
  }catch(_e){}
})();


saveBtn.addEventListener('click', function(){ saveEntriesGrid(); });
if (typeof loadBtn !== 'undefined' && loadBtn){
  loadBtn.addEventListener('click', function(){ try{ (typeof startLoadFlow_ === 'function') && startLoadFlow_(); }catch(_e){} });
}


  

// ADD ROW (UI-only): append a blank row when not sorted.
try{
  const addRowBtnEl = document.getElementById('addRowBtn');
  if (addRowBtnEl){
    addRowBtnEl.addEventListener('click', function(){
      try{
          const sorted = (window.state && window.state.tableSortState && window.state.tableSortState !== 'none');
        if (sorted) return;
        if (!window.state || !Array.isArray(window.state.rows)) return;

        let newRow = null;
        try{
          const makeBlank = (window.blankRow || null);
          newRow = makeBlank ? makeBlank() : null;
          if (!newRow && (typeof blankRow === 'function')) newRow = blankRow();
        }catch(_){ newRow = null; }

        if (!newRow) return;

        window.state.rows.push(newRow);
        if (typeof window.render === 'function') window.render();
        // Persist only if a TD_RALLIES store already exists (title committed).
        try{
          const hasStore = !!localStorage.getItem('TD_RALLIES');
          if (hasStore){
            requestAdminEntriesPersistAfterSettle_('add_row');
          } else {
            try{ __bootLog_ && __bootLog_('ADD_ROW_SKIP_NO_STORE'); }catch(_){}
          }
        }catch(_e){} 
// Visual highlight for the new row (no auto-scroll).
        setTimeout(function(){
          try{
            const tb = document.getElementById('tbody');
            const trs = tb ? tb.querySelectorAll('tr') : [];
            const tr = trs && trs.length ? trs[trs.length - 1] : null;
            if (tr && typeof highlight === 'function') highlight(tr);
          }catch(_){}
        }, 0);
      }catch(_){}
    });
  }
}catch(_){}
// Print subsystem removed (E1.4)

  // Data helpers
  
  // SG pipeline step 2: clamp rows to current SG count
  // v2.7.17 — session-only SG restore (RAM only; no TD_RALLIES/schema changes)
  const __sgSessionOrigByKey_ = new Map();
  function __sgRowKey_(r){
    try{
      const rn = (r && r.rallyNo)!=null ? String(r.rallyNo) : '';
      if (rn) return 'rallyNo:' + rn;
      const ix = (r && r.index)!=null ? String(r.index) : '';
      if (ix) return 'index:' + ix;
    }catch(_e){}
    return '';
  }
  function __sgRememberOrig_(row, origGroup){
    try{
      const k = __sgRowKey_(row);
      if (!k) return;
      if (!__sgSessionOrigByKey_.has(k)) __sgSessionOrigByKey_.set(k, Number(origGroup||0));
    }catch(_e){}
  }
  function __sgRestoreIfPossible_(maxG){
    try{
      if (!Array.isArray(state.rows)) return;
      const maxGroup = Math.max(1, Number(maxG||1));
      if (!__sgSessionOrigByKey_.size) return;
      const prevMax = Math.max(1, maxGroup - 1);
      for (const [k, orig] of Array.from(__sgSessionOrigByKey_.entries())){
        if (!orig || orig < 1 || orig > maxGroup) continue;
        const row = state.rows.find(r => __sgRowKey_(r) === k);
        if (!row) continue;
        // Only restore if it still looks auto-demoted.
        if (Number(row.speedGroup||1) === prevMax){
          row.speedGroup = orig;
          __sgSessionOrigByKey_.delete(k);
        }
      }
    }catch(_e){}
  }
  function normalizeRowsToGroups(maxG){
    if (!Array.isArray(state.rows)) return;
    const maxGroup = Math.max(1, Number(maxG||1));
    state.rows.forEach(r => {
      let g = Number(r.speedGroup || 1);
      if (g < 1) g = 1;
      if (g > maxGroup){
        __sgRememberOrig_(r, g);
        g = maxGroup;
      }
      r.speedGroup = g;
    });
  }

function blankRow(overrides={}){
    const rows = Array.isArray(state.rows) ? state.rows : [];
    const maxRallyNo = rows.reduce((m,r)=>Math.max(m, (parseInt(r?.rallyNo,10)||0)), 0);
    const maxIndex   = rows.reduce((m,r)=>Math.max(m, (parseInt(r?.index,10)||0)), 0);
    const rNo = maxRallyNo + 1;
    const idx = maxIndex + 1;
    return { index: idx, driver:{first:'',last:'',mobile:'',email:''}, navigator:{first:'',last:''}, car:{make:'',year:''},
             speedGroup:1, rallyNo:rNo, startTime:startTimeForRallyNo(rNo), ...overrides };
  }

  // Bake 1 (hydrate prep): deterministic row-skeleton growth helper.
  // Never shrinks; grows state.rows to at least N, preserving existing row objects.
  function __ensureStateRowsCount_(n){
    try{
      if (!Array.isArray(state.rows)) state.rows = [];
      n = Math.max(0, Math.floor(Number(n || 0)));
      if (!n) return;
      const target = Math.max(state.rows.length, n);
      while (state.rows.length < target){
        // Use blankRow() so defaults (including computed startTime) stay consistent.
        const rNo = state.rows.length + 1;
        const row = blankRow({ index: rNo, rallyNo: rNo });
        state.rows.push(row);
      }
    }catch(_e){}
  }

  
  // init with 10 empty rows; placeholders applied in render
  state.rows = [];
  for (let i = 0; i < 10; i++) {
    const rNo = i + 1;
    state.rows.push({
      index: i + 1,
      driver: { first: '', last: '', mobile: '', email: '' },
      navigator: { first: '', last: '' },
      car: { make: '', year: '' },
      speedGroup: 1,
      rallyNo: rNo,
      startTime: startTimeForRallyNo(rNo)
    });
  }

  // v2.3.436 — SG cell popup menu for table Speed Group column
  function initSgCellMenu(){
    if (window._sgCellMenuInit) return;
    window._sgCellMenuInit = true;

    const tableEl = document.getElementById('grid');
    if (!tableEl) return;

    const menu = document.createElement('div');
    menu.id = 'sgCellMenu';
    menu.className = 'sg-menu';
    menu.style.position = 'absolute';
    menu.style.display = 'none';
    menu.style.zIndex = '4000';
    document.body.appendChild(menu);

    let currentCell = null;

    function syncSgSelectOptions(selectEl){
      try{
        if(!selectEl) return;
        const sched = state && state.schedule ? state.schedule : {};
        const groups = Math.max(1, Number(sched.speedGroups || 1));
        const limits = Array.isArray(sched.speedLimits) ? sched.speedLimits.slice(0, 4) : [90,80,70,60];
        // If already correct, skip
        const curN = selectEl.options ? selectEl.options.length : 0;
        const need = groups;
        let ok = (curN === need);
        if(ok){
          for(let i=0;i<need;i++){
            const opt = selectEl.options[i];
            if(!opt || String(opt.value)!==String(i+1)) { ok=false; break; }
          }
        }
        if(ok) return;
        selectEl.innerHTML = '';
        for(let i=0;i<groups;i++){
          const n=i+1;
          const speed = (i < limits.length && limits[i] != null) ? limits[i] : '';
          const opt=document.createElement('option');
          opt.className='sg'+n;
          opt.value=String(n);
          opt.textContent=String(speed);
          selectEl.appendChild(opt);
        }
      }catch(_e){}
    }

    function buildMenuItems(){
      const sched = state && state.schedule ? state.schedule : {};
      const groups = Math.max(1, Number(sched.speedGroups || 1));
      const limits = Array.isArray(sched.speedLimits) ? sched.speedLimits.slice(0, 4) : [90,80,70,60];
      const parts = [];
      for (let i = 0; i < groups; i++){
        const n = i + 1;
        const speed = (i < limits.length && limits[i] != null) ? limits[i] : '';
        parts.push(
          '<div class="sg-item" data-val="' + n + '">' +
            '<span class="swatch" style="background:var(--sg' + n + ');"></span>' +
            '<span class="sg-speed">' + speed + '</span>' +
          '</div>'
        );
      }
      menu.innerHTML = parts.join('');
    }

    function closeMenu(){
      menu.style.display = 'none';
      currentCell = null;
    }

    function openMenuForCell(td){
      if (!td) return;
      currentCell = td;
      try{ syncSgSelectOptions(currentCell.querySelector('select')); }catch(_e){}

      buildMenuItems();
      menu.style.display = 'block';

      const rect = td.getBoundingClientRect();
      const menuRect = menu.getBoundingClientRect();
      const scrollX = window.scrollX || document.documentElement.scrollLeft || 0;
      const scrollY = window.scrollY || document.documentElement.scrollTop || 0;

      let left = rect.left + scrollX + (rect.width - menuRect.width) / 2;
      const viewportLeft = scrollX + 8;
      const viewportRight = scrollX + document.documentElement.clientWidth - 8;
      if (left < viewportLeft) left = viewportLeft;
      if (left + menuRect.width > viewportRight) left = viewportRight - menuRect.width;

      let top = rect.bottom + scrollY + 4;
      const viewportBottom = scrollY + window.innerHeight - 8;
      if (top + menuRect.height > viewportBottom) {
        top = rect.top + scrollY - menuRect.height - 4;
      }

      menu.style.left = left + 'px';
      menu.style.top = top + 'px';
    }

    // open on SG cell click
    document.addEventListener('click', function(ev){
      const cell = ev.target.closest('td.sg-cell');
      if (cell && tableEl.contains(cell)) {
        ev.preventDefault();
        ev.stopPropagation();
        openMenuForCell(cell);
        return;
      }
      if (!ev.target.closest('#sgCellMenu')) {
        closeMenu();
      }
    });

    // click a menu item
    menu.addEventListener('click', function(ev){
      const item = ev.target.closest('.sg-item');
      if (!item || !currentCell) return;
      const selected = Number(item.dataset.val) || 1;
      const selectEl = currentCell.querySelector('select');
      try{ syncSgSelectOptions(selectEl); }catch(_e){}

      if (selectEl) {
        selectEl.value = String(selected);
        try {
          selectEl.dispatchEvent(new Event('change', { bubbles: true }));
        } catch(e){
          const evt = document.createEvent('Event');
          evt.initEvent('change', true, true);
          selectEl.dispatchEvent(evt);
        }
      }
      closeMenu();
    });

    document.addEventListener('keydown', function(ev){
      if (ev.key === 'Escape') {
        closeMenu();
      }
    });

    const tableWrapEl = document.querySelector('.table-wrap');
    if (tableWrapEl) {
      tableWrapEl.addEventListener('scroll', ()=>{ if(menu.style.display==='block') return; closeMenu(); });
    }
  }

  // v2.5.57 — Year cell popup picker (no visible in-cell dropdown; no column width changes)
  function initYearCellMenu(){
    if (window._yearCellMenuInit) return;
    window._yearCellMenuInit = true;

    const menu = document.createElement('div');
    menu.id = 'yearCellMenu';
    menu.className = 'dd-menu';
    menu.style.position = 'absolute';
    menu.style.display = 'none';
    menu.style.zIndex = '4000';
    menu.style.minWidth = '90px';
    menu.style.maxWidth = '90px';
    menu.style.maxHeight = '260px';
    menu.style.overflowY = 'auto';
    document.body.appendChild(menu);

    let currentInput = null;

    function buildYears(){
      const now = new Date();
      const maxY = now.getFullYear();
      const minY = 1900;
      const years = [];
      for (let y=maxY; y>=minY; y--) years.push(String(y));
      return years;
    }
    const YEARS = buildYears();

    function closeMenu(){
      menu.style.display = 'none';
      currentInput = null;
    }

    function openMenuFor(inp){
      if (!inp) return;
      currentInput = inp;

      // Build items (cheap enough at this scale)
      menu.innerHTML = '';
      const blank = document.createElement('div');
      blank.className = 'dd-item';
      blank.textContent = '—';
      blank.dataset.val = '';
      blank.style.justifyContent = 'center';
      menu.appendChild(blank);

      const cur = String(inp.value||'').trim();
      YEARS.forEach(y=>{
        const it = document.createElement('div');
        it.className = 'dd-item';
        it.textContent = y;
        it.dataset.val = y;
        it.style.justifyContent = 'center';
        if (cur && y===cur) it.style.fontWeight = '800';
        menu.appendChild(it);
      });

      const r = inp.getBoundingClientRect();
      const left = Math.max(8, Math.min(r.left, (window.innerWidth - 98)));
      const top = (r.bottom + 4);

      menu.style.left = (left + window.scrollX) + 'px';
      menu.style.top  = (top  + window.scrollY) + 'px';
      menu.style.display = 'block';
    }

    // Choose value
    menu.addEventListener('mousedown', function(ev){
      const item = ev.target.closest('.dd-item');
      if (!item || !currentInput) return;
      ev.preventDefault();
      currentInput.value = item.dataset.val || '';
      try{ currentInput.dispatchEvent(new Event('change', {bubbles:true})); }catch(_){}
      closeMenu();
    });

    // Open on click/focus of Year inputs (plain cell look; popup picker)
    function isYearInput_(el){
      try{ return !!(el && el.tagName==='INPUT' && el.getAttribute('data-year-picker')==='1'); }catch(_){ return false; }
    }

    // Capture BEFORE global close guards: clicking/focusing the year input opens the picker and keeps it open.
    document.addEventListener('mousedown', function(ev){
      const t = ev.target;
      if (!isYearInput_(t)) return;
      // Don’t let the grid selection/click-away logic immediately kill the picker.
      ev.preventDefault();
      ev.stopPropagation();
      openMenuFor(t);
    }, true);

    document.addEventListener('focusin', function(ev){
      const t = ev.target;
      if (!isYearInput_(t)) return;
      // Focus may come from Tab navigation.
      try{ openMenuFor(t); }catch(_){}
    }, true);

    // Close guard while menu is open
    document.addEventListener('mousedown', function(ev){
      if (menu.style.display !== 'block') return;
      const t = ev.target;

      // If the click is inside the year menu, let the menu handler run.
      if (t && t.closest && t.closest('#yearCellMenu')) {
        return; // do not stop propagation
      }

      // If the click is on the owning year cell/input, keep it open.
      try{
        const ownerTd = currentInput && currentInput.closest ? currentInput.closest('td') : null;
        if (ownerTd && t && t.closest && t.closest('td') === ownerTd){
          ev.stopPropagation();
          return;
        }
      }catch(_){}

      // Otherwise, close.
      closeMenu();
    }, true);

    document.addEventListener('keydown', function(ev){
      if (ev.key==='Escape') closeMenu();
    }, true);

    window.addEventListener('scroll', function(){
    try{
      var m = document.getElementById('rowCtxMenu');
      if(m && m.style.display === 'block') closeMenu();
    }catch(_e){}
  }, true);
window.addEventListener('resize', ()=>{ if(menu.style.display==='block') closeMenu(); });
  }

  // v2.3.495 — catch-all persist: watch table DOM mutations (e.g., sort re-render)
  let __tdrEntriesObs = null;
  function armEntriesObserver_(){
    if (__tdrEntriesObs) return;
    const tb = document.getElementById('tbody') || document.querySelector('#grid tbody') || document.querySelector('tbody');
    if (!tb || typeof MutationObserver !== 'function') return;
    const kick = ()=>{ try{ const u = Number(window.__TD_SUPPRESS_PERSIST_UNTIL__||0); const mu = Number(window.__TD_SUPPRESS_MUT_PERSIST_UNTIL__||0); if (Date.now() < mu) return; if(window.__TD_HYDRATING__ || (Date.now()<u)) return;}catch(_e){} };
    __tdrEntriesObs = new MutationObserver(()=>{ kick(); });
    __tdrEntriesObs.observe(tb, { childList:true, subtree:true });
  }


  // Sticky metrics (UI support only)
  function setStickyTop(){
    try{
      const actionsPanel = document.getElementById('actionsPanel');
      const barH = actionsPanel ? actionsPanel.offsetHeight : 0;
      const topGap = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--top-gap')) || 0;
      document.documentElement.style.setProperty('--sticky-top', String(Math.round(barH + topGap)) + 'px');
    }catch(_e){}
  }
  window.addEventListener('load', setStickyTop);
  window.addEventListener('resize', setStickyTop);
  if (document.fonts && document.fonts.ready) document.fonts.ready.then(setStickyTop);

  // UI SUPPORT — Days dropdown + model (UI-only; no persistence)
  
  // Dropdown portal helpers (escape stacking contexts)
  function portalOpen_(menuEl, anchorEl){
    try{
      if(!menuEl || !anchorEl) return;
      if(menuEl.__portalActive) { portalPosition_(menuEl, anchorEl); return; }
      menuEl.__portalActive = true;
      menuEl.__portalAnchor = anchorEl;
      menuEl.__portalParent = menuEl.parentNode;
      menuEl.__portalNext = menuEl.nextSibling;
      document.body.appendChild(menuEl);
      menuEl.classList.add('portal');
      portalPosition_(menuEl, anchorEl);

      const onMove = ()=> portalPosition_(menuEl, anchorEl);
      menuEl.__portalOnMove = onMove;
      window.addEventListener('scroll', onMove, true);
      window.addEventListener('resize', onMove);
    }catch(_e){}
  }

  function portalPosition_(menuEl, anchorEl){
    try{
      if(!menuEl || !anchorEl) return;
      const r = anchorEl.getBoundingClientRect();
      menuEl.style.position = 'fixed';
      menuEl.style.left = Math.round(r.left) + 'px';
      menuEl.style.top  = Math.round(r.bottom + 6) + 'px';
      menuEl.style.minWidth = Math.round(r.width) + 'px';
    }catch(_e){}
  }

  function portalClose_(menuEl){
    try{
      if(!menuEl || !menuEl.__portalActive) return;
      const onMove = menuEl.__portalOnMove;
      if(onMove){
        window.removeEventListener('scroll', onMove, true);
        window.removeEventListener('resize', onMove);
      }
      menuEl.__portalOnMove = null;

      menuEl.classList.remove('portal');
      menuEl.style.position = '';
      menuEl.style.left = '';
      menuEl.style.top = '';
      menuEl.style.minWidth = '';

      const parent = menuEl.__portalParent;
      const next = menuEl.__portalNext;
      if(parent){
        parent.insertBefore(menuEl, next || null);
      }
      menuEl.__portalActive = false;
      menuEl.__portalAnchor = null;
      menuEl.__portalParent = null;
      menuEl.__portalNext = null;
    }catch(_e){}
  }

function initDays(){
    try{
      const daysDisplay = document.getElementById('daysDisplay');
      const daysDisplayText = document.getElementById('daysDisplayText');
      const daysMenu = document.getElementById('daysMenu');
      if(!daysDisplay || !daysDisplayText || !daysMenu) return;

      const clampDays = (n)=> Math.max(1, Math.min(7, Number(n)||1));

      function setDays(n, fromUser){
        const v = clampDays(n);
        const isUser = !!fromUser;
        const prevDays = (state && state.schedule && state.schedule.days)!=null ? state.schedule.days : null;
        if(!window.state) window.state = {};
        if(!state.schedule) state.schedule = {};
        state.schedule.days = v;
        daysDisplayText.textContent = String(v);
        if (isUser && prevDays !== v) {
          try{ __adminDayCountCommit_(v); }catch(_e){}
        }
        try{ daysDisplay.setAttribute('aria-expanded','false'); }catch(_e){}
        daysMenu.classList.remove('open');
        portalClose_(daysMenu);
                  daysCtrl.classList.remove('menu-open');
try{ renderDays(); }catch(_e){}
        try{ render(); }catch(_e){}
      }

      function buildMenu(){
        daysMenu.innerHTML = '';
        for(let i=1;i<=7;i++){
          const item = document.createElement('div');
          item.className = 'dd-item';
          item.setAttribute('role','option');
          item.dataset.val = String(i);
          item.textContent = String(i);
          item.addEventListener('click', ()=> setDays(i, true));
          daysMenu.appendChild(item);
        }
      }

      function toggleMenu(force){
        const open = daysMenu.classList.contains('open');
        const next = (force==null) ? !open : !!force;
        if(next){
          daysMenu.classList.add('open');
          portalOpen_(daysMenu, daysDisplay);
                    daysCtrl.classList.add('menu-open');
try{ daysDisplay.setAttribute('aria-expanded','true'); }catch(_e){}
        }else{
          daysMenu.classList.remove('open');
          portalClose_(daysMenu);
          try{ daysCtrl.classList.remove('menu-open'); }catch(_e){}
          try{ daysDisplay.setAttribute('aria-expanded','false'); }catch(_e){}
        }
      }

      // (v2.5.83) expose close hook for unified outside-click handling
      try{ window.__closeDaysMenu = ()=> toggleMenu(false); }catch(_e){}

      // initial menu + value
      buildMenu();
      const initial = (state && state.schedule && state.schedule.days)!=null ? state.schedule.days : 1;
      setDays(initial, false);

      daysDisplay.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); toggleMenu(); });
      daysDisplay.addEventListener('keydown', (e)=>{
        if(e.key==='Enter' || e.key===' '){ e.preventDefault(); toggleMenu(); }
        if(e.key==='Escape'){ e.preventDefault(); toggleMenu(false); }
      });
      // (v2.5.83) outside-click close handled by unified doc handler
}catch(_e){}
  }

  // SG selector (UI-only)
  function initSgSelector(){
    try{
      const sgDisplay = document.getElementById('sgDisplay');
      const sgDisplayText = document.getElementById('sgDisplayText');
      const sgMenu = document.getElementById('sgMenu');
      if(!sgDisplay || !sgDisplayText || !sgMenu) return;

      function setSg(v){
        v = Math.max(1, Math.min(4, +v || 1));
        // keep as in-memory UI state only (no persist/broadcast)
        if(state && state.schedule) state.schedule.speedGroups = v;

        
        // Persist+signal: SG count commit (seed missing speedGroups; no overwrite; no prune)
        try{ __adminSgCountCommit_(v); }catch(_e){}
        sgDisplayText.textContent = String(v);
        sgDisplay.classList.remove('sg2','sg3','sg4');
        if (v===2) sgDisplay.classList.add('sg2');
        else if (v===3) sgDisplay.classList.add('sg3');
        else if (v===4) sgDisplay.classList.add('sg4');

        // reflect selection
        const items = sgMenu.querySelectorAll('.sg-item');
        items.forEach(it => {
          const on = (+it.dataset.val === v);
          it.setAttribute('aria-selected', on ? 'true' : 'false');
        });

        // UI-only: show/hide Speed Group rows in the Speed Limits card
        try { applySgCountToSpeedLimitsCard_(v); } catch(e) {}

        // v2.7.17 — keep table SG assignments independent per available SG set
        try{ __sgRestoreIfPossible_(v); }catch(_e){}
        try{ normalizeRowsToGroups(v); }catch(_e){}
        try{ if (typeof window.render === 'function') window.render(); }catch(_e){}
      }

      function applySgCountToSpeedLimitsCard_(count){
        count = Math.max(1, Math.min(4, +count || 1));
        const host = document.getElementById('daysStripInner');
        if(!host) return;
        const card = host.querySelector('[data-kind="speed-limits"]');
        if(!card) return;
        const fields = card.querySelectorAll('.day-field[data-sg]');
        fields.forEach(f=>{
          const sg = +f.dataset.sg || 0;
          f.style.display = (sg>0 && sg<=count) ? '' : 'none';
        });
      }

      function isOpen(){ return sgMenu.classList.contains('open'); }
      function toggle(open){
        const want = (open==null) ? !isOpen() : !!open;
        sgMenu.classList.toggle('open', want);
        if(want) portalOpen_(sgMenu, sgDisplay); else portalClose_(sgMenu);
                sgCtrl.classList.toggle('menu-open', want);
sgDisplay.setAttribute('aria-expanded', want ? 'true' : 'false');
      }

      // initial from state (default 1)
      const initial = Math.max(1, Math.min(4, +((state&&state.schedule&&state.schedule.speedGroups)!=null ? state.schedule.speedGroups : 1) || 1));
      setSg(initial);

      sgDisplay.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); toggle(); });
      sgDisplay.addEventListener('keydown', (e)=>{
        if(e.key==='Enter' || e.key===' '){ e.preventDefault(); toggle(true); }
        if(e.key==='Escape'){ e.preventDefault(); toggle(false); }
      });

      sgMenu.addEventListener('click', (e)=>{
        const it = e.target.closest('.sg-item');
        if(!it) return;
        e.preventDefault();
        e.stopPropagation();
        setSg(it.dataset.val);
        toggle(false);
      });
      // (v2.5.83) outside-click close handled by unified doc handler
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') toggle(false); });
    }catch(_e){}
  }
  // Init
  function init(){
    setStickyTop();
    initDays();
    initSgSelector();

    // (v2.5.83) Unified outside-click closer: Days menu, SG menu, Sort menu
    // Keeps sortBtn/sortMenu wiring minimal and avoids duplicated document listeners.
    document.addEventListener('click', (ev)=>{
      try{
        const t = ev.target;
        // Days menu
        const inDays = !!(t && t.closest && t.closest('#daysDisplay, #daysMenu, #daysCtrl'));
        if(!inDays){ try{ window.__closeDaysMenu && window.__closeDaysMenu(); }catch(_e){} }

        // SG menu
        const inSg = !!(t && t.closest && t.closest('#sgDisplay, #sgMenu, #sgCtrl'));
        if(!inSg){ try{ window.__closeSgMenu && window.__closeSgMenu(); }catch(_e){} }

        // Sort menu (simple show/hide via style.display)
        const inSort = !!(t && t.closest && t.closest('#sortBtn, #sortMenu'));
        if(!inSort){
          const sm = document.getElementById('sortMenu');
          if(sm && sm.style && sm.style.display === 'block'){ sm.style.display = 'none'; }
        }
      }catch(_e){}
    }, true); // capture so "click-away" works even if inner handlers stopPropagation


    // Apply defaults only from state (no persist during boot)
    try{ normalizeRowsToGroups((state && state.schedule) ? state.schedule.speedGroups : 1); }catch(_e){}

    try{
      const v = Math.max(1, Math.min(4, +((state&&state.schedule&&state.schedule.speedGroups)!=null ? state.schedule.speedGroups : 1) || 1));
      state.schedule.speedGroups = v;
      sgDisplayText.textContent = String(v);
      sgDisplay.classList.remove('sg2','sg3','sg4');
      if (v===2) sgDisplay.classList.add('sg2');
      else if (v===3) sgDisplay.classList.add('sg3');
      else if (v===4) sgDisplay.classList.add('sg4');
    }catch(_e){}

    try{ syncSgBridge_(); }catch(_e){}

    // Initial render (read-only; no TD_RALLIES writes here)
    try{ renderDays(); render(); }catch(_e){}

    try{ armEntriesObserver_(); }catch(_e){}
    try{ initSgCellMenu(); }catch(_e){}
    try{ initYearCellMenu(); }catch(_e){}
  }
  init();

  // expose for sort menu
  window.appState = state;
  window.render = render;
  window.state = state;
    window.__ADMIN_STATE__ = state;
  window.blankRow = blankRow;
</script>
<!-- v2.3.88 Row Actions Menu -->
<script>try{if(typeof state!=='undefined') window.state = state;}catch(e){}</script>
<script id="rowCtxMenuController">
// v2.3.88: Clean controller (planner-style menu + DOM-native actions)
(function(){
  if (window._rowCtxInit) return; window._rowCtxInit = true;
  var lastRow = null;

  
  // v2.3.130 — Row clipboard + helpers
  var rowClipboard = null;

  // SG select option sync (needed for paste/copy before SG menu ever opened)
  function syncSgSelectOptions_(selectEl){
    try{
      if(!selectEl) return;
      var sched = (window.state && window.state.schedule) ? window.state.schedule : {};
      var groups = Math.max(1, Number(sched.speedGroups || 1));
      var limits = Array.isArray(sched.speedLimits) ? sched.speedLimits.slice(0,4) : [90,80,70,60];
      var curN = selectEl.options ? selectEl.options.length : 0;
      var ok = (curN === groups);
      if(ok){
        for(var i=0;i<groups;i++){
          var opt = selectEl.options[i];
          if(!opt || String(opt.value)!==String(i+1)) { ok=false; break; }
        }
      }
      if(ok) return;
      var keep = String(selectEl.value||'');
      selectEl.innerHTML='';
      for(var j=0;j<groups;j++){
        var n=j+1;
        var speed = (j < limits.length && limits[j] != null) ? limits[j] : '';
        var o=document.createElement('option');
        o.className='sg'+n;
        o.value=String(n);
        o.textContent=String(speed);
        selectEl.appendChild(o);
      }
      if(keep) selectEl.value = keep;
    }catch(_e){}
  }
  function syncAllSgSelects_(){
    try{
      var sels = document.querySelectorAll('td.sg-cell select');
      sels.forEach(function(sel){ syncSgSelectOptions_(sel); });
    }catch(_e){}
  }

  function copyableIndices(){ return [1,2,3,4,5,6,7,8,9]; } // Driver/Nav names, Mobile, Email, Make, Year
  function isRowEmpty(tr){
    var idxs = new Set(copyableIndices());
    var tds = tr ? tr.children : [];
    for (var i=0;i<tds.length;i++){
      if (!idxs.has(i)) continue;
      if (i===9) continue; // SG has a default; don’t block paste into empty rows
      var inp = tds[i] && tds[i].querySelector && tds[i].querySelector('input,textarea');
      if (inp && String(inp.value||'').trim().length) return false;
    }
    return true;
  }
  function readRow(tr){
    var data = {};
    var idxs = copyableIndices();
    for (var k=0;k<idxs.length;k++){
      var i = idxs[k];
      var td = tr.children[i];
      var inp = td && td.querySelector && td.querySelector('input,textarea,select');
      data[i] = inp ? String(inp.value||'') : '';
    }
    return data;
  }
  function writeRow(tr, data){
    var idxs = copyableIndices();
    for (var k=0;k<idxs.length;k++){
      var i = idxs[k];
      var td = tr.children[i];
      var inp = td && td.querySelector && td.querySelector('input,textarea,select');
      if (inp){
        inp.value = data[i] || '';
        try{ inp.dispatchEvent(new Event('input', {bubbles:true})); }catch(_){}
        try{ inp.dispatchEvent(new Event('change', {bubbles:true})); }catch(_){}
        try{ inp.blur(); }catch(_){}
      }
    }
  }
  
  function highlight(tr){
    if (!tr) return;
    tr.classList.add('flash');
    setTimeout(function(){ try{ tr.classList.remove('flash'); }catch(_){ } }, 800);
  }
  function highlightCopy(tr){
    if (!tr) return;
    tr.classList.add('flash-copy');
    setTimeout(function(){ try{ tr.classList.remove('flash-copy'); }catch(_){ } }, 1000);
  }
function ensureMenu(){
    var m = document.getElementById('rowCtxMenu');
    if(!m){
      m = document.createElement('div');
      m.id = 'rowCtxMenu';
      m.className = 'ctx-menu';
      document.body.appendChild(m);
      m.addEventListener('pointerdown', onMenuClick, true);
      m.addEventListener('click', onMenuClick, true);
    }
    // (Re)build contents explicitly so separator & danger always present
    m.innerHTML = '';
    var btnAbove = document.createElement('button');
    btnAbove.type = 'button'; btnAbove.setAttribute('data-cmd','insert-above');
    btnAbove.textContent = 'Insert Entry Above'; m.appendChild(btnAbove);
    var btnBelow = document.createElement('button');
    btnBelow.type = 'button'; btnBelow.setAttribute('data-cmd','insert-below');
    btnBelow.textContent = 'Insert Entry Below'; m.appendChild(btnBelow);
    var btnCopy = document.createElement('button');
    btnCopy.type='button'; btnCopy.setAttribute('data-cmd','copy');
    btnCopy.textContent='Copy row'; m.appendChild(btnCopy);
    var btnPaste = document.createElement('button');
    btnPaste.type='button'; btnPaste.setAttribute('data-cmd','paste');
    btnPaste.textContent='Paste here'; m.appendChild(btnPaste);
    var sep = document.createElement('div');
    sep.className = 'ctx-sep'; sep.setAttribute('role','separator'); m.appendChild(sep);
    var btnDel = document.createElement('button');
    btnDel.type = 'button'; btnDel.className = 'danger'; btnDel.setAttribute('data-cmd','delete');
    btnDel.textContent = 'Delete Entry (Ctrl+Alt+D)'; m.appendChild(btnDel);
    return m;
  }

  function positionBeside(el, menu){
    var r = el.getBoundingClientRect();
    // default position: below
    var left = r.left + 8;
    var topBelow = r.bottom + 8;
    menu.style.display = 'block';
    // measure menu
    var mh = menu.offsetHeight || 180;
    var spaceBelow = window.innerHeight - topBelow;
    if (spaceBelow < mh + 8){
      // flip above
      menu.style.top = (r.top - mh - 8) + 'px';
    } else {
      menu.style.top = topBelow + 'px';
    }
    menu.style.left = left + 'px';
  }

  function closeMenu(){
    var m = document.getElementById('rowCtxMenu');
    if(m) m.style.display = 'none';
    lastRow = null;
  }

  function openMenuFor(gearBtn){
    var m = ensureMenu();
    lastRow = gearBtn ? gearBtn.closest('tr') : null;
    if(!lastRow){ closeMenu(); return; }
    positionBeside(gearBtn, m);
  }

  
  // v2.3.472 — backdoor delete shortcut (Ctrl+Alt+D) (replaces Ctrl+D)
  document.addEventListener('keydown', function(e){
    try{
      const k = String(e.key || '').toLowerCase();
      if (!(e.ctrlKey && e.altKey && !e.shiftKey && k === 'd')) return;

      // prefer lastRow (from gear/context menu), else use the focused element's row
      var tr = null;
      try{ if (typeof lastRow !== 'undefined' && lastRow) tr = lastRow; }catch(_){}
      if (!tr){
        var ae = document.activeElement;
        if (ae && ae.closest) tr = ae.closest('tr');
      }
      if (!tr) return;

      // disallow when sorted
      var sorted = (window.state && window.state.tableSortState && window.state.tableSortState !== 'none');
      if (sorted) return;

      try{ if(!confirm('Delete this entrant row?')) return; }catch(_){}

      var rowIdx = (tr.dataset && typeof tr.dataset.index !== 'undefined') ? parseInt(tr.dataset.index, 10) : -1;
      if (isNaN(rowIdx) || rowIdx < 0) rowIdx = 0;

      if (window.state && Array.isArray(window.state.rows)) {
        // keep same bookkeeping shape as ctx-menu delete
        try{ lastDeleted = { idx: rowIdx, row: window.state.rows[rowIdx] }; }catch(_){}
        window.state.rows.splice(rowIdx, 1);
        resequenceModelEntryIndex_();
        if (typeof window.render === 'function') window.render();
        try{ requestAdminEntriesPersistAfterSettle_('delete_row'); }catch(_e){}

      }

      /* v2.8.60: model resequence only (no DOM renumber) */
      if (typeof recomputeAllStartTimes === 'function') recomputeAllStartTimes();
      try{ if (window.toast) toast('Deleted'); }catch(_){}

      e.preventDefault();
      e.stopPropagation();
    }catch(_){}
  }, true);

function renumber(tbody){
    // Only renumber when table is unsorted
    var sorted = (window.state && window.state.tableSortState && window.state.tableSortState !== 'none');
    if (sorted) return;

    var rows = Array.from(tbody.querySelectorAll('tr'));
    rows.forEach(function(r,i){
      if (r.dataset) {
        r.dataset.index = String(i);
        r.dataset.rowIndex = String(i+1);
        r.dataset.rowId = 'r' + String(i+1).padStart(3,'0');
      }
      var rn = r.querySelector && r.querySelector('.row-num');
      if (rn) rn.textContent = String(i+1);
      var idxSpan = r.querySelector && r.querySelector('.row-index');
      if (idxSpan) idxSpan.textContent = String(i+1);
    });
  }

  // v2.8.60 — model-first entry index resequence (DOM is view only)
  function resequenceModelEntryIndex_(){ try{ var sorted = (window.state && window.state.tableSortState && window.state.tableSortState !== 'none'); if (sorted) return; __normalizeSlots_('resequence'); }catch(_){ } }


  function onMenuClick(e){
    var btn = e.target.closest && e.target.closest('button[data-cmd]');
    if(!btn) return;
    e.preventDefault(); e.stopPropagation();
    var cmd = btn.getAttribute('data-cmd');
    var tr = lastRow, tbody = tr && tr.parentElement;
    if(!tr || !tbody){ closeMenu(); return; }

    try{
            if(cmd === 'copy'){
        rowClipboard = readRow(tr);
        highlightCopy(tr);
      } else if(cmd === 'paste'){
        if(!rowClipboard){ try{ if(window.toast) toast('Nothing to paste'); }catch(_){}; closeMenu(); return; }
        if(!isRowEmpty(tr)){ try{ if(window.toast) toast('Paste allowed only into an empty row'); }catch(_){}; closeMenu(); return; }
        try{ syncAllSgSelects_(); }catch(_e){}
        writeRow(tr, rowClipboard);
        highlight(tr);
      } else if(cmd === 'insert-above'){
        var sorted = (window.state && window.state.tableSortState && window.state.tableSortState !== 'none');
        if (sorted) { closeMenu(); return; }
        var rowIdx = tr.dataset && typeof tr.dataset.index !== 'undefined' ? parseInt(tr.dataset.index,10) : -1;
        if (isNaN(rowIdx) || rowIdx < 0) rowIdx = 0;
        if (window.state && Array.isArray(window.state.rows)) {
          var makeBlank = (window.blankRow || null);
          var newRow = makeBlank ? makeBlank() : null;
          if (!newRow && typeof blankRow === 'function') { newRow = blankRow(); }
          if (newRow) {
            window.state.rows.splice(rowIdx, 0, newRow);
            resequenceModelEntryIndex_();
            if (typeof window.render === 'function') window.render();
        try{ requestAdminEntriesPersistAfterSettle_('rows_action'); }catch(_e){}

            // (engine-room wiring removed)
        }
        }
      }else if(cmd === 'insert-below'){
        var sortedB = (window.state && window.state.tableSortState && window.state.tableSortState !== 'none');
        if (sortedB) { closeMenu(); return; }
        var rowIdxB = tr.dataset && typeof tr.dataset.index !== 'undefined' ? parseInt(tr.dataset.index,10) : -1;
        if (isNaN(rowIdxB) || rowIdxB < 0) rowIdxB = 0;
        if (window.state && Array.isArray(window.state.rows)) {
          var makeBlankB = (window.blankRow || null);
          var newRowB = makeBlankB ? makeBlankB() : null;
          if (!newRowB && typeof blankRow === 'function') { newRowB = blankRow(); }
          if (newRowB) {
            window.state.rows.splice(rowIdxB + 1, 0, newRowB);
            resequenceModelEntryIndex_();
            if (typeof window.render === 'function') window.render();
        try{ requestAdminEntriesPersistAfterSettle_('rows_action'); }catch(_e){}

            // (engine-room wiring removed)
        }
        }
      }else if(cmd === 'delete'){
        var sortedD = (window.state && window.state.tableSortState && window.state.tableSortState !== 'none');
        if (sortedD) { closeMenu(); return; }
        try{
          if(!confirm('Delete this entrant row?')) { closeMenu(); return; }
        }catch(_){}
        if (window.state && Array.isArray(window.state.rows)) {
          var rowIdxD = tr.dataset && typeof tr.dataset.index !== 'undefined' ? parseInt(tr.dataset.index,10) : -1;
          if (isNaN(rowIdxD) || rowIdxD < 0) rowIdxD = 0;
          lastDeleted = { idx: rowIdxD, row: window.state.rows[rowIdxD] };
          window.state.rows.splice(rowIdxD, 1);
          resequenceModelEntryIndex_();
          if (typeof window.render === 'function') window.render();
        try{ requestAdminEntriesPersistAfterSettle_('rows_action'); }catch(_e){}

          // (engine-room wiring removed)
        }
      }
      /* v2.8.60: model resequence only (no DOM renumber) */
      if (typeof recomputeAllStartTimes === 'function') recomputeAllStartTimes();
      try{ if(window.toast) toast(cmd==='copy'?'Copied':(cmd==='paste'?'Pasted':cmd.toUpperCase())); }catch(_){}
    }catch(err){ /* keep console clean */ }
    closeMenu();
  }
  // v2.3.458 — Ctrl+D delete (direct) + Ctrl+Z undo (row-scoped)
  var lastDeleted = null; // { idx:number, row:any }
  function _isTypingContext(el){
    if(!el) return false;
    if(el.isContentEditable) return true;
    var tag = (el.tagName||'').toUpperCase();
    return tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT';
  }
  function _activeRow(){
    if(lastRow) return lastRow;
    var ae = document.activeElement;
    if(!ae) return null;
    var tr = ae.closest ? ae.closest('tr') : null;
    if(tr && tr.closest && tr.closest('#grid')) return tr;
    return null;
  }
  function _rowIndexFromTr(tr){
    var idx = tr && tr.dataset && typeof tr.dataset.index !== 'undefined' ? parseInt(tr.dataset.index,10) : -1;
    if(isNaN(idx) || idx < 0) idx = 0;
    return idx;
  }
  function _deleteRowDirect(tr){
    var sorted = (window.state && window.state.tableSortState && window.state.tableSortState !== 'none');
    if(sorted) return false;
    if(!(window.state && Array.isArray(window.state.rows))) return false;
    var idx = _rowIndexFromTr(tr);
    if(idx < 0 || idx >= window.state.rows.length) return false;
    lastDeleted = { idx: idx, row: window.state.rows[idx] };
    window.state.rows.splice(idx, 1);
    if (typeof window.render === 'function') window.render();
        try{ requestAdminEntriesPersistAfterSettle_('rows_action'); }catch(_e){}

    try{ if(window.toast) toast('Entry deleted — Undo (Ctrl +Z)'); }catch(_){}
    return true;
  }
  function _undoDelete(){
    if(!lastDeleted) return false;
    if(!(window.state && Array.isArray(window.state.rows))) return false;
    var idx = Math.max(0, Math.min(window.state.rows.length, lastDeleted.idx|0));
    window.state.rows.splice(idx, 0, lastDeleted.row);
    lastDeleted = null;
    if (typeof window.render === 'function') window.render();
        try{ requestAdminEntriesPersistAfterSettle_('rows_action'); }catch(_e){}

    try{ if(window.toast) toast('Delete undone'); }catch(_){}
    return true;
  }

  document.addEventListener('keydown', function(e){
    try{
      var isMac = /Mac|iPhone|iPad|iPod/.test(navigator.platform);
      var ctrl = isMac ? e.metaKey : e.ctrlKey;
      if(!ctrl) return;

      // Ctrl+D (bookmark) — hijack only when row context exists and not typing
      if((e.key === 'd' || e.key === 'D') && !e.shiftKey && !e.altKey){
        if(_isTypingContext(document.activeElement)) return;
        var tr = _activeRow();
        if(!tr) return;
        e.preventDefault();
        e.stopPropagation();
        _deleteRowDirect(tr);
        closeMenu();
        return;
      }

      // Ctrl+Z — undo last delete (only when we have one queued) and not typing
      if((e.key === 'z' || e.key === 'Z') && !e.shiftKey && !e.altKey){
        if(_isTypingContext(document.activeElement)) return;
        if(!lastDeleted) return;
        e.preventDefault();
        e.stopPropagation();
        _undoDelete();
        return;
      }
    }catch(_){}
  }, true);


  // Open on gear click (support both class names)
  ['pointerdown','mousedown','click'].forEach(function(type){
    document.addEventListener(type, function(e){
      var gear = e.target.closest && e.target.closest('button.gear, .row-gear');
      if(gear){ e.preventDefault(); e.stopPropagation(); openMenuFor(gear); }
    }, true);
  });

  // Close behaviour (outside click / scroll / resize / esc)
  window.addEventListener('pointerdown', function(e){
    var m = document.getElementById('rowCtxMenu');
    if(!m || m.style.display === 'none') return;
    if(m.contains(e.target)) return;
    if(e.target.closest('button.gear, .row-gear')) return;
    closeMenu();
  }, true);
  window.addEventListener('scroll', function(){
    try{
      var m = document.getElementById('rowCtxMenu');
      if(m && m.style.display === 'block') closeMenu();
    }catch(_e){}
  }, true);
window.addEventListener('resize', closeMenu, true);
  window.addEventListener('keydown', function(e){ if(e.key === 'Escape') closeMenu(); }, true);

  document.addEventListener('DOMContentLoaded', ensureMenu);
})();
</script>
<script>
// v2.3.126: Unified enhancer (select-all on focus, clean typing, strict commit gating)
  // Sticky header offset calibration
  function updateStickyHeaderOffsets(){
    try{
      var r1 = document.querySelector('thead tr.row1');
      var h1 = r1 ? Math.ceil(r1.getBoundingClientRect().height) : 0;
      if (h1 && isFinite(h1)){
        document.documentElement.style.setProperty('--hdr1', h1 + 'px');
      }
    }catch(_){}
  }
  window.addEventListener('resize', function(){ try{ updateStickyHeaderOffsets(); }catch(_){} }, {passive:true});
  
  setTimeout(function(){ try{ updateStickyHeaderOffsets(); }catch(_){} }, 0);


/* TABLE_INPUT_GUARDS_REMOVED: clean table; no handleCommit / normalization / synthetic change dispatch */


  // keep sticky overlay header in sync with horizontal table scroll
(function syncOverlayHeader(){
  const tableWrap = document.querySelector('.table-wrap');
  const overlayHeader = document.getElementById('overlayHeader');
  if (!tableWrap || !overlayHeader) return;
  const applySync = () => {
    const kids = overlayHeader.children.length ? Array.from(overlayHeader.children) : [overlayHeader];
    const offset = tableWrap.scrollLeft;
    const tw = tableWrap.scrollWidth;
    kids.forEach(el => {
      el.style.width = tw + 'px';
      el.style.transform = `translateX(-${offset}px)`;
    });
  };
  tableWrap.addEventListener('scroll', applySync, { passive: true });
  applySync();
})();
</script>
<div id="sortMenu" style="display:none;background:#fff;border:1px solid #ddd;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.08);min-width:180px;z-index:5000;"><div data-action="sort-none" style="padding:8px 12px;font-weight:600;cursor:pointer;">Ref Entry (restore)</div><div data-action="sort-sg-asc" style="padding:6px 12px;border-top:1px solid #eee;cursor:pointer;">Speed Groups 1 → 4</div><div data-action="sort-sg-desc" style="padding:6px 12px;border-top:1px solid #eee;cursor:pointer;">Speed Groups 4 → 1</div></div>
<script>
// 

// // attach menu click after DOM is ready and menu exists
(function(){
  const sortMenu = document.getElementById('sortMenu');
  if (!sortMenu) return;
  

  /* removed redundant sortMenu click handler (kept single pipeline) */


})();
</script>
<script>
function applySortedUiState(sorted) {
  const addBtn = document.getElementById('addRowBtn') || document.getElementById('addBtn');
  const sortBtnEl = document.getElementById('sortBtn');
  const gears = document.querySelectorAll('.gear, .row-gear, .entry-gear');
  const isSorted = !!sorted;

  if (addBtn) {
    addBtn.disabled = isSorted;
    addBtn.classList.toggle('disabled', isSorted);
  }
  if (sortBtnEl) {
    sortBtnEl.classList.toggle('is-sorted', isSorted);
  }
  gears.forEach(g => {
    g.style.display = isSorted ? 'none' : '';
    g.style.pointerEvents = isSorted ? 'none' : '';
  });

  // v2.8.91 — When sorted, lock SG speed limits (inputs + −/+ buttons) like Add Row.
  try{
    const sgInputs = document.querySelectorAll('input.sg-limit');
    sgInputs.forEach(inp=>{
      try{ inp.disabled = isSorted; }catch(_e){}
      try{ inp.classList.toggle('disabled', isSorted); }catch(_e){}
      const wrap = inp.closest && inp.closest('.pm-wrap');
      if (wrap){
        const btns = wrap.querySelectorAll('button.pm-btn');
        btns.forEach(b=>{
          try{ b.disabled = isSorted; }catch(_e){}
          try{ b.classList.toggle('disabled', isSorted); }catch(_e){}
        });
      }
    });
  }catch(_e){}
}

if (window.state && typeof applySortedUiState === 'function') {
  applySortedUiState(((window.state.tableSortState || 'none') !== 'none'));
}
</script>
<script>
(function(){
  if (!window.__toastInit) {
    window.__toastInit = true;
    window.showToast = function(msg){
      var bar = document.getElementById('toastBar');
      if (!bar) return;
      bar.textContent = msg;
      bar.classList.add('show');
      setTimeout(function(){ bar.classList.remove('show'); }, 2800);
    };
  try{ window.toast = window.showToast; }catch(_){ }
  }
})();
</script>
<div aria-live="polite" id="toastBar" role="status"></div><!-- Restored Admin Entries (Google world) card markup from v2.4.92 (UI shell) --><div id="adminEntriesCardRoot"><div aria-hidden="true" class="modal-overlay adcard" id="entriesOverlay"><section aria-labelledby="entriesTitle" aria-modal="true" id="entriesPanel" role="dialog"><header class="modal-header"><h2 id="entriesTitle">Administration</h2><span class="adbadge warn" id="connectionStatus" style="margin-left:12px;">Not connected</span><button class="adbtn ghost adsmall" id="closeBtn" type="button">Close</button></header><div class="sections"><div class="ad-engineBand" id="engineBand"><section class="adsection compact ad-mt6"><div class="adrow ad-rowHead"><div class="ad-flexRow"><h3 class="ad-h3" id="dataBandTitle">Entry data</h3></div><div class="section-actions ad-actionsRow"><button class="adbtn ghost micro off" id="viewResponsesBtn" type="button">View Response forms</button><button class="adbtn adsmall off" id="openControlsBtn" type="button">Open entry data</button><button class="adbtn adsmall off" id="downloadControlsBtn" type="button">Download entry data</button></div></div></section><section class="adsection compact ad-mt6"><p class="note adsmall ad-noteHelper">Text for Google form header - edit as required</p><div class="adrow ad-rowWrap"><input aria-label="Entry form header text" class="rectHeaderInput ad-formHeaderInput" id="cdEntryHeaderInput" type="text" value="Rally test"/><span class="spacer"></span><button class="adbtn adsmall secondary off" id="cdUploadBtn" type="button">Upload entry data</button></div></section></div><div class="card admin-card" id="adminCard" style="margin-top:6px;padding:8px 10px;"><section aria-labelledby="adminEntryLinkTitle" class="adsection" style="margin-top:8px;"><div class="adrow" style="align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;margin:4px 0 6px"><h3 id="adminEntryLinkTitle" style="margin:0">Entry link</h3><div class="section-actions"><button class="adbtn adsmall off" disabled="" id="copyForm" type="button">Copy link</button><button class="adbtn adsmall off" id="sendLinkBtn" type="button">Email link</button><button class="adbtn adsmall whatsapp off" id="waTestBtn" type="button">WhatsApp</button></div></div></section><h3 style="margin:6px 2px 2px;">Setup</h3><section aria-labelledby="linkTitle" class="adsection" style="margin-top:8px;"><div class="adrow"><p class="note adsmall" style="margin:0 0 6px">Organisers mobile number, required to enable WhatsApp connection</p></div><div class="adrow" style="align-items:center;gap:18px;flex-wrap:wrap"><label style="margin:0;padding-top:0;display:flex;align-items:center">Mobile number (must include +27)</label><div style="display:flex;justify-content:space-between;align-items:center;flex:1 1 auto;flex-wrap:wrap"><div style="display:flex;gap:8px;"><input id="orgMobile" placeholder="e.g. +27 82 123 4567" type="tel"/></div></div></div><a href="#" id="formUrl" rel="noopener" style="display:none" target="_blank"></a><a href="#" id="sheetUrl" rel="noopener" style="display:none" target="_blank"></a></section><section aria-labelledby="connTitle" class="adsection" style="margin-top:8px;"><div style="display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:8px;margin-bottom:4px"><h3 id="connTitle" style="margin:0">Google connection</h3><span></span><span></span></div><p class="note adsmall">Paste the Web App URL from your Apps Script deployment and test it.</p><div class="adrow" style="align-items:center;gap:18px;flex-wrap:wrap"><button class="adbadge ghost" id="clearUrlBtn" type="button">Clear</button><input id="webAppUrl" placeholder="Enter Google Web App URL here" style="flex:1 1 260px;min-width:220px" type="text"/><button class="adbtn adsmall" id="saveTestBtn" type="button">Save &amp; test</button></div></section><section aria-labelledby="setupTitle" class="adsection" style="padding:8px 10px;margin-top:8px"><div class="adrow" style="align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;margin:4px 0"><h3 id="setupTitle" style="margin:0;font-size:14px;">First time setup</h3><div class="section-actions"><button class="adbtn adsmall" id="openCodeGsBtn" type="button">Open Code.gs file</button><button class="adbtn adsmall" id="openSetupGuideBtn" type="button">Setting up guide</button></div></div></section></div></div><div aria-live="polite" class="adtoast" id="toast" role="status"></div></section></div></div><!-- v2.3.465 — SG limits bridge for Admin Entries card (host-owned, card reads by id) --><div id="adminSgBridge" style="display:none"><input id="sg1Value" type="number"/><input id="sg2Value" type="number"/><input id="sg3Value" type="number"/><input id="sg4Value" type="number"/><input id="sg2Enabled" type="checkbox"/><input id="sg3Enabled" type="checkbox"/><input id="sg4Enabled" type="checkbox"/></div>
<script id="adminEntriesCardModule">
(() => {
 // Admin Shell v1.48
 // Tidy-only pass: comments + dead hooks removed (no behaviour changes).


 const COMMON_KEY = 'rally_common_settings_v1';
 // LINK CONFIG (single source of truth)
 // Prefer relative paths when running from the same mother folder.
 // Change these later if your file layout or hosting changes.
 const LINKS = {
  CODE_GS_URL: './Code.gs',
  SETUP_GUIDE_URL: './Setup_Guide.html'
 };


 const $ = (id) => document.getElementById(id);

 function safeParse(s){ try { return JSON.parse(s); } catch { return null; } }
 function loadCommon(){ return safeParse(localStorage.getItem(COMMON_KEY)) || {}; }
 function commonHasSavedUrl(c){
  return !!(((c && c.webAppUrl) || '').trim());
 }
 function saveCommon(obj){
  const o = (obj && typeof obj === 'object') ? obj : {};
  try{ delete o.rallyTitle; delete o.rallyTitleCard; delete o.rxxx; }catch(_e){}
  localStorage.setItem(COMMON_KEY, JSON.stringify(o));
}

 // Org Mobile: live-persist to COMMON after webAppUrl is saved
 document.addEventListener('DOMContentLoaded', function(){
  try{
   const mobEl = $('orgMobile');
   if(!mobEl || mobEl.__lsBound) return;
   mobEl.__lsBound = true;
   const commit = ()=>{
    const c = loadCommon();
    if(!commonHasSavedUrl(c)) return; // Do not create/write COMMON until webAppUrl has been savedl webAppUrl has been saved
    c.mobile = (mobEl.value || '').trim();
    saveCommon(c);
    if (typeof setUploadBtnState_ === 'function') setUploadBtnState_();
  window._setEntriesBtnGate_();
   };
   mobEl.addEventListener('input', commit);
   mobEl.addEventListener('blur', commit);
  }catch(_){ }
 });


 function pop(msg, tone='info'){
  const el = $('toast');
  if (!el){ return; }
  el.textContent = msg;
  el.className = 'adtoast show ' + tone;
  clearTimeout(pop._t);
  pop._t = setTimeout(() => { el.className = 'adtoast'; }, 2400);
 }

 function openLink(url){
  if (!url){ pop('Link not set', 'bad'); return; }
  try { window.open(url, '_blank', 'noopener'); }
  catch { pop('Popup blocked – please allow popups or use right-click open.', 'info'); }
 }


function popHold(msg, tone='info'){
  const el = $('toast');
  // Special-case placement for the Loading toast only.
  if (el){
   if ((msg || '').toString().toLowerCase().startsWith('loading')) el.dataset.kind = 'loading';
   else delete el.dataset.kind;
  }
  if (!el){ return; }
  clearTimeout(pop._t);
  el.textContent = msg;
  el.className = 'adtoast show ' + tone;
 }

 function popClear(){
  const el = $('toast');
  if (!el) return;
  clearTimeout(pop._t);
  delete el.dataset.kind;
  el.className = 'adtoast';
 }

  function setConnected(isOk){
  const badge = $('connectionStatus');
  if (!badge) return;
  if (isOk){
   badge.textContent = 'Connected';
   badge.className = 'adbadge ok';
  } else {
   badge.textContent = 'Not connected';
   badge.className = 'adbadge warn';
  }
 }

 
 
  // v2.8.43 — Entries button gate (GLOBAL): TD_RALLIES present only
  window._setEntriesBtnGate_ = function _setEntriesBtnGate_(){
    try{
      const btn = $('entriesBtn');
      if (!btn) return;

      // v2.8.34: Entries button gating = TD_RALLIES present only.
      const hasStore = !!localStorage.getItem('TD_RALLIES');

      btn.disabled = !hasStore;
      btn.setAttribute('aria-disabled', hasStore ? 'false' : 'true');
      btn.classList.toggle('disabled', !hasStore);
    }catch(_e){}
  }


function isActionReady_(){
  const common = loadCommon();
  const base = (common.webAppUrl || '').trim();
  const rallyName = (typeof _getCommittedPageRallyTitle_ === 'function') ? _getCommittedPageRallyTitle_() : '';
  return !!(base && common.connected && String(rallyName||'').trim());
 }

 function setUploadBtnState_(){
  const btn = $('cdUploadBtn');
  if (!btn) return;
  const ready = isActionReady_();
  btn.disabled = !ready;
  btn.classList.toggle('off', !ready);
 }


// v2.8.34 — Entries card gating (streamlined):
// - Card can open anytime (for URL + Save/Test)
// - Actions that touch Google require committed page rally title (TD_RALLIES meta.title)
function setEntriesCardGate_(){
  try{
    const common = loadCommon();
    const base = (common.webAppUrl || '').trim();
    const connected = !!common.connected;
    const title = (typeof _getCommittedPageRallyTitle_ === 'function') ? _getCommittedPageRallyTitle_() : '';
    const hasTitle = !!String(title||'').trim();

    // Upload requires: URL + connected + committed title
    const uploadOk = !!(base && connected && hasTitle);
    const up = $('cdUploadBtn');
    if (up){
      up.disabled = !uploadOk;
      up.classList.toggle('off', !uploadOk);
    }

    // Other entry actions: OFF until we have the same base readiness; once ready, applyAdminStatus_ will refine.
    if (!uploadOk){
      setBtnState_('viewResponsesBtn', false);
      setBtnState_('openControlsBtn', false);
      setBtnState_('downloadControlsBtn', false);
      setBtnState_('copyForm', false);
      setBtnState_('sendLinkBtn', false);
      setBtnState_('waTestBtn', false);
    } else {
      try{ applyAdminStatus_ && applyAdminStatus_(adminStatus_ || null); }catch(_e){}
    }
  }catch(_e){}
}

 
 // Live (non-persisted) status from Google world, refreshed on card open.
 let adminStatus_ = null;

 let _statusTimer_ = null;

 function setBtnState_(id, on){
  const btn = $(id);
  if (!btn) return;

  // Guard: block "Download entry data" while table is in a sorted state
  try{
    if (id === 'downloadControlsBtn'){
      const st = (window.__ADMIN_STATE__ || window.state || window.appState || null);
      if (st && st.tableSortState && st.tableSortState !== 'none') on = false;
    }
  }catch(_e){}

  btn.disabled = !on;
  btn.classList.toggle('off', !on);
 }

 function applyAdminStatus_(st){
  adminStatus_ = st && st.ok ? st : null;

  // Entry data section
  // Treat "entry data" as the *working rally spreadsheet/tab*, not any generic script/config spreadsheet.
  const hasAdminEntries = !!(adminStatus_ && (adminStatus_.hasAdminEntries || adminStatus_.hasEntriesSheet || adminStatus_.hasEntriesTab));
  const canViewResponses = !!(adminStatus_ && (adminStatus_.responsesFolderUrl || adminStatus_.responseFolderUrl || hasAdminEntries));

  const entryDataUrl = (((adminStatus_ && (adminStatus_.entriesSheetUrl || adminStatus_.entriesSpreadsheetUrl || adminStatus_.entriesTabUrl)) || '')).trim();
  const hasRows = !!(adminStatus_ && (adminStatus_.hasAdminEntriesRows || adminStatus_.hasEntriesRows || adminStatus_.entriesRows > 0));
  const canOpenEntryData = !!(entryDataUrl && (hasRows || hasAdminEntries));

  const canDownload = !!(adminStatus_ && (adminStatus_.hasAdminEntriesRows || adminStatus_.hasEntriesTab || adminStatus_.canDownloadEntries));

  setBtnState_('viewResponsesBtn', canViewResponses);
  setBtnState_('openControlsBtn', canOpenEntryData);
  setBtnState_('downloadControlsBtn', canDownload);

  // Entry link section
  const hasForm = !!(adminStatus_ && (adminStatus_.entryFormUrl || adminStatus_.entrantFormUrl || adminStatus_.formUrl) && (adminStatus_.hasEntryForm !== false));
  setBtnState_('copyForm', hasForm);
  setBtnState_('sendLinkBtn', hasForm);
  setBtnState_('waTestBtn', hasForm);
 }

 async function refreshAdminStatus_(opts={}){
  const common = loadCommon();
  const base = (common.webAppUrl || '').trim();
  const rallyName = getRallyName();

  if (!(base && common.connected && rallyName)){
   // Only force everything OFF when we're genuinely not ready.
   applyAdminStatus_(null);
   if (!opts.silent) popClear();
   return;
  }

  if (!opts.silent) popHold('Loading', 'info');
  try{
   const url = buildModeUrl(base, 'adminStatus', {
    rallyName,
    dayLabel: (loadCommon().dayLabel || ''),
    ts: Date.now()
   });
   const res = await fetch(url, { method:'GET', cache:'no-store' });
   const data = await res.json();
   applyAdminStatus_(data);
  }catch(err){
   applyAdminStatus_(null);
  }finally{
   if (!opts.silent) popClear();
  }
 }

 function getEntryFormUrl_(){
  if (!adminStatus_) return '';
  return (adminStatus_.entryFormUrl || adminStatus_.entrantFormUrl || adminStatus_.formUrl || '').trim();
 }

 function openEntryData_(){
  const u = adminStatus_ && (adminStatus_.entriesSheetUrl || adminStatus_.spreadsheetUrl || adminStatus_.sheetUrl || '').trim();
  if (!u) return notWired('Open entry data (no URL yet)');
  window.open(u, '_blank', 'noopener');
 }

 function openResponsesFolder_(){
  // Admin requirement: open the responses SHEET URL (one level up), with NO fallback to the working sheet.
  const u = adminStatus_ && (adminStatus_.responsesSheetUrl || adminStatus_.responsesFolderUrl || adminStatus_.responseFolderUrl || '').trim();
  if (!u) return notWired('View response forms (no URL yet)');
  window.open(u, '_blank', 'noopener');
 }

 function copyEntryLink_(){
  const u = getEntryFormUrl_();
  if (!u) return notWired('Copy link (no form URL yet)');
  const p = (navigator.clipboard && navigator.clipboard.writeText)
   ? navigator.clipboard.writeText(u)
   : Promise.reject(new Error('Clipboard unavailable'));
  p.then(
   () => pop('Link copied'),
   () => pop('Copy failed', 'warn')
  );
 }

 function emailEntryLink_(){
  const u = getEntryFormUrl_();
  if (!u) return notWired('Email link (no form URL yet)');
  pop('Opening email…');
  const subj = encodeURIComponent(`Rally entry link: ${getRallyName()}`);
  const body = encodeURIComponent(`Entry link:
${u}
`);
  window.location.href = `mailto:?subject=${subj}&body=${body}`;
 }

 function waEntryLink_(){
  const u = getEntryFormUrl_();
  if (!u) return notWired('WhatsApp link (no form URL yet)');
  pop('Opening WhatsApp…');
  const msg = encodeURIComponent(`Rally entry link: ${u}`);
  window.open(`https://wa.me/?text=${msg}`, '_blank', 'noopener');
 }

function setBtnBusy_(btn, busy, label){
  if (!btn) return;
  if (busy){
   if (!btn.dataset.origHtml) btn.dataset.origHtml = btn.innerHTML;
   btn.disabled = true;
   btn.classList.add('busy');
   btn.innerHTML = `${label || 'Working'} <span class="dots5" aria-hidden="true"><i></i><i></i><i></i><i></i><i></i></span>`;
  } else {
   btn.classList.remove('busy');
   btn.disabled = !isActionReady_();
   btn.classList.toggle('off', btn.disabled);
   if (btn.dataset.origHtml){
    btn.innerHTML = btn.dataset.origHtml;
   }
  }
 }
function syncFromStorage(){
  const common = loadCommon();
  const entries = ({});

  const webAppUrl = $('webAppUrl');
  const mobile = $('orgMobile'); // actual id in UI
  if (webAppUrl) webAppUrl.value = common.webAppUrl || '';
  if (mobile) mobile.value = common.mobile || '';

  const rallyTitle = $('rallyTitleInput');
  if (rallyTitle) rallyTitle.value = common.rallyTitle || rallyTitle.value || '';

  // Show bound rally identity (folder key) on card
  if ($('cdRallyKeyText')) $('cdRallyKeyText').textContent = (common.rallyTitle || 'Rally').trim();
  if ($('cdRallyTitlePill')) $('cdRallyTitlePill').textContent = (common.rallyTitle || 'Rally').trim();

  // Entry form header text (card field): default from committed page rally title until user edits.
  if ($('cdEntryHeaderInput')) {
   const common2 = loadCommon();
   const __pageTitle = (typeof _getCommittedPageRallyTitle_ === 'function') ? _getCommittedPageRallyTitle_() : '';
   const rt = String(__pageTitle || '').trim() || 'Rally';
   const edited = !!common2.entryFormHeaderEdited;
   const cur = (common2.entryFormHeaderText || '').toString().trim();
   const desired = edited ? (cur || rt) : rt;

   // IMPORTANT: do NOT auto-write COMMON just by opening the card.
   $('cdEntryHeaderInput').value = desired;
  }

  setConnected(!!common.connected);
  setUploadBtnState_();
  setEntriesCardGate_();

  // Render downloaded entries if present
// v2.4.1 — hydrate last state from TD_RALLIES (SG/day cards + entries) (disabled in clean build)

  // Note: no hidden URL fields are rendered in this shell (kept card-only).
 }

 function getRallyName(){
  // Identity key for Google storage: ALWAYS use committed page rally title (TD_RALLIES).
  const t = (typeof _getCommittedPageRallyTitle_ === 'function') ? _getCommittedPageRallyTitle_() : '';
  return String(t||'').trim();
 }

 function getEntryFormHeaderText(defaultText){
  // Card input (what appears on the Google Form header/title)
  const el = document.getElementById('entryHeaderInput') || $('entryHeaderInput') || $('cdEntryHeaderInput');
  const v = (el ? el.value : '').toString().trim();
  return v || (defaultText || 'Rally');
 }

  function closeEntries(){
  const ov = document.getElementById('entriesOverlay');
  if (!ov) return;
  ov.classList.remove('open');
  ov.setAttribute('aria-hidden','true');
  if (_statusTimer_){ clearInterval(_statusTimer_); _statusTimer_ = null; }
 }

 function openEntries(){
  const ov = document.getElementById('entriesOverlay');
  if (!ov) return;
  ov.classList.add('open');
  ov.setAttribute('aria-hidden','false');
  // Refresh UI from latest settings and perform live status ping (no cached flags)
  syncFromStorage();
  refreshAdminStatus_();

  // While the card is open, re-ping status periodically so buttons (e.g. Download)
  // reflect changes that happen in Google world (like new form submissions).
  if (_statusTimer_) clearInterval(_statusTimer_);
  _statusTimer_ = setInterval(() => {
   refreshAdminStatus_({ silent: true });
  }, 20000);
 }

  function buildPingUrl(base){
  // base should be the Web App URL. Append mode=ping safely.
  return buildModeUrl(base, 'ping', { ts: Date.now() });
 }

 function buildModeUrl(base, mode, params){
  const u = new URL(base);
  u.searchParams.set('mode', mode);
  if (params){
   Object.keys(params).forEach(k => u.searchParams.set(k, params[k]));
  }
  return u.toString();
 }

 async function saveAndTestCommon(){
  const webAppUrl = ($('webAppUrl')?.value || '').trim();
  const mobile = ($('orgMobile')?.value || '').trim();

  const common = loadCommon();
  common.webAppUrl = webAppUrl;
  common.mobile = mobile;
  common.connected = false;
  saveCommon(common);
  setUploadBtnState_();
  setConnected(false);
  setUploadBtnState_();
  setEntriesCardGate_();

  if (!webAppUrl){
   pop('Saved. Paste your Google Web App URL to test.', 'warn');
   return;
  }

  popHold('Connecting…', 'info');
  try {
   const res = await fetch(buildPingUrl(webAppUrl), { method: 'GET' });
   const txt = await res.text();
   let data = null;
   try { data = JSON.parse(txt); } catch { /* non-json */ }

   // Accept either {ok:true} or any 2xx response as a "basic reachable" pass
   const ok = res.ok && (data?.ok === true || data?.status === 'ok' || data?.success === true || data === null);
   common.connected = !!ok;
   common.lastPingAt = new Date().toISOString();
   saveCommon(common);
   setConnected(!!ok);
   setUploadBtnState_();
   setEntriesCardGate_();
   if (ok){
    // Immediately fetch Google-side status so lights/URLs refresh.
    popHold('Loading…', 'info');
    await refreshAdminStatus_({ silent: true });
    popClear();
    pop('Connected ✓');
   } else {
    popClear();
    pop('Reached script, but ping did not confirm ok.', 'warn');
   }

  } catch (e){
   common.connected = false;
   common.lastPingAt = new Date().toISOString();
   saveCommon(common);
   setConnected(false);
   setUploadBtnState_();
   popClear();
   pop('Connection failed. Check URL / deployment access.', 'warn');
  }
 }

 // v2.7.15 export: make card handlers visible to non-module wiring blocks
 window.saveAndTestCommon = saveAndTestCommon;
 // v2.8.81 fix: expose Upload handler for host wiring
 try{ window.uploadEntriesToGoogle = uploadEntriesToGoogle; }catch(_e){}

 function notWired(which){
  pop(`${which}: not wired yet (shell).`, 'warn');
 }

 


function getRallyTitleFromPill(){
  const el = document.getElementById('rallyTitlePill');
  const t = (el ? el.textContent : '').toString().trim();
  if (!t) return '';
  if (t.toLowerCase() === 'enter rally title') return '';
  return t;
}

function getRallyTitleFromTD_(){
  // Source of truth for page/rally title: TD_RALLIES[activeRid].meta.title
  try{
    const td = (typeof _lsReadTdObjSafe_ === 'function') ? _lsReadTdObjSafe_() : null;
    if (!td || typeof td !== 'object') return '';
    const rid = (td.global && td.global.activeRallyId) ? td.global.activeRallyId : (td.global && td.global.lastRallyId) ? td.global.lastRallyId : (window.__ACTIVE_RID__ || 'RID-DEV');
    const r = (td.rallies && td.rallies[rid]) ? td.rallies[rid] : null;
    const t = r && r.meta ? (r.meta.title || '') : '';
    return (t || '').toString().trim();
  }catch(_e){ return ''; }
}

async function uploadEntriesToGoogle(){
  const btn = $('cdUploadBtn');
  const common = loadCommon();
  const base = (common.webAppUrl || '').trim();
  const rallyTitle = getRallyTitleFromTD_() || getRallyTitleFromPill();
  const rallyName = rallyTitle;

  if (!base){
    pop('Paste and Save & test your Web App URL first.', 'warn');
    return;
  }
  if (!common.connected){
    pop('Not connected. Click Save & test first.', 'warn');
    return;
  }
  if (!rallyTitle){
    pop('Set a Rally Title on the page first.', 'warn');
    return;
  }

  setBtnBusy_(btn, true, 'Uploading');
  popHold('Creating rally in Google…', 'info');

  try{
    // Ask Apps Script to create/ensure the rally folder + required artifacts.
    // Client sends details in POST body; mode in query string for routing.
    const headerText = getEntryFormHeaderText(rallyTitle || 'Rally');

    common.rallyTitle = rallyTitle;
    saveCommon(common);

    // v2.8.48 — include SG config in the same shape as the proven working build (speedGroups.sg1..sg4)
    // Source of truth: TD_RALLIES → rallies[rid] → admin.ui.sgCount + admin.speedGroups
    const rid = (typeof __getRidForAdmin_ === 'function') ? __getRidForAdmin_() : 'RID-DEV';
    let sgCount = 1;
    let speedGroups = {
      sg1: { enabled: false, speed: 60 },
      sg2: { enabled: false, speed: 60 },
      sg3: { enabled: false, speed: 60 },
      sg4: { enabled: false, speed: 60 }
    };
    try{
      const td = (typeof _lsReadTdObjSafe_ === 'function') ? _lsReadTdObjSafe_() : null;
      const r = td && td.rallies && td.rallies[rid] ? td.rallies[rid] : null;
      const uiCount = r && r.admin && r.admin.ui ? Number(r.admin.ui.sgCount||0) : 0;
      const sgObj = r && r.admin && r.admin.speedGroups && typeof r.admin.speedGroups === 'object' ? r.admin.speedGroups : null;
      if (uiCount) sgCount = Math.max(1, Math.min(4, uiCount));
      for (let i=1;i<=4;i++){
        const enabled = (i<=sgCount);
        let sp = 60;
        if (sgObj){
          const g = sgObj[i] || sgObj[String(i)] || null;
          const n = g && (g.speed!=null) ? Number(g.speed) : NaN;
          if (Number.isFinite(n)) sp = n;
        }
        speedGroups['sg'+i] = { enabled, speed: sp };
      }
    }catch(_e){}

    const payload = {
      rallyTitle,
      rallyName,
      speedGroups,
      // Code.gs expects one of: entryFormHeaderText OR entryFormTitle
      entryFormHeaderText: headerText,
      entryFormTitle: headerText,
      mobile: (common.mobile || '')
    };
    const navUrl = buildModeUrl(base, 'uploadEntries', {
      data: JSON.stringify(payload),
      ts: Date.now()
    });
// Google Apps Script Web Apps do not reliably support CORS for fetch() from file:// or other origins.
    // Send via fetch (no-cors). Response is opaque but the server-side script still runs.
    try { await fetch(navUrl, { mode:'no-cors' }); } catch(_e){}
    pop('Google request sent.', 'ok');
    try{ _adminSetGoogleStamp_('upload'); }catch(_e){}

}catch(err){
    console.error(err);
    pop('Google upload failed (network/error). Check console.', 'warn');
  }finally{
    setBtnBusy_(btn, false);
  }
}

async function downloadEntriesFromGoogle(){
  const btn = $('downloadControlsBtn');
  const common = loadCommon();
  const base = (common.webAppUrl || '').trim();
  const rallyName = getRallyName();

  // BULK IMPORT GUARD — silence writes during download/apply
  const __prevMute = !!window.BOOT_MUTE;
  window.BOOT_MUTE = true;
  let __restoreScheduled = false;
  try{
    try{
      if (_adminPersistRouter && _adminPersistRouter.timers && _adminPersistRouter.timers['rows']){
        clearTimeout(_adminPersistRouter.timers['rows']);
        _adminPersistRouter.timers['rows'] = null;
      }
      _adminPersistSetPending_('rows', false);
    }catch(_e){}
  }catch(_e){}

  if (!base){
    pop('Paste and Save & test your Web App URL first.', 'warn');
    return;
  }
  if (!common.connected){
    pop('Not connected. Click Save & test first.', 'warn');
    return;
  }

  setBtnBusy_(btn, true, 'Downloading');

  try{
    const url = buildModeUrl(base, 'downloadEntries', { rallyName, ts: Date.now() });
    const res = await fetch(url, { method: 'GET' });
    const txt = await res.text();
    let data = null;
    try{ data = JSON.parse(txt); }catch(_){}

    if (!data || !data.ok){
      const msg = (data && (data.error || data.message)) ? (data.error || data.message) : 'Download failed';
      pop('Download failed: ' + msg, 'bad');
      return;
    }

    const rows = Array.isArray(data.rows) ? data.rows : [];

    // --- Map Google rows -> Admin grid row model (in-memory only until post-settle persist) ---
    const cur = window.state || {};
    const limits = (cur.schedule && Array.isArray(cur.schedule.speedLimits)) ? cur.schedule.speedLimits : null;
    const maxSg = Math.max(1, Number(cur.schedule && cur.schedule.speedGroups || 4));

    const mapSgIndex = (val)=> {
      const raw = String(val ?? '').trim();
      if (!raw) return 1;
      const n = Number(raw);
      // If already an index (1..maxSg), keep it (unless it also matches a known speedLimit)
      if (Number.isFinite(n) && Number.isInteger(n) && n >= 1 && n <= maxSg){
        if (Array.isArray(limits)){
          const idxBySpeed = limits.findIndex(s => Number(s) === n);
          if (idxBySpeed >= 0) return idxBySpeed + 1;
        }
        return n;
      }
      // Otherwise map by speed value to SG index (best-effort)
      if (Array.isArray(limits)){
        const idx = limits.findIndex(s => Number(s) === n);
        if (idx >= 0) return idx + 1;
      }
      return 1;
    };

    const payload = rows.map((a, i)=> {
      a = Array.isArray(a) ? a : [];
      return {
        index: i + 1,
        rallyNo: i + 1, // slot identity is top-to-bottom
        speedGroup: (function(){
          const v = a[10];
          const n = parseInt(String(v ?? '').trim(), 10);
          if (Number.isFinite(n) && n >= 1) return Math.min(n, maxSg);
          return mapSgIndex(a[9]);
        })(),
        driver:   { first: String(a[1] ?? ''), last: String(a[2] ?? ''), mobile: String(a[5] ?? ''), email: String(a[6] ?? '') },
        navigator:{ first: String(a[3] ?? ''), last: String(a[4] ?? '') },
        car:      { make: String(a[7] ?? ''), year: String(a[8] ?? '') }
      };
    });

    // Reset sort (download applies canonical order)
    try{ if (window.state) window.state.tableSortState = 'none'; }catch(_e){}
    try{ if (typeof applySortedUiState === 'function') applySortedUiState(false); }catch(_e){}

    // Ensure grid exists
    if (!window.state || !Array.isArray(window.state.rows)){
      pop('Admin table not ready.', 'warn');
      return;
    }

    // Default 10 rows; grow if needed
    const MIN_ROWS = 10;
    const desiredLen = Math.max(MIN_ROWS, payload.length);

    const makeBlank = (window.blankRow || null) || ((typeof blankRow === 'function') ? blankRow : null);
    while (window.state.rows.length < desiredLen){
      let nr = null;
      try{ nr = makeBlank ? makeBlank() : null; }catch(_){ nr = null; }
      if (!nr) break;
      window.state.rows.push(nr);
    }

    // Populate only the downloaded row count; leave remaining defaults untouched
    for (let i=0; i<payload.length; i++){
      const dst = window.state.rows[i] || {};
      const src = payload[i];

      dst.index = i + 1;
      dst.rallyNo = i + 1;
      dst.speedGroup = Number(src.speedGroup) || 1;

      dst.driver = dst.driver && typeof dst.driver === 'object' ? dst.driver : {};
      dst.driver.first  = String(src.driver.first || '');
      dst.driver.last   = String(src.driver.last || '');
      dst.driver.mobile = String(src.driver.mobile || '');
      dst.driver.email  = String(src.driver.email || '');

      dst.navigator = dst.navigator && typeof dst.navigator === 'object' ? dst.navigator : {};
      dst.navigator.first = String(src.navigator.first || '');
      dst.navigator.last  = String(src.navigator.last || '');

      dst.car = dst.car && typeof dst.car === 'object' ? dst.car : {};
      dst.car.make = String(src.car.make || '');
      dst.car.year = String(src.car.year || '');

      window.state.rows[i] = dst;
    }

    // Render main grid
    try{ if (typeof window.render === 'function') window.render(); }catch(_e){}

    // Post-settle: restore mute, then persist via the single existing pipeline (TD_RALLIES only)
    try{
      requestAnimationFrame(()=>{ requestAnimationFrame(()=> {
        try{ window.BOOT_MUTE = __prevMute; }catch(_e){}
        __restoreScheduled = true;
        try{
          const hasStore = !!localStorage.getItem('TD_RALLIES');
          if (hasStore && typeof requestAdminEntriesPersistAfterSettle_ === 'function'){
            requestAdminEntriesPersistAfterSettle_('google_download');
          }
        }catch(_e){}
      }); });
    }catch(_e){
      try{ window.BOOT_MUTE = __prevMute; }catch(_e){}
      __restoreScheduled = true;
      try{
        const hasStore = !!localStorage.getItem('TD_RALLIES');
        if (hasStore && typeof requestAdminEntriesPersistAfterSettle_ === 'function'){
          requestAdminEntriesPersistAfterSettle_('google_download');
        }
      }catch(_e){}
    }

  }catch(e){
    pop('Download failed: ' + (e?.message || String(e)), 'bad');
  }    try{ _adminSetGoogleStamp_('download'); }catch(_e){}

finally{
    setBtnBusy_(btn, false);
    if (!__restoreScheduled){
      try{ window.BOOT_MUTE = __prevMute; }catch(_e){}
    }
  }
}


 // ===== Wiring =====
 // Close controls
 document.getElementById('closeBtn')?.addEventListener('click', closeEntries);
 document.getElementById('entriesOverlay')?.addEventListener('click', (e) => {
  if (e.target === document.getElementById('entriesOverlay')) closeEntries();
 });

 // Open Entries (UI shell)
 const entriesBtn = document.getElementById('entriesBtn');
 if (entriesBtn) entriesBtn.addEventListener('click', openEntries);

 
 // ===== Entries card actions wiring (restored from v2.8.68) =====
 // These are inside the card IIFE so they can call the local helper functions.
 document.getElementById('downloadControlsBtn')?.addEventListener('click', (e)=>{ try{ downloadEntriesFromGoogle(e); }catch(err){ console.error(err);} });
 document.getElementById('openControlsBtn')?.addEventListener('click', (e)=>{ try{ openEntryData_(); }catch(err){ console.error(err);} });
 document.getElementById('viewResponsesBtn')?.addEventListener('click', (e)=>{ try{ openResponsesFolder_(); }catch(err){ console.error(err);} });

 document.getElementById('copyForm')?.addEventListener('click', (e)=>{ try{ copyEntryLink_(); }catch(err){ console.error(err);} });
 document.getElementById('sendLinkBtn')?.addEventListener('click', (e)=>{ try{ emailEntryLink_(); }catch(err){ console.error(err);} });
 document.getElementById('waTestBtn')?.addEventListener('click', (e)=>{ try{ waEntryLink_(); }catch(err){ console.error(err);} });


// v2.7.10 — delegated wiring so Entries keeps working even if actions bar is rebuilt
 document.addEventListener('click', (e) => {
  const t = e.target;
  if (!t) return;
  if (t.id === 'entriesBtn') {
   try { openEntries(); } catch (_e) {}
  }
  if (t.id === 'closeBtn') {
   try { closeEntries(); } catch (_e) {}
  }
 }, true);


 // Tools menu
 const toolsBtn = document.getElementById('toolsBtn');
 const toolsMenu = document.getElementById('toolsMenu');
 let __toolsOpen = false;
 function __closeToolsMenu(){
  if (!toolsMenu) return;
  toolsMenu.style.display = 'none';
  __toolsOpen = false;
 }
 function __openToolsMenu(){
  if (!toolsBtn || !toolsMenu) return;
  // Position under the Tools button (robust vs sticky/scroll containers)
  const r = toolsBtn.getBoundingClientRect();
  const x = r.right;
  const y = r.bottom;
  // Use fixed positioning so it doesn't drift with scroll containers
  toolsMenu.style.position = 'fixed';
  toolsMenu.style.left = Math.max(8, x - (toolsMenu.offsetWidth || 180)) + 'px';
  toolsMenu.style.top  = (y + 6) + 'px';
  toolsMenu.style.display = 'block';
  __toolsOpen = true;
 }
 function __toggleToolsMenu(){
  if (!toolsMenu) return;
  if (__toolsOpen) __closeToolsMenu(); else __openToolsMenu();
 }
 if (toolsBtn && toolsMenu && !toolsBtn.__wired){
  toolsBtn.__wired = true;
  toolsBtn.addEventListener('click', (e)=>{
   e.preventDefault();
   e.stopPropagation();
   __toggleToolsMenu();
  });
  // Close on outside click / ESC
  document.addEventListener('click', (e)=>{
   if (!__toolsOpen) return;
   if (e.target === toolsBtn) return;
   if (toolsMenu.contains(e.target)) return;
   __closeToolsMenu();
  }, true);
  document.addEventListener('keydown', (e)=>{
   if (!__toolsOpen) return;
   if (e.key === 'Escape') __closeToolsMenu();
  }, true);
  // Prevent menu clicks from closing via bubbling
// Tools menu dispatcher (wired actions only)
  toolsMenu.addEventListener('click', (e)=>{
    // Keep menu interaction from triggering document click-away closer
    e.stopPropagation();
    const item = e.target && e.target.closest ? e.target.closest('.item[data-action]') : null;
    if (!item) return;
    // Disabled items do nothing
    if (item.classList.contains('disabled') || item.getAttribute('aria-disabled') === 'true') return;

    const action = item.getAttribute('data-action') || '';
    if (action === 'set-workspace'){
      e.preventDefault();
      e.stopPropagation();
      if (typeof __setRallyWorkspaceFlow === 'function') __setRallyWorkspaceFlow();
      return;
    }
    if (action === 'save-as'){
      e.preventDefault();
      e.stopPropagation();
      try{ (typeof openSaveAsModal === 'function') && openSaveAsModal(); }catch(_e){}
      return;
    }
    if (action === 'load'){
      e.preventDefault();
      e.stopPropagation();
      try{ __closeToolsMenu && __closeToolsMenu(); }catch(_e){}
      try{ (typeof startLoadFlow_ === 'function') && startLoadFlow_(); }catch(_e){}
      return;
    }

    if (action === 'new-rally'){
      e.preventDefault();
      e.stopPropagation();
      try{ (typeof window.newRally === 'function') && window.newRally(); }catch(_e){}
      return;
    }
    // Other actions not wired yet (leave silent)
  }, true);
 }

  
  // Tools menu actions (Workspace + gating) — transplanted from v2.4.46 (safe subset)
  window.__WORKSPACE = window.__WORKSPACE || {
    ready: false,        // true when we have a handle (even if permission still 'prompt')
    handle: null,        // FileSystemDirectoryHandle
    label: '',
    perm: 'prompt'       // 'granted' | 'denied' | 'prompt'
  };

  function __setToolsItemEnabled(action, enabled){
    if (!toolsMenu) return;
    const el = toolsMenu.querySelector('.item[data-action="'+action+'"]');
    if (!el) return;
    if (enabled){
      el.classList.remove('disabled');
      el.removeAttribute('aria-disabled');
    }else{
      el.classList.add('disabled');
      el.setAttribute('aria-disabled','true');
    }
  }

  function __applyWorkspaceGates(){
    // New Rally is local-only (no workspace required).
    __setToolsItemEnabled('new-rally', true);
__setToolsItemEnabled('save-as', !!window.__WORKSPACE.ready);
    __setToolsItemEnabled('load',    !!window.__WORKSPACE.ready);
  }
  // New Rally modal + reset flow (v2.8.70)
  function __openNewRallyModal_(){
    return new Promise((resolve)=>{
      const modal = document.getElementById('newRallyModal');
      const inp   = document.getElementById('newRallyTitleInput');
      const okBtn = document.getElementById('newRallyOkBtn');
      const cxBtn = document.getElementById('newRallyCancelBtn');
      const bkg   = document.getElementById('newRallyBackdrop');

      if (!modal || !inp || !okBtn || !cxBtn){
        resolve(null);
        return;
      }

      let done = false;
      function close(v){
        if (done) return;
        done = true;
        try{ modal.style.display = 'none'; }catch(_e){}
        cleanup();
        resolve(v);
      }
      function cleanup(){
        try{ okBtn.removeEventListener('click', onOk); }catch(_e){}
        try{ cxBtn.removeEventListener('click', onCancel); }catch(_e){}
        try{ bkg && bkg.removeEventListener('click', onCancel); }catch(_e){}
        try{ inp.removeEventListener('keydown', onKey); }catch(_e){}
      }
      function onOk(e){
        try{ e && e.preventDefault && e.preventDefault(); }catch(_e){}
        const v = String(inp.value||'').trim() || 'New Rally';
        close(v);
      }
      function onCancel(e){
        try{ e && e.preventDefault && e.preventDefault(); }catch(_e){}
        close(null);
      }
      function onKey(e){
        if (!e) return;
        if (e.key === 'Enter'){ onOk(e); }
        if (e.key === 'Escape'){ onCancel(e); }
      }

      try{ inp.value = ''; }catch(_e){}
      try{ inp.placeholder = 'New Rally'; }catch(_e){}
      try{ modal.style.display = 'block'; }catch(_e){}
      try{ inp.focus(); inp.select && inp.select(); }catch(_e){}
      okBtn.addEventListener('click', onOk);
      cxBtn.addEventListener('click', onCancel);
      if (bkg) bkg.addEventListener('click', onCancel);
      inp.addEventListener('keydown', onKey);
    });
  }

  // Single entry point used by Tools menu dispatcher
  window.newRally = async function(){
    try{
      const t = await __openNewRallyModal_();
      try{ __closeToolsMenu && __closeToolsMenu(); }catch(_e){}
      if (!t) return;

      // New Rally is local-only: clear TD_RALLIES and restart from clean defaults.
      // Distinct reset signal (not tied to title/dates/store churn)
      try{
        const bc = new BroadcastChannel('TD_RALLY_RESET');
        bc.postMessage({ reason:'new_rally', ts: Date.now() });
        try{ bc.close && bc.close(); }catch(__e){}
      }catch(_e){}
      try{ sessionStorage.setItem('TD_PENDING_NEW_RALLY_TITLE', String(t)); }catch(_e){}
      try{ localStorage.removeItem(TD_RALLIES_KEY); }catch(_e){}
      try{ location.reload(); }catch(_e){}
    }catch(_e){}
  };


  // --- IndexedDB: store workspace handle + label (persist across reloads)
  const __WS_IDB_DB    = 'TD_WORKSPACE_DB_v1';
  const __WS_IDB_STORE = 'kvs';

  function __wsIdbOpen_(){
    return new Promise((resolve, reject)=>{
      try{
        const rq = indexedDB.open(__WS_IDB_DB, 1);
        rq.onupgradeneeded = ()=>{
          const db = rq.result;
          if (!db.objectStoreNames.contains(__WS_IDB_STORE)){
            db.createObjectStore(__WS_IDB_STORE);
          }
        };
        rq.onsuccess = ()=>resolve(rq.result);
        rq.onerror   = ()=>reject(rq.error);
      }catch(err){ reject(err); }
    });
  }

  async function __wsIdbPut_(key, value){
    const db = await __wsIdbOpen_();
    return new Promise((resolve, reject)=>{
      try{
        const tx = db.transaction(__WS_IDB_STORE, 'readwrite');
        tx.oncomplete = ()=>{ try{ db.close(); }catch(_e){}; resolve(true); };
        tx.onerror = ()=>{ try{ db.close(); }catch(_e){}; reject(tx.error || new Error('IDB put failed')); };
        const st = tx.objectStore(__WS_IDB_STORE);
        st.put(value, key);
      }catch(err){ try{ db.close(); }catch(_e){}; reject(err); }
    });
  }

  async function __wsIdbGet_(key){
    const db = await __wsIdbOpen_();
    return new Promise((resolve, reject)=>{
      try{
        const tx = db.transaction(__WS_IDB_STORE, 'readonly');
        tx.oncomplete = ()=>{ try{ db.close(); }catch(_e){}; };
        tx.onerror = ()=>{ try{ db.close(); }catch(_e){}; reject(tx.error || new Error('IDB get failed')); };
        const st = tx.objectStore(__WS_IDB_STORE);
        const rq = st.get(key);
        rq.onsuccess = ()=>resolve(rq.result);
        rq.onerror   = ()=>reject(rq.error);
      }catch(err){ try{ db.close(); }catch(_e){}; reject(err); }
    });
  }

  async function __restoreWorkspaceFromIdb_(){
    try{
      if (!('indexedDB' in window)) return;
      const handle = await __wsIdbGet_('workspaceDirHandle');
      const label  = await __wsIdbGet_('workspaceLabel');
      if (!handle) return;

      // Quiet permission check: do not prompt on load.
      let perm = 'prompt';
      try{ perm = await handle.queryPermission({mode:'readwrite'}); }catch(_e){}
      window.__WORKSPACE.perm   = perm;
      window.__WORKSPACE.handle = handle;
      window.__WORKSPACE.label  = label || (handle.name || 'Workspace');
      window.__WORKSPACE.ready  = true;

      __applyWorkspaceGates();
    }catch(_e){
      // ignore restore failures
    }
  }

  async function __setRallyWorkspaceFlow(){
    // File System Access API requires a secure context.
    if (!window.isSecureContext){
      if (window.showToast) window.showToast('Set Rally Workspace requires https or localhost');
      __closeToolsMenu();
      return;
    }
    if (!window.showDirectoryPicker){
      if (window.showToast) window.showToast('Folder picker not supported (use Chrome/Edge)');
      __closeToolsMenu();
      return;
    }

    try{
      const baseDir = await window.showDirectoryPicker({ id: 'rally-workspace', mode: 'readwrite' });
      // Workspace root is the folder the user picked (no extra subfolder).
      const ws = baseDir;

      // Request permission now (explicit user gesture)
      let perm = 'prompt';
      try{
        if (ws.requestPermission){
          perm = await ws.requestPermission({mode:'readwrite'});
        }else if (ws.queryPermission){
          perm = await ws.queryPermission({mode:'readwrite'});
        }
      }catch(_e){}

      if (perm && perm !== 'granted'){
        window.__WORKSPACE.perm = perm;
        if (window.showToast) window.showToast('Workspace permission not granted');
        __closeToolsMenu();
        return;
      }

      window.__WORKSPACE.handle = ws;
      window.__WORKSPACE.perm   = 'granted';
            window.__WORKSPACE.label  = (baseDir && baseDir.name ? baseDir.name : 'Workspace');
      window.__WORKSPACE.ready  = true;

      // Persist to IDB
      try{
        await __wsIdbPut_('workspaceDirHandle', ws);
        await __wsIdbPut_('workspaceLabel', window.__WORKSPACE.label);
      }catch(e){
        // If persistence fails, still keep it for the session.
        if (window.showToast) window.showToast('Workspace set (note: could not save for reload)');
      }

      
      __applyWorkspaceGates();

      // v2.8.23 — publish workspace status (Admin is source of truth; other pages listen only)
      try{
        const rid = (typeof __getRidForAdmin_ === 'function') ? (__getRidForAdmin_() || '') : String(window.__ACTIVE_RID__ || 'RID-DEV');
        const root = (typeof _lsReadTdObjSafe_ === 'function') ? (_lsReadTdObjSafe_() || null) : null;
        if (root && typeof root === 'object'){
          root.global = (root.global && typeof root.global === 'object') ? root.global : {};
          root.global.workspaceReady = true;
          root.global.workspaceLabel = String(window.__WORKSPACE && window.__WORKSPACE.label ? window.__WORKSPACE.label : '');
          try{ _lsWriteTdObjSafe_ && _lsWriteTdObjSafe_(root); }catch(_e){}
          try{ emitTdChanged_ && emitTdChanged_({ rid, branch:'global', reason:'workspace_set' }); }catch(_e){}
        }
      }catch(_e){}

      __closeToolsMenu();
      if (window.showToast) window.showToast('Workspace set');
    }catch(e){
      // Silent only on user cancel
      if (e && (e.name === 'AbortError' || e.code === 20)) {
        return;
      }
      const msg = (e && (e.message || e.name)) ? (e.message || e.name) : 'Unknown error';
      if (window.showToast) window.showToast('Workspace not set: ' + msg);
      __closeToolsMenu();
    }
  }

  

  // (v2.8.70) Tools menu actions are handled by the single dispatcher above.




// v2.8.81: lightweight +/- pill controls (match v2.8.68 look; simple wiring)
function pmClamp(v, lo, hi){
  v = Number(v);
  if (!Number.isFinite(v)) v = 0;
  if (lo != null) v = Math.max(Number(lo), v);
  if (hi != null) v = Math.min(Number(hi), v);
  return v;
}
function pmWrapInput(inp){
  try{
    if(!inp || inp.dataset.pmWrapped) return;
    // only for numeric inputs
    if(String(inp.type||'').toLowerCase() !== 'number') return;
    inp.dataset.pmWrapped = "1";
    const min = (inp.min!=='' && inp.min!=null) ? Number(inp.min) : null;
    const max = (inp.max!=='' && inp.max!=null) ? Number(inp.max) : null;
    const stepAttr = (inp.step!=='' && inp.step!=null) ? Number(inp.step) : 1;
    let step = (Number.isFinite(stepAttr) && stepAttr>0) ? stepAttr : 1;
    // Requirement: Increment Min +/- uses step 0.5 (30s) regardless of input step
    try{ if (inp.classList && inp.classList.contains('inc-min')) step = 0.5; }catch(_e){}
    const wrap=document.createElement('span'); wrap.className='pm-wrap';
    const bDec=document.createElement('button'); bDec.type='button'; bDec.textContent='-'; bDec.className='pm-btn';
    const bInc=document.createElement('button'); bInc.type='button'; bInc.textContent='+'; bInc.className='pm-btn';
    const parent=inp.parentNode;
    if(!parent) return;
    parent.insertBefore(wrap, inp);
    wrap.append(bDec, inp, bInc);

    const bump = (dir)=>{
      let cur = Number(inp.value);
      if(!Number.isFinite(cur)) cur = 0;
      let next = cur + dir*step;
      next = pmClamp(next, min, max);
      // keep integer display for integer steps; otherwise 1dp (fits increment min)
      if (Math.abs(step - Math.round(step)) < 1e-9) {
        inp.value = String(Math.round(next));
      } else {
        inp.value = String(Number(next).toFixed(1));
      }
      inp.dispatchEvent(new Event('input',{bubbles:true}));
      inp.dispatchEvent(new Event('change',{bubbles:true}));
    };
    bDec.addEventListener('click', ()=>bump(-1));
    bInc.addEventListener('click', ()=>bump(+1));
  }catch(_e){}
}



// v2.8.81: ensure clampIncMin exists (used by Increment Min control)
function clampIncMin(v){
  let n = Number(v);
  if (!Number.isFinite(n)) n = 1.0;
  n = Math.max(0, Math.min(9.5, n));
  // snap to 0.5 minutes (matches prior spinner-only intent)
  n = Math.round(n * 2) / 2;
  return n;
}

// After DOM ready + after day cards render
document.addEventListener('DOMContentLoaded', ()=>{
  try{
    const attachPM = ()=>{
      // Speed Limits pills + Increment Min pills only
      document.querySelectorAll('#daysStripInner .day-col[data-kind="speed-limits"] input.sg-limit, input.inc-min').forEach(pmWrapInput);
    };
    attachPM();
    // Observe for dynamic re-renders (day strip rebuilds)
    const obs=new MutationObserver(()=>attachPM());
    obs.observe(document.body,{subtree:true,childList:true});
  }catch(e){}
});


// v2.8.83: Boot-time IDB workspace restore (quiet). Single hook; no prompts.
document.addEventListener('DOMContentLoaded', ()=>{
  try{ __restoreWorkspaceFromIdb_(); }catch(_e){}
},{once:true});

})();
</script>

<script>
// Restored from v2.4.99 old ref: custom horizontal scroller + dummy header slab
function initEntriesOverlay() {
    if (document.getElementById('entriesOverlaySlab')) return;

    var actionsPanel = document.getElementById('actionsPanel');
    var tablePanel   = document.querySelector('.panel.table-panel');
    var tableWrap    = tablePanel && tablePanel.querySelector('.table-wrap');
    var grid         = document.getElementById('grid');
    var colgroup     = grid && grid.querySelector('colgroup');
    var thead        = grid && grid.tHead;

    if (!actionsPanel || !tablePanel || !tableWrap || !grid || !colgroup || !thead) {
      return;
    }

    var container = actionsPanel.parentElement;

    // Build overlay container
    var overlay = document.createElement('div');
    overlay.id = 'entriesOverlaySlab';

        // 12px comfort spacer above Actions (overlay remains sticky at top:0)
    var spacer = document.createElement('div');
    spacer.id = 'entriesOverlaySpacer';

    // Spacer sits above Actions (comfort gap)
    overlay.appendChild(spacer);

    // Move actions panel into overlay (no sticky on the panel itself)
    overlay.appendChild(actionsPanel);

actionsPanel.style.position = 'static';
    actionsPanel.style.top = '';
    actionsPanel.style.zIndex = '';
    actionsPanel.style.marginTop = '0px';
    actionsPanel.style.marginBottom = '0px';
    actionsPanel.style.marginBottom = '0';

    // Horizontal scroller row
    var scrollerOuter = document.createElement('div');
    scrollerOuter.id = 'entriesOverlayScroller';
    var scrollerInner = document.createElement('div');
    scrollerInner.id = 'entriesOverlayScrollerInner';
    scrollerOuter.appendChild(scrollerInner);
    overlay.appendChild(scrollerOuter);

    // Spacer under horizontal scroller (v2.3.440)
    var scrollerSpacer = document.createElement('div');
    scrollerSpacer.id = 'entriesOverlayScrollerSpacer';
    overlay.appendChild(scrollerSpacer);

    // Dummy header shell (div-based overlay header)
    var headerShell = document.createElement('div');
    headerShell.id = 'entriesOverlayHeader';
    var headerInner = document.createElement('div');
    headerInner.id  = 'entriesOverlayHeaderInner';
    headerShell.appendChild(headerInner);
    overlay.appendChild(headerShell);

    // Insert overlay before the table panel
    container.insertBefore(overlay, tablePanel);

    // Hide the real thead on screen; prints still use the real table header
    grid.classList.add('hide-thead');

    function buildOverlayHeader() {
      if (!grid.tBodies.length || !grid.tBodies[0].rows.length) return;

      var bodyRow  = grid.tBodies[0].rows[0];
      var bodyTds  = Array.prototype.slice.call(bodyRow.cells);
      var widths   = bodyTds.map(function(td) {
        return td.getBoundingClientRect().width;
      });

      var headRows = Array.prototype.slice.call(thead.rows || []);
      if (headRows.length < 2) return;

      var topCells    = Array.prototype.slice.call(headRows[0].cells);
      var bottomCells = Array.prototype.slice.call(headRows[1].cells);

      headerInner.innerHTML = '';

      // Row 1: group labels with colSpan
      var row1 = document.createElement('div');
      row1.className = 'oh-row row-1';
      var colIndex = 0;
      topCells.forEach(function(cell) {
        var span = cell.colSpan || 1;
        var w = 0;
        for (var i = 0; i < span; i++) {
          w += widths[colIndex + i] || 0;
        }
        var div = document.createElement('div');
        div.className = 'oh-cell';
        if (w) div.style.width = w + 'px';
        div.textContent = cell.textContent.trim();
        row1.appendChild(div);
        colIndex += span;
      });
      headerInner.appendChild(row1);

      // Row 2: leaf column labels, one per body column
      var row2 = document.createElement('div');
      row2.className = 'oh-row row-2';
      bottomCells.forEach(function(cell, i) {
        var div = document.createElement('div');
        div.className = 'oh-cell';
        var w = widths[i] || 0;
        if (w) div.style.width = w + 'px';
        div.textContent = cell.textContent.trim();
        row2.appendChild(div);
      });
      headerInner.appendChild(row2);
    }

    function updateWidths() {
      var tableWidth = tableWrap.scrollWidth || 0;
      var outerWidth = scrollerOuter.clientWidth || 0;
      var ghostWidth = Math.max(tableWidth, outerWidth + 400, 2000);
      scrollerInner.style.width = ghostWidth + 'px';
      if (tableWidth) {
        headerInner.style.width = tableWidth + 'px';
      }
    }

    function syncHeaderOffset() {
      headerInner.style.transform = 'translateX(-' + tableWrap.scrollLeft + 'px)';
    }

    function alignTableToDummy(force) {
      var firstRow = grid.querySelector('tbody tr');
      if (!firstRow) return;

      // v2.7.17: Avoid recalibrating while the user is vertically scrolled.
      // The dummy header is sticky; measuring mid-scroll can bake in a bad offset (white band).
      if (!force) {
        var y = (window.scrollY || document.documentElement.scrollTop || 0);
        if (y > 4) return;
      }

      // Reset any previous offset so we measure from the natural position
      tableWrap.style.marginTop = '0px';

      var dummyBottom = headerShell.getBoundingClientRect().bottom;
      var firstTop    = firstRow.getBoundingClientRect().top;
      var delta       = firstTop - dummyBottom;

      // Clamp to avoid pathological large offsets (prevents big white bands).
      var offset = (-delta);
      var MAX_OFF = 160; // generous safety bound
      if (!isFinite(offset)) offset = 0;
      if (offset >  MAX_OFF) offset =  MAX_OFF;
      if (offset < -MAX_OFF) offset = -MAX_OFF;

      tableWrap.style.marginTop = offset + 'px';
    }

    // v2.7.17: Self-heal - when user returns to the top, force a safe re-align once.
    var __alignTopQueued = false;
    function requestAlignAtTop() {
      if (__alignTopQueued) return;
      __alignTopQueued = true;
      requestAnimationFrame(function() {
        __alignTopQueued = false;
        var y = (window.scrollY || document.documentElement.scrollTop || 0);
        if (y <= 4) alignTableToDummy(true);
      });
    }


    buildOverlayHeader();
    updateWidths();
    syncHeaderOffset();
    alignTableToDummy();

    var fromTable = false;
    var fromOverlay = false;

    tableWrap.addEventListener('scroll', function() {
      if (fromOverlay) return;
      fromTable = true;
      scrollerOuter.scrollLeft = tableWrap.scrollLeft;
      syncHeaderOffset();
      fromTable = false;
    }, { passive: true });

    scrollerOuter.addEventListener('scroll', function() {
      if (fromTable) return;
      fromOverlay = true;
      tableWrap.scrollLeft = scrollerOuter.scrollLeft;
      syncHeaderOffset();
      fromOverlay = false;
    }, { passive: true });

    if ('MutationObserver' in window && thead) {
      var mo = new MutationObserver(function() {
        buildOverlayHeader();
        updateWidths();
        syncHeaderOffset();
        alignTableToDummy();
      });
      mo.observe(thead, { childList: true, subtree: true, attributes: true });
    }

    window.addEventListener('resize', function() {
      buildOverlayHeader();
      updateWidths();
      syncHeaderOffset();
      alignTableToDummy();
    });

    // v2.7.17: When returning to the very top, re-align once to clear any stale shim.
    window.addEventListener('scroll', function() {
      var y = (window.scrollY || document.documentElement.scrollTop || 0);
      if (y <= 6) requestAlignAtTop();
    }, { passive: true });
  }

(function(){
  try{
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function(){ try{ initEntriesOverlay(); }catch(_e){} }, { once:true });
    } else {
      initEntriesOverlay();
    }
  }catch(_e){}
})();
</script>

<!-- ================= ENGINE ROOM (UI-only placeholder) v0.0 ================= -->


<!-- TRACE/BOOT LOG removed in v2.6.61 -->

<!-- ER5d3 removed legacy overlay scroller module -->


<!-- Rally Title confirm modal  --><div id="titleConfirmModal" style="display:none; position:fixed; inset:0; width:100vw; height:100vh; z-index:999999; background:rgba(0,0,0,0.35); pointer-events:auto;"><div style="position:absolute; inset:0; display:flex; align-items:flex-start; justify-content:center; padding-top:12vh; pointer-events:auto;"><div id="tcBackdrop" style="position:absolute; inset:0; background:rgba(0,0,0,0.35);"></div><div style="position:relative; width:min(520px, calc(100vw - 24px)); background:#fff; border-radius:18px; box-shadow:0 12px 40px rgba(0,0,0,0.35); padding:18px 18px 14px;"><div style="font-weight:700; font-size:16px; margin-bottom:10px;">Confirm Rally Title</div><div style="font-size:13px; opacity:0.85; margin-bottom:10px;">Is the title correct?</div><div id="tcTitleText" style="font-size:14px; font-weight:700; padding:10px 12px; border:1px solid #cbd5e1; border-radius:12px; background:#f8fafc; margin-bottom:14px; word-break:break-word;"></div><div style="display:flex; justify-content:flex-end; gap:10px;"><button id="tcBackBtn" style="border:1px solid #cbd5e1; background:#fff; padding:10px 18px; border-radius:999px; font-weight:700; cursor:pointer;">Back</button><button id="tcConfirmBtn" style="border:0; background:#111827; color:#fff; padding:10px 22px; border-radius:999px; font-weight:700; cursor:pointer;">Confirm</button></div></div></div></div><!-- Save As modal -->
<!-- Load warning modal -->
<div id="loadWarnModal" style="position:fixed;inset:0;background:rgba(15,23,42,0.25);display:none;align-items:center;justify-content:center;z-index:12000;">
  <div style="background:#fff;border-radius:18px;padding:20px 24px;min-width:380px;max-width:520px;box-shadow:0 12px 30px rgba(0,0,0,0.18);">
    <div style="font-weight:800;font-size:16px;margin-bottom:8px;">Load Rally File</div>
    <div style="font-size:13.5px;line-height:1.35;color:#111827;margin-bottom:14px;">
      Loading will overwrite current work. Consider saving first.
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end;">
      <button id="lwCancelBtn" style="border:1px solid #cbd5e1;background:#fff;color:#111827;padding:9px 14px;border-radius:12px;font-weight:700;">Cancel</button>
      <button id="lwOkBtn" style="border:0;background:#111827;color:#fff;padding:9px 14px;border-radius:12px;font-weight:800;">Load…</button>
    </div>
  </div>
</div>

<div id="saveAsModal" aria-hidden="true"><div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="saveAsTitle"><h2 id="saveAsTitle">Save As</h2><p>Enter a new rally title</p><input id="saveAsInput" type="text" autocomplete="off" /><div class="btnrow"><button class="adbtn ghost" id="saveAsCancelBtn" type="button" onclick="try{closeSaveAsModal();}catch(e){console.error(e)}">Cancel</button><button class="adbtn" id="saveAsOkBtn" type="button" onclick="try{(async()=>{const t=document.getElementById('saveAsInput')?.value||''; closeSaveAsModal(); await performSaveAs_(t);})()}catch(e){console.error(e); try{toast && toast(String(e));}catch(_){}}">OK</button></div></div></div>

<!-- === PRINT MENU + PRINT BUILDERS (from v2.4.45) === -->
<script>
function ensurePrintMenu(){
    let menu = document.getElementById('printMenu');
    if (!menu){
      menu = document.createElement('div');
      menu.id = 'printMenu';
      menu.className = 'ctx-menu';
      menu.setAttribute('role','menu');

      menu.addEventListener('click', function(ev){
        const btn = ev.target.closest('button');
        if (!btn || !btn.dataset.printMode) return;
        const mode = btn.dataset.printMode;
        document.body.setAttribute('data-print-mode', mode);
        closePrintMenu();
        window.print();
        setTimeout(function(){
          document.body.removeAttribute('data-print-mode');
        }, 1000);
      });

      document.body.appendChild(menu);

      document.addEventListener('click', function(ev){
        const m = document.getElementById('printMenu');
        const btn = document.getElementById('printBtn');
        if (!m || m.style.display !== 'block') return;
        if (!m.contains(ev.target) && ev.target !== btn){
          closePrintMenu();
        }
      }, true);

      document.addEventListener('keydown', function(ev){
        if (ev.key === 'Escape'){
          closePrintMenu();
        }
      });

      window.addEventListener('resize', function(){
        const m = document.getElementById('printMenu');
        if (m && m.style.display === 'block') positionPrintMenu(m);
      });

      window.addEventListener('scroll', function(){
        const m = document.getElementById('printMenu');
        if (m && m.style.display === 'block') positionPrintMenu(m);
      }, { passive:true });
    }
    // (Re)build menu items from current day count (Admin is source of truth)
    menu.innerHTML = '';
    // Prefer live DOM day columns (reflects in-session add/remove before any storage commit)
    let days = 0;
    try{
      const host = document.getElementById('daysStripInner');
      if (host){
        const cols = host.querySelectorAll('.day-col');
        // cols[0] is the Speed Limits column; remaining are Day 1..N
        const n = cols ? (cols.length - 1) : 0;
        if (n > 0) days = n;
      }
    }catch(_e){}

    let daysResolved = false;
    try{
      const rid = (typeof __getActiveRidForAdmin_ === 'function') ? __getActiveRidForAdmin_() : (window.__ACTIVE_RID__ || 'RID-DEV');
      const r = (typeof __tdPeekRootForRid_ === 'function') ? __tdPeekRootForRid_(rid) : null;
      if (r){
        const dArr = (r.admin && Array.isArray(r.admin.days) && r.admin.days) ? r.admin.days
                    : (r.schedule && Array.isArray(r.schedule.days) && r.schedule.days) ? r.schedule.days
                    : null;
        if (dArr){ days = dArr.length; daysResolved = true; }
        else if (r.schedule && typeof r.schedule.days === 'number'){ days = r.schedule.days; daysResolved = true; }
        else if (r.admin && typeof r.admin.days === 'number'){ days = r.admin.days; daysResolved = true; }
      }
    }catch(_e){}
    days = Math.max(0, Number(days||0));

    for (let d = 1; d <= days; d++){
      const b = document.createElement('button');
      b.type = 'button';
      b.textContent = 'Print Day ' + d;
      b.dataset.printMode = 'day' + d;
      menu.appendChild(b);
    }

    const sep = document.createElement('div');
    sep.className = 'ctx-sep';
    sep.setAttribute('role','separator');
    menu.appendChild(sep);

    const adminBtn = document.createElement('button');
    adminBtn.type = 'button';
    adminBtn.textContent = 'Print Admin';
    adminBtn.dataset.printMode = 'admin';
    menu.appendChild(adminBtn);

    return menu;
  }

function positionPrintMenu(menu){
    const btn = document.getElementById('printBtn');
    if (!btn || !menu) return;
    const r = btn.getBoundingClientRect();
    const pad = 8;
    menu.style.visibility = 'hidden';
    menu.style.display = 'block';
    const mw = menu.offsetWidth || 220;
    const mh = menu.offsetHeight || 160;
    let left = Math.min(Math.max(pad, r.left), window.innerWidth - mw - pad);
    let top  = r.bottom + pad;
    if (top + mh > window.innerHeight - pad){
      top = Math.max(pad, r.top - mh - pad);
    }
    menu.style.left = left + 'px';
    menu.style.top  = top + 'px';
    menu.style.visibility = 'visible';
  }
  function closePrintMenu(){
    const menu = document.getElementById('printMenu');
    if (!menu) return;
    menu.style.display = 'none';
  }

  const printBtn = document.getElementById('printBtn');

  if (printBtn){
    printBtn.addEventListener('click', function(ev){
      ev.stopPropagation();
      const menu = ensurePrintMenu();
      if (menu){
        positionPrintMenu(menu);
      }
    });
  }

  // Data helpers
  
  // SG pipeline step 2: clamp rows to current SG count
</script>
<script>
(function(){
  'use strict';
  // Bridge: expose startTimeForDay to window if available
  if (typeof window.startTimeForDay !== 'function' && typeof startTimeForDay === 'function') {
    window.startTimeForDay = startTimeForDay;
  }


  function ensurePrintRoot() {
    var root = document.getElementById('printRoot');
    if (!root) {
      root = document.createElement('div');
      root.id = 'printRoot';
      root.className = 'print-root';
      document.body.appendChild(root);

      var dayWrap = document.createElement('div');
      dayWrap.id = 'dayPrintWrapper';
      dayWrap.className = 'print-wrapper';
      root.appendChild(dayWrap);

      var adminWrap = document.createElement('div');
      adminWrap.id = 'adminPrintWrapper';
      adminWrap.className = 'print-wrapper';
      root.appendChild(adminWrap);
    }
    return root;
  }

  var MONTHS = [
    "January","February","March","April","May","June",
    "July","August","September","October","November","December"
  ];

  function formatIsoDateLong(iso) {
    if (!iso) return '';
    var m = /^([0-9]{4})-([0-9]{2})-([0-9]{2})$/.exec(iso);
    if (!m) return '';
    var y = +m[1], mo = +m[2] - 1, d = +m[3];
    var dt = new Date(y, mo, d);
    if (!dt || isNaN(dt.getTime())) return '';
    return dt.getDate() + ' ' + MONTHS[dt.getMonth()] + ' ' + dt.getFullYear();
  }

  function formatTodayLong() {
    var now = new Date();
    return now.getDate() + ' ' + MONTHS[now.getMonth()] + ' ' + now.getFullYear();
  }

  function getRowsView() {
    var s = window.state || {};
    var rows = Array.isArray(s.rows) ? s.rows.slice() : [];
    var sortState = s.tableSortState || 'none';
    if (sortState === 'sg-asc' || sortState === 'sg-desc') {
      var asc = sortState === 'sg-asc';
      rows = rows.map(function(r, i){ return {r:r, i:i}; }).sort(function(a,b){
        var av = Math.max(1, Math.min(4, +a.r.speedGroup || 1));
        var bv = Math.max(1, Math.min(4, +b.r.speedGroup || 1));
        if (av === bv) return a.i - b.i;
        return asc ? (av - bv) : (bv - av);
      }).map(function(p){ return p.r; });
    }
    return rows;
  }

  function getSpeedValue(row, sched) {
    if (!row) return '';
    var sgRaw = +row.speedGroup || 1;
    var groups = Number(sched.speedGroups || 1) || 1;
    var clampedGroup = Math.max(1, Math.min(groups, sgRaw));
    var limits = Array.isArray(sched.speedLimits) && sched.speedLimits.length
      ? sched.speedLimits
      : [90, 80, 70, 60];
    if (clampedGroup >= 1 && clampedGroup <= limits.length) {
      return String(limits[clampedGroup - 1]);
    }
    return String(clampedGroup);
  }

  function pad2ForPrint(n) { return String(n).padStart(2, '0'); }
  function parseHMSForPrint(s) {
    var parts = String(s || '').split(':');
    var h = parseInt(parts[0], 10) || 0;
    var m = parseInt(parts[1], 10) || 0;
    var sec = parseInt(parts[2], 10) || 0;
    return { h: h, m: m, s: sec };
  }
  function formatHMSForPrint(h, m, s) {
    return pad2ForPrint(h) + ':' + pad2ForPrint(m) + ':' + pad2ForPrint(s);
  }
  function normalizeTimeForPrint(s) {
    if (!s) return '00:00:00';
    s = String(s);
    if (/^\d{2}:\d{2}:\d{2}$/.test(s)) return s;
    var parts = s.split(':');
    var h = Math.max(0, Math.min(23, parseInt(parts[0], 10) || 0));
    var m = Math.max(0, Math.min(59, parseInt(parts[1], 10) || 0));
    var sec = Math.max(0, Math.min(59, parseInt(parts[2], 10) || 0));
    return formatHMSForPrint(h, m, sec);
  }
  function addMinutesForPrint(h, m, s, mins) {
    var total = h * 3600 + m * 60 + s + Math.round((mins || 0) * 60);
    var d = ((total % 86400) + 86400) % 86400;
    var hh = Math.floor(d / 3600);
    var mm = Math.floor((d % 3600) / 60);
    var ss = d % 60;
    return formatHMSForPrint(hh, mm, ss);
  }
  function dayStartTimeFromSchedule(dayIdx, rallyNo, sched) {
    if (!sched) return '';
    try {
      var startTimes = Array.isArray(sched.startTimes) ? sched.startTimes : [];
      var incs = Array.isArray(sched.incrementsMin) ? sched.incrementsMin : [];
      var base = startTimes[dayIdx] || startTimes[0] || '08:30:00';
      var incMin = (Number(incs[dayIdx]) || Number(incs[0]) || 0);
      var n = Math.max(1, Number(rallyNo) || 1) - 1;
      var t = normalizeTimeForPrint(base);
      var parts = parseHMSForPrint(t);
      return addMinutesForPrint(parts.h, parts.m, parts.s, n * incMin);
    } catch (e) {
      var st0 = (sched && Array.isArray(sched.startTimes) && sched.startTimes[0]) || '08:30:00';
      return st0;
    }
  }

  function buildDayPrintTable(dayIndex) {
    ensurePrintRoot();
    var wrap = document.getElementById('dayPrintWrapper');
    if (!wrap) return;

    var s = window.state || {};
    var rows = getRowsView();
    var sched = s.schedule || {};
    var dayDates = Array.isArray(sched.dayDates) ? sched.dayDates : [];
    var titleEl = document.getElementById('rallyTitlePill');
    var revEl = document.getElementById('rallyRevPill');
    var title = (titleEl && titleEl.textContent.trim()) || 'Rally';
    var rev = (revEl && revEl.textContent.trim()) || 'r000';
    var iso = dayDates[dayIndex - 1] || '';
    var dateLabel = formatIsoDateLong(iso) || formatTodayLong();
    var headerText = title + ' / ' + dateLabel + ' / ' + rev;

    wrap.innerHTML = '';

    var page = document.createElement('div');
    page.className = 'print-page day-page';

    var header = document.createElement('div');
    header.className = 'print-header';
    header.textContent = headerText;
    page.appendChild(header);

    var table = document.createElement('table');
    table.className = 'print-table day-print';

    var colgroup = document.createElement('colgroup');
    ['driver','nav','make','year','sg','rally','start'].forEach(function(name){
      var col = document.createElement('col');
      col.className = 'col-' + name;
      colgroup.appendChild(col);
    });
    table.appendChild(colgroup);

    var thead = document.createElement('thead');
    var trHead = document.createElement('tr');
    ['Driver','Navigator','Car Make','Year','SG','Rally','Start'].forEach(function(label, idx){
      var th = document.createElement('th');
      th.textContent = label;
      if (idx >= 3) th.className = 'num';
      trHead.appendChild(th);
    });
    thead.appendChild(trHead);
    table.appendChild(thead);

    var tbody = document.createElement('tbody');

    rows.forEach(function(row, idx){
      var tr = document.createElement('tr');

      var tdDrv = document.createElement('td');
      tdDrv.textContent = [row.driver.first, row.driver.last].filter(Boolean).join(' ');
      tr.appendChild(tdDrv);

      var tdNav = document.createElement('td');
      tdNav.textContent = [row.navigator.first, row.navigator.last].filter(Boolean).join(' ');
      tr.appendChild(tdNav);

      var tdMake = document.createElement('td');
      tdMake.textContent = row.car.make || '';
      tr.appendChild(tdMake);

      var tdYear = document.createElement('td');
      tdYear.className = 'year-col';
      tdYear.textContent = row.car.year || '';
      tr.appendChild(tdYear);

      var tdSG = document.createElement('td');
      tdSG.className = 'sg-col';
      tdSG.textContent = getSpeedValue(row, sched);
      tr.appendChild(tdSG);

      var tdRally = document.createElement('td');
      tdRally.className = 'num';
      tdRally.textContent = (row.rallyNo != null && row.rallyNo !== '') ? String(row.rallyNo) : '';
      tr.appendChild(tdRally);

      var tdStart = document.createElement('td');
      tdStart.className = 'start-col';
      var rallyNo = (row.rallyNo != null && row.rallyNo !== '') ? row.rallyNo : (idx + 1);
      var startStr = dayStartTimeFromSchedule(dayIndex - 1, rallyNo, sched);
      tdStart.textContent = startStr || '';
      tr.appendChild(tdStart);

      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    page.appendChild(table);
    wrap.appendChild(page);

    // console.log('[DAY-PRINT] Built Day print table with ' + rows.length + ' rows. Header: ' + headerText);
  }

  function buildAdminPrintTable() {
    ensurePrintRoot();
    var wrap = document.getElementById('adminPrintWrapper');
    if (!wrap) return;

    var s = window.state || {};
    var rows = getRowsView();
    var sched = s.schedule || {};
    var titleEl = document.getElementById('rallyTitlePill');
    var revEl = document.getElementById('rallyRevPill');
    var title = (titleEl && titleEl.textContent.trim()) || 'Entries Grid';
    var rev = (revEl && revEl.textContent.trim()) || 'r000';
    var printedOn = formatTodayLong();
    var footerText = title + ' / ' + rev + ' / ' + printedOn;

    wrap.innerHTML = '';

    var page = document.createElement('div');
    page.className = 'print-page admin-page';

    var table = document.createElement('table');
    table.className = 'print-table admin-print';

    var colgroup = document.createElement('colgroup');
    ['idx','driver','nav','mobile','email','make','year','sg','rally'].forEach(function(name){
      var col = document.createElement('col');
      col.className = 'col-' + name;
      colgroup.appendChild(col);
    });
    table.appendChild(colgroup);

    var thead = document.createElement('thead');
    var trHead = document.createElement('tr');
    ['#','Driver','Navigator','Driver Mobile','Driver Email','Car Make','Year','SG','Rally'].forEach(function(label, idx){
      var th = document.createElement('th');
      th.textContent = label;
      if (idx === 0 || idx >= 6) th.className = 'num';
      trHead.appendChild(th);
    });
    thead.appendChild(trHead);
    table.appendChild(thead);

    var tbody = document.createElement('tbody');

    rows.forEach(function(row, idx){
      var tr = document.createElement('tr');

      var tdIdx = document.createElement('td');
      tdIdx.className = 'num';
      tdIdx.textContent = String(idx + 1);
      tr.appendChild(tdIdx);

      var tdDrv = document.createElement('td');
      tdDrv.textContent = [row.driver.first, row.driver.last].filter(Boolean).join(' ');
      tr.appendChild(tdDrv);

      var tdNav = document.createElement('td');
      tdNav.textContent = [row.navigator.first, row.navigator.last].filter(Boolean).join(' ');
      tr.appendChild(tdNav);

      var tdMob = document.createElement('td');
      tdMob.textContent = row.driver.mobile || '';
      tr.appendChild(tdMob);

      var tdEmail = document.createElement('td');
      tdEmail.textContent = row.driver.email || '';
      tr.appendChild(tdEmail);

      var tdMake = document.createElement('td');
      tdMake.textContent = row.car.make || '';
      tr.appendChild(tdMake);

      var tdYear = document.createElement('td');
      tdYear.className = 'year-col';
      tdYear.textContent = row.car.year || '';
      tr.appendChild(tdYear);

      var tdSG = document.createElement('td');
      tdSG.className = 'sg-col';
      tdSG.textContent = getSpeedValue(row, sched);
      tr.appendChild(tdSG);

      var tdRally = document.createElement('td');
      tdRally.className = 'num';
      tdRally.textContent = (row.rallyNo != null && row.rallyNo !== '') ? String(row.rallyNo) : '';
      tr.appendChild(tdRally);

      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    page.appendChild(table);

    var footer = document.createElement('div');
    footer.className = 'print-footer';
    footer.textContent = footerText;
    page.appendChild(footer);

    wrap.appendChild(page);

    // console.log('[ADMIN-PRINT] Built Admin print table with ' + rows.length + ' rows. Footer: ' + footerText);
  }

  window.buildDayPrintTable = buildDayPrintTable;
  window.buildAdminPrintTable = buildAdminPrintTable;

  // Hook print menu clicks (capture so we run before the existing bubble listener)
  document.addEventListener('click', function(ev){
    var btn = ev.target.closest && ev.target.closest('#printMenu button[data-print-mode]');
    if (!btn) return;
    var mode = btn.dataset.printMode;
    if (mode === 'admin') {
      buildAdminPrintTable();
    } else if (mode && mode.indexOf('day') === 0) {
      var n = parseInt(mode.slice(3), 10) || 1;
      buildDayPrintTable(n);
    }
  }, true);
})();
</script>

<!-- v2.7.10: Entries card capture-phase wiring (single module) -->
<script>
(()=>{
  function onReady(fn){
    if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', fn, {once:true});
    else fn();
  }
  onReady(()=>{
    const ov = document.getElementById('entriesOverlay');
    if(!ov) return;

    function open(){
      ov.classList.add('open');
      ov.style.display = 'flex';
      ov.setAttribute('aria-hidden','false');
    }
    function close(){
      ov.classList.remove('open');
      ov.style.display = 'none';
      ov.setAttribute('aria-hidden','true');
    }

    // Expose for debug (non-required)
    window.openEntries = open;
    window.closeEntries = close;

    document.addEventListener('click', (e)=>{
      const t = e.target;
      if(!t) return;
      // Capture-phase handler so other listeners can't block it later
      if(t.closest && t.closest('#entriesBtn')) {
        e.preventDefault();
        e.stopPropagation();
        open();
      } else if(t.closest && t.closest('#closeBtn')) {
        e.preventDefault();
        e.stopPropagation();
        close();
      }
    }, true);
  });
})();
</script>


<!-- v2.7.20 — Day semantics: Day1 mandatory; prune optional admin.days > dayCount on decrease (broadcast unchanged) -->
<script>
(()=>{
  function onReady(fn){
    if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', fn, {once:true});
    else fn();
  }

  onReady(()=>{
    const saveBtn = document.getElementById('saveTestBtn');
    const clearBtn = document.getElementById('clearUrlBtn');
    const codeBtn  = document.getElementById('openCodeGsBtn');
    const guideBtn = document.getElementById('openSetupGuideBtn');
    const uploadBtn = document.getElementById('cdUploadBtn');

    // Open setup documents (v2.9.00)
    const __openDoc_ = (href)=>{
      try{
        const u = String(href||'').trim();
        if (!u){
          try{ window.showToast && window.showToast('Document link not set'); }catch(_e){}
          return;
        }
        window.open(u, '_blank', 'noopener,noreferrer');
      }catch(err){
        console.error(err);
        try{ window.showToast && window.showToast('Failed to open document'); }catch(_e){}
      }
    };

    if(codeBtn && !codeBtn.__wired_v2898){
      codeBtn.__wired_v2898 = true;
      codeBtn.addEventListener('click', (e)=>{ e.preventDefault(); __openDoc_(DOC_CODE_GS); });
    }
    if(guideBtn && !guideBtn.__wired_v2900){
      guideBtn.__wired_v2900 = true;
      guideBtn.addEventListener('click', (e)=>{
        e.preventDefault();

        // Try open in Shell doc modal (preferred)
        try{
          if (window.parent && window.parent !== window){
            window.parent.postMessage({ type:'TD_DOC', title:'Google World – Setup Guide', href: DOC_HTML_SETUP_GUIDE }, '*');
            return;
          }
        }catch(_e){}

        // Fallback: open as plain document (old behaviour)
        __openDoc_(DOC_HTML_SETUP_GUIDE);
      });
    }



    // Save & test
    if(saveBtn && !saveBtn.__wired_v2713){
      saveBtn.__wired_v2713 = true;
      saveBtn.addEventListener('click', (e)=>{
        e.preventDefault();
        try{
          if (typeof window.saveAndTestCommon === 'function') return window.saveAndTestCommon();
          // If function is in scope but not on window
          if (typeof saveAndTestCommon === 'function') return saveAndTestCommon();

        }catch(err){
          console.error(err);
        }
      });
    }

    

    // Upload entry data
    if(uploadBtn && !uploadBtn.__wired_v2873){
      uploadBtn.__wired_v2873 = true;
      uploadBtn.addEventListener('click', (e)=>{
        e.preventDefault();
        e.stopImmediatePropagation();
        try{
          if (typeof window.uploadEntriesToGoogle === 'function') return window.uploadEntriesToGoogle();
          if (typeof uploadEntriesToGoogle === 'function') return uploadEntriesToGoogle();
        }catch(err){
          console.error(err);
        }
      });
    }

// Clear URL (disconnect)
    if(clearBtn && !clearBtn.__wired_v2713){
      clearBtn.__wired_v2713 = true;
      clearBtn.addEventListener('click', (e)=>{
        e.preventDefault();
        try{
          const webAppEl = document.getElementById('webAppUrl');
          if (webAppEl) webAppEl.value = '';

          // Update common storage + UI using existing helpers when present
          try{
            const common = (typeof loadCommon === 'function') ? loadCommon() : (window.loadCommon ? window.loadCommon() : {});
            if (common && typeof common === 'object'){
              common.webAppUrl = '';
              common.connected = false;
              common.lastPingAt = new Date().toISOString();
              if (typeof saveCommon === 'function') saveCommon(common);
              else if (window.saveCommon) window.saveCommon(common);
            }
          }catch(_e){}

          try{ (typeof setConnected === 'function') && setConnected(false); }catch(_e){}
          try{ (typeof setUploadBtnState_ === 'function') && setUploadBtnState_(); }catch(_e){}
          try{ (typeof pop === 'function') && pop('URL cleared.', 'warn'); }catch(_e){}
        }catch(err){
          console.error(err);
        }
      });
    }

    // Setup links
    const openUrl = (u)=>{ try{ window.open(u, '_blank', 'noopener'); }catch(_e){} };

    if(codeBtn && !codeBtn.__wired_v2713){
      codeBtn.__wired_v2713 = true;
      codeBtn.addEventListener('click', (e)=>{
        e.preventDefault();
        try{
          if (typeof LINKS === 'object' && LINKS && LINKS.CODE_GS_URL) return openUrl(LINKS.CODE_GS_URL);
        }catch(_e){}
      });
    }

    if(guideBtn && !guideBtn.__wired_v2713){
      guideBtn.__wired_v2713 = true;
      guideBtn.addEventListener('click', (e)=>{
        e.preventDefault();
        try{
          if (typeof LINKS === 'object' && LINKS && LINKS.SETUP_GUIDE_URL) return openUrl(LINKS.SETUP_GUIDE_URL);
        }catch(_e){}
      });
    }
  });
})();
</script>
</body></html>
